{% extends "base.html" %}

{% block title %}Alertas - Agenda Renta4{% endblock %}

{% block content %}
<!-- ===================================================================
     Page Header
     =================================================================== -->
<div class="page-header">
  <h1 class="page-title">Alertas — Avisos programados</h1>
  <p class="page-description">
    Gestiona las alertas automáticas y personalizadas del sistema
  </p>
</div>

<!-- ===================================================================
     Guía Rápida Card
     =================================================================== -->
<div class="card card-glass" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--warning);">
  <div style="display: flex; align-items: flex-start; gap: var(--space-lg);">
    <div style="width: 56px; height: 56px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i data-lucide="bell-ring" class="icon-2xl" style="color: white;"></i>
    </div>

    <div style="flex: 1;">
      <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md);">
        <i data-lucide="info" class="icon-sm icon-primary"></i>
        <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-base);">
          Cómo usar las alertas
        </span>
      </div>

      <ul style="margin: 0; padding-left: var(--space-lg); color: var(--muted); font-size: var(--text-sm); line-height: var(--leading-relaxed);">
        <li>Una alerta = un tipo de tarea que toca revisar para todas las URLs</li>
        <li>Pulsa "Resolver" cuando hayas completado ese tipo en el periodo actual</li>
        <li>Si necesitas cambiar la periodicidad o el día, ve a Configuración</li>
        <li>Si quieres dispararlas manualmente, usa el botón de abajo</li>
      </ul>
    </div>

    <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
      <a href="{{ url_for('config.index') }}" class="btn ghost" style="white-space: nowrap; display: inline-flex; align-items: center; gap: var(--space-xs);">
        <i data-lucide="settings" class="icon-sm"></i>
        <span>Configurar</span>
      </a>
      <a href="{{ url_for('inicio') }}" class="btn ghost" style="white-space: nowrap; display: inline-flex; align-items: center; gap: var(--space-xs);">
        <i data-lucide="clipboard-list" class="icon-sm"></i>
        <span>Ir a tareas</span>
      </a>
    </div>
  </div>
</div>

{% if pending_alerts %}
  {% set active_count = pending_alerts | selectattr('dismissed', 'equalto', 0) | list | length %}
  {% set dismissed_count = pending_alerts | selectattr('dismissed', 'equalto', 1) | list | length %}

  <!-- ===================================================================
       Stats Cards
       =================================================================== -->
  <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-xl);">
    <!-- Alertas Activas -->
    <div class="card" style="flex: 1; border-left: 4px solid var(--warning);">
      <div style="display: flex; align-items: center; gap: var(--space-md);">
        <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
          <i data-lucide="alert-circle" class="icon-lg" style="color: white;"></i>
        </div>
        <div style="flex: 1;">
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
            Alertas Activas
          </div>
          <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
            {{ active_count }}
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas Resueltas -->
    <div class="card" style="flex: 1; border-left: 4px solid var(--success);">
      <div style="display: flex; align-items: center; gap: var(--space-md);">
        <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
          <i data-lucide="check-circle-2" class="icon-lg" style="color: white;"></i>
        </div>
        <div style="flex: 1;">
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
            Resueltas
          </div>
          <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
            {{ dismissed_count }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================================================================
       Alertas List - Card-based
       =================================================================== -->
  <div class="alerts-grid">
    {% for alert in pending_alerts %}
    <div class="card alert-card {% if alert.dismissed %}alert-dismissed{% endif %}"
         data-alert-id="{{ alert.id }}"
         data-alert-source="{{ alert.source }}"
         data-dismissed="{{ alert.dismissed }}">

      <!-- Card Header -->
      <div style="display: flex; align-items: flex-start; gap: var(--space-md); margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border);">
        <div style="flex: 1;">
          <!-- Title Row -->
          <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
            {% if alert.dismissed %}
              <i data-lucide="check-circle" class="icon-sm" style="color: var(--success);"></i>
            {% else %}
              <i data-lucide="bell" class="icon-sm" style="color: var(--warning);"></i>
            {% endif %}
            <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-lg);">
              {{ alert.task_type_name }}
            </span>
            {% if alert.source == 'custom' %}
              <span class="badge badge-primary badge-sm">
                <i data-lucide="user" class="icon-xs"></i>
                <span>Personalizada</span>
              </span>
            {% endif %}
          </div>

          <!-- Description -->
          <div style="color: var(--muted); font-size: var(--text-sm);">
            {% if alert.source == 'custom' %}
              Aviso manual creado por {{ alert.created_by or 'usuario' }}
            {% else %}
              Revisar todas las URLs para esta tarea
            {% endif %}
          </div>
        </div>

        <!-- Due Date Badge -->
        <div style="text-align: right;">
          <div style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
            Fecha de aviso
          </div>
          <span class="badge {% if alert.dismissed %}badge-success{% else %}badge-warning{% endif %}" style="font-size: var(--text-base); padding: var(--space-xs) var(--space-sm);">
            {{ alert.due_date|format_date }}
          </span>
        </div>
      </div>

      <!-- Card Body - Details Grid -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-bottom: var(--space-md);">
        <!-- Periodicidad -->
        <div>
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs);">
            <i data-lucide="repeat" class="icon-xs"></i>
            <span>Periodicidad</span>
          </div>
          <div style="color: var(--text); font-size: var(--text-sm);">
            {% if alert.periodicity %}
              {{ alert.periodicity }}
            {% else %}
              <span style="color: var(--muted); font-style: italic;">-</span>
            {% endif %}
          </div>
        </div>

        <!-- Generada -->
        <div>
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs);">
            <i data-lucide="calendar" class="icon-xs"></i>
            <span>Generada</span>
          </div>
          <div style="color: var(--text); font-size: var(--text-sm);">
            {{ alert.generated_at|format_date }}
          </div>
          {% if alert.dismissed and alert.dismissed_at %}
            <div style="color: var(--success); font-size: var(--text-xs); margin-top: var(--space-xs);">
              <i data-lucide="check" class="icon-xs"></i>
              Resuelta: {{ alert.dismissed_at|format_date }}
            </div>
          {% endif %}
        </div>

        <!-- Notas -->
        <div>
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs);">
            <i data-lucide="file-text" class="icon-xs"></i>
            <span>Notas</span>
          </div>
          <div style="color: var(--text); font-size: var(--text-sm);">
            {% if alert.notes %}
              {{ alert.notes }}
            {% else %}
              <span style="color: var(--muted); font-style: italic;">Sin notas</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Card Actions -->
      <div style="display: flex; gap: var(--space-sm); padding-top: var(--space-md); border-top: 1px solid var(--border);">
        <button
          type="button"
          class="btn {% if alert.dismissed %}ghost{% else %}primary{% endif %} btn-sm"
          onclick="toggleAlert({{ alert.id }})"
          title="{% if alert.dismissed %}Reactivar alerta{% else %}Marcar como resuelta{% endif %}"
          style="display: inline-flex; align-items: center; gap: var(--space-xs);">
          {% if alert.dismissed %}
            <i data-lucide="rotate-ccw" class="icon-xs"></i>
            <span>Reactivar</span>
          {% else %}
            <i data-lucide="check" class="icon-xs"></i>
            <span>Resolver</span>
          {% endif %}
        </button>

        {% if alert.source == 'custom' %}
          <button
            type="button"
            class="btn ghost btn-sm"
            onclick="deleteCustom({{ alert.id }})"
            title="Eliminar alerta personalizada"
            style="display: inline-flex; align-items: center; gap: var(--space-xs);">
            <i data-lucide="trash-2" class="icon-xs"></i>
            <span>Eliminar</span>
          </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ===================================================================
       Info Card
       =================================================================== -->
  <div class="card card-sm" style="margin-top: var(--space-xl);">
    <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
      <i data-lucide="lightbulb" class="icon-sm icon-primary" style="flex-shrink: 0; margin-top: 2px;"></i>
      <div style="flex: 1;">
        <div style="font-weight: var(--font-semibold); color: var(--text); margin-bottom: var(--space-sm); font-size: var(--text-sm);">
          Información sobre alertas
        </div>
        <ul style="margin: 0; padding-left: var(--space-lg); color: var(--muted); font-size: var(--text-xs); line-height: var(--leading-relaxed);">
          <li>Las alertas se generan automáticamente según la configuración de periodicidad</li>
          <li>Cada alerta te recuerda revisar <strong>todas las URLs</strong> para ese tipo de tarea</li>
          <li>Las alertas <strong>personalizadas</strong> son avisos puntuales que puedes eliminar cuando ya no apliquen</li>
          <li>Haz clic en "Resolver" cuando hayas completado la revisión</li>
          <li>Las alertas resueltas se muestran con menor opacidad y pueden reactivarse</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ===================================================================
       Admin Panel
       =================================================================== -->
  <div class="card" style="margin-top: var(--space-lg); border-left: 4px solid var(--primary);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <i data-lucide="shield-check" class="icon-lg icon-primary"></i>
      <div style="flex: 1;">
        <div style="font-weight: var(--font-semibold); color: var(--text); margin-bottom: var(--space-xs);">
          Panel de administración
        </div>
        <div style="color: var(--muted); font-size: var(--text-sm);">
          Generar alertas manualmente para probar el sistema
        </div>
      </div>
      <button
        type="button"
        class="btn primary"
        onclick="generateAlerts()"
        style="display: inline-flex; align-items: center; gap: var(--space-xs);">
        <i data-lucide="refresh-cw" class="icon-sm"></i>
        <span>Generar Alertas de Hoy</span>
      </button>
    </div>
  </div>

{% else %}
  <!-- ===================================================================
       Empty State
       =================================================================== -->
  <div class="card" style="text-align: center; padding: var(--space-2xl);">
    <div style="width: 64px; height: 64px; margin: 0 auto var(--space-lg); border-radius: 50%; background: linear-gradient(135deg, var(--success-light) 0%, var(--success) 100%); display: flex; align-items: center; justify-content: center;">
      <i data-lucide="check-circle" class="icon-xl" style="color: white;"></i>
    </div>
    <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text);">
      No hay alertas pendientes
    </h3>
    <p style="margin: 0 0 var(--space-lg) 0; color: var(--muted); font-size: var(--text-sm);">
      Todas las alertas han sido resueltas. ¡Buen trabajo!
    </p>
    <a href="{{ url_for('inicio') }}" class="btn primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="home" class="icon-sm"></i>
      <span>Ir a Inicio</span>
    </a>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<style>
/* Alerts Grid - 3 columns */
.alerts-grid {
  display: grid !important;
  grid-template-columns: repeat(3, 1fr) !important;
  gap: var(--space-md);
  width: 100%;
}

/* Override any global card grid-column rules */
.alerts-grid .alert-card {
  grid-column: span 1 !important;
  transition: all 0.3s ease;
  min-width: 0;
}

.alerts-grid .alert-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.alert-card.alert-dismissed {
  opacity: 0.6;
  background: linear-gradient(to right, rgba(34, 197, 94, 0.03), transparent);
}

/* Ensure long text wraps properly in alert cards */
.alert-card a,
.alert-card span,
.alert-card div {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
  .alerts-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media (max-width: 900px) {
  .alerts-grid {
    grid-template-columns: 1fr !important;
  }
}
</style>

<script>
// Toggle alert status (active ↔ dismissed)
function toggleAlert(alertId) {
  const card = document.querySelector(`.alert-card[data-alert-id="${alertId}"]`);
  if (!card) return;

  const source = card.dataset.alertSource || 'system';
  const dismissedVal = (card.dataset.dismissed || '').toLowerCase();
  const isDismissed = dismissedVal === '1' || dismissedVal === 'true';
  const action = isDismissed ? 'reactivar' : 'resolver';

  if (!confirm(`¿${action.charAt(0).toUpperCase() + action.slice(1)} esta alerta?`)) {
    return;
  }

  const endpoint = source === 'custom'
    ? `/alertas/custom/dismiss/${alertId}`
    : `/alertas/dismiss/${alertId}`;

  fetch(endpoint, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload page to reflect changes
      location.reload();
    } else {
      alert('Error al cambiar estado de la alerta: ' + (data.error || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error de conexión al cambiar estado de la alerta');
  });
}

function deleteCustom(alertId) {
  if (!confirm('¿Eliminar esta alerta personalizada?')) return;

  fetch(`/alertas/custom/delete/${alertId}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const card = document.querySelector(`.alert-card[data-alert-id="${alertId}"]`);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'translateY(-20px)';
          setTimeout(() => card.remove(), 300);
        }
      } else {
        alert('No se pudo eliminar: ' + (data.error || 'Error desconocido'));
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error de conexión al eliminar la alerta personalizada');
    });
}

// Generate alerts manually (admin function)
function generateAlerts() {
  if (!confirm('¿Generar alertas para el día de hoy? Esto creará alertas según la configuración de periodicidad.')) {
    return;
  }

  fetch('/admin/generate-alerts', {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      let message = `Alertas generadas:\n- Generadas: ${data.stats.generated}\n- Omitidas: ${data.stats.skipped}\n- Errores: ${data.stats.errors.length}`;

      // Add email stats if available
      if (data.stats.email_stats) {
        message += `\n\nNotificaciones por email:\n- Enviados: ${data.stats.email_stats.sent}\n- Fallidos: ${data.stats.email_stats.failed}`;

        if (data.stats.email_stats.errors.length > 0) {
          message += `\n- Errores email: ${data.stats.email_stats.errors.join(', ')}`;
        }
      }

      alert(message);

      // Reload page to show new alerts
      if (data.stats.generated > 0) {
        location.reload();
      }
    } else {
      alert('Error al generar alertas: ' + (data.error || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error de conexión al generar alertas');
  });
}
</script>
{% endblock %}

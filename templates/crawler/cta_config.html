{% extends "base.html" %}

{% block title %}Configuración de CTAs - Agenda Renta4{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
    <div>
      <h1 class="page-title">Configuración de Validación de CTAs</h1>
      <p class="page-description">
        Sistema de validación automática y basada en reglas para CTAs
      </p>
    </div>
    <a href="{{ url_for('crawler.dashboard') }}" class="btn ghost" style="text-decoration: none;">
      <i data-lucide="arrow-left" class="icon-xs"></i>
      <span>Volver al Dashboard</span>
    </a>
  </div>
</div>

<!-- ===============================================================
     Info Alert
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); background: var(--bg-secondary); border-left: 4px solid var(--primary);">
  <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
    <i data-lucide="info" class="icon-md" style="color: var(--primary); flex-shrink: 0;"></i>
    <div>
      <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--text);">Cómo Funciona el Sistema de Validación</h3>
      <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">El sistema valida CTAs en dos niveles:</p>
      <ol style="margin: 0 0 var(--space-md) 0; padding-left: var(--space-2xl); line-height: 1.8; color: var(--text-secondary);">
        <li>
          <strong style="color: var(--text);">Validaciones Objetivas (Automáticas)</strong>: Detectan problemas sin necesidad de configuración
          <ul style="margin-top: var(--space-xs);">
            <li style="display: flex; align-items: center; gap: var(--space-xs);">
              <i data-lucide="link-2-off" class="icon-xs"></i>
              Enlaces rotos (404, 500, timeouts)
            </li>
            <li style="display: flex; align-items: center; gap: var(--space-xs);">
              <i data-lucide="spell-check" class="icon-xs"></i>
              Errores ortográficos en el texto
            </li>
            <li style="display: flex; align-items: center; gap: var(--space-xs);">
              <i data-lucide="tag" class="icon-xs"></i>
              Problemas HTML (href vacío o inválido)
            </li>
            <li style="display: flex; align-items: center; gap: var(--space-xs);">
              <i data-lucide="copy" class="icon-xs"></i>
              CTAs duplicados con diferentes destinos
            </li>
          </ul>
        </li>
        <li><strong style="color: var(--text);">Validaciones Basadas en Reglas (Opcionales)</strong>: Requieren configuración manual para validar CTAs específicos por tipo de página</li>
      </ol>
      <p style="margin: 0; font-weight: var(--font-semibold); color: var(--text);">
        <i data-lucide="lightbulb" class="icon-xs" style="vertical-align: middle;"></i>
        Nota: Las validaciones objetivas funcionan inmediatamente en todas las URLs. Las reglas manuales son opcionales y solo necesarias si quieres validar CTAs específicos.
      </p>
    </div>
  </div>
</div>

<!-- ===============================================================
     Summary Cards
     =============================================================== -->
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl); flex-wrap: wrap;">
  <!-- Tipos de Página -->
  <div class="card" style="flex: 1; min-width: 200px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="folder" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Tipos de Página
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ page_types|length }}
    </div>
    <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-xs);">
      Categorías configuradas
    </div>
  </div>

  <!-- Reglas de Validación -->
  <div class="card" style="flex: 1; min-width: 200px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="list-checks" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Reglas de Validación
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ rules|length }}
    </div>
    <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-xs);">
      CTAs configurados
    </div>
  </div>

  <!-- URLs Asignadas -->
  <div class="card" style="flex: 1; min-width: 200px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="link" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        URLs Asignadas
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ assignment_counts|sum(attribute='url_count') }}
    </div>
    <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-xs);">
      URLs con reglas
    </div>
  </div>
</div>

<!-- ===============================================================
     Page Types Section
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <h2 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-xl); color: var(--text); font-weight: var(--font-bold); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="folder" class="icon-md"></i>
    <span>Tipos de Página</span>
  </h2>

  {% if page_types %}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 2px solid var(--border);">
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Nombre</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Descripción</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Patrón de URL</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URLs Asignadas</th>
        </tr>
      </thead>
      <tbody>
        {% for pt in page_types %}
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: var(--space-md);"><strong style="color: var(--text);">{{ pt.name }}</strong></td>
          <td style="padding: var(--space-md); color: var(--text-secondary);">{{ pt.description or '-' }}</td>
          <td style="padding: var(--space-md);"><code style="font-size: var(--text-xs); background: var(--bg-secondary); padding: 2px 6px; border-radius: var(--radius-sm);">{{ pt.url_pattern or 'N/A' }}</code></td>
          <td style="padding: var(--space-md);">
            {% for ac in assignment_counts %}
              {% if ac.name == pt.name %}
                <span class="badge badge-primary">
                  <i data-lucide="link" class="icon-xs"></i>
                  <span>{{ ac.url_count }} URLs</span>
                </span>
              {% endif %}
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="text-align: center; padding: var(--space-2xl); color: var(--muted);">
    <i data-lucide="folder-x" class="icon-2xl" style="margin-bottom: var(--space-md); opacity: 0.5;"></i>
    <p>No hay tipos de página configurados</p>
  </div>
  {% endif %}
</div>

<!-- ===============================================================
     Validation Rules Section
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <h2 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-xl); color: var(--text); font-weight: var(--font-bold); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="list-checks" class="icon-md"></i>
    <span>Reglas de Validación</span>
  </h2>

  {% if rules %}
  <!-- Global Rules -->
  <h3 style="margin: var(--space-lg) 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="globe" class="icon-md"></i>
    <span>Reglas Globales (aplican a todas las páginas)</span>
  </h3>
  <div style="overflow-x: auto; margin-bottom: var(--space-2xl);">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 2px solid var(--border);">
          <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Texto Esperado</th>
          <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URL Esperada</th>
          <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Tipo de Match</th>
          <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Prioridad</th>
          <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Opcional</th>
        </tr>
      </thead>
      <tbody>
        {% for rule in rules if rule.is_global %}
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: var(--space-sm);"><strong style="color: var(--text);">{{ rule.expected_text }}</strong></td>
          <td style="padding: var(--space-sm);"><code style="font-size: var(--text-xs); background: var(--bg-secondary); padding: 2px 6px; border-radius: var(--radius-sm);">{{ rule.expected_url_pattern or 'N/A' }}</code></td>
          <td style="padding: var(--space-sm);">
            <span class="badge badge-muted">{{ rule.url_match_type }}</span>
          </td>
          <td style="padding: var(--space-sm);">
            {% if rule.priority == 2 %}
            <span class="badge badge-danger">
              <i data-lucide="alert-circle" class="icon-xs"></i>
              <span>Crítico</span>
            </span>
            {% elif rule.priority == 1 %}
            <span class="badge badge-warning">
              <i data-lucide="alert-triangle" class="icon-xs"></i>
              <span>Alto</span>
            </span>
            {% else %}
            <span class="badge badge-primary">
              <i data-lucide="info" class="icon-xs"></i>
              <span>Normal</span>
            </span>
            {% endif %}
          </td>
          <td style="padding: var(--space-sm);">
            {% if rule.is_optional %}
            <span class="badge badge-muted">Opcional</span>
            {% else %}
            <span class="badge badge-success">
              <i data-lucide="check" class="icon-xs"></i>
              <span>Requerido</span>
            </span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Specific Rules by Page Type -->
  <div style="border-top: 2px solid var(--border); margin: var(--space-2xl) 0; padding-top: var(--space-2xl);">
    <h3 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="file-text" class="icon-md"></i>
      <span>Reglas Específicas por Tipo de Página</span>
    </h3>

    <div style="display: flex; flex-direction: column; gap: var(--space-md);">
      {% set current_page_type = None %}
      {% for rule in rules if not rule.is_global %}
        {% if rule.page_type_name != current_page_type %}
          {% if current_page_type is not none %}
                </tbody>
              </table>
            </div>
          </details>
          {% endif %}
          {% set current_page_type = rule.page_type_name %}
          <details style="border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg);">
            <summary style="padding: var(--space-md); cursor: pointer; font-weight: var(--font-semibold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
              <i data-lucide="chevron-right" class="icon-sm" style="transition: transform 0.2s;"></i>
              {{ current_page_type }}
            </summary>
            <div style="padding: 0 var(--space-md) var(--space-md) var(--space-md);">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid var(--border);">
                    <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Texto Esperado</th>
                    <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URL Esperada</th>
                    <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Match</th>
                    <th style="padding: var(--space-sm); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Opcional</th>
                  </tr>
                </thead>
                <tbody>
        {% endif %}
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: var(--space-sm);"><strong style="color: var(--text);">{{ rule.expected_text }}</strong></td>
          <td style="padding: var(--space-sm);"><code style="font-size: var(--text-xs); background: var(--bg-secondary); padding: 2px 6px; border-radius: var(--radius-sm);">{{ rule.expected_url_pattern or 'N/A' }}</code></td>
          <td style="padding: var(--space-sm);">
            <span class="badge badge-muted">{{ rule.url_match_type }}</span>
          </td>
          <td style="padding: var(--space-sm);">
            {% if rule.is_optional %}
            <span class="badge badge-muted">Sí</span>
            {% else %}
            <span class="badge badge-success">
              <i data-lucide="check" class="icon-xs"></i>
              <span>No</span>
            </span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      {% if rules|selectattr('is_global', 'equalto', False)|list|length > 0 %}
                </tbody>
              </table>
            </div>
          </details>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div style="text-align: center; padding: var(--space-2xl); color: var(--muted);">
    <i data-lucide="file-x" class="icon-2xl" style="margin-bottom: var(--space-md); opacity: 0.5;"></i>
    <p>No hay reglas de validación configuradas</p>
  </div>
  {% endif %}
</div>

<!-- ===============================================================
     Quick Links
     =============================================================== -->
<div class="card" style="margin-top: var(--space-2xl);">
  <h2 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="link" class="icon-md"></i>
    <span>Enlaces Rápidos</span>
  </h2>
  <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
    <a href="{{ url_for('crawler.cta_results') }}" class="btn primary" style="text-decoration: none;">
      <i data-lucide="bar-chart-2" class="icon-xs"></i>
      <span>Ver Resultados de Validación</span>
    </a>
    <a href="{{ url_for('crawler.quality') }}" class="btn ghost" style="text-decoration: none;">
      <i data-lucide="activity" class="icon-xs"></i>
      <span>Dashboard de Calidad</span>
    </a>
  </div>
</div>

<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();

  // Add chevron rotation for details elements
  document.querySelectorAll('details').forEach(details => {
    details.addEventListener('toggle', function() {
      const chevron = this.querySelector('summary i[data-lucide="chevron-right"]');
      if (chevron) {
        chevron.style.transform = this.open ? 'rotate(90deg)' : 'rotate(0deg)';
        lucide.createIcons();
      }
    });
  });
});
</script>
{% endblock %}

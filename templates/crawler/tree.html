{% extends "base.html" %}

{% block title %}Tree View - Crawler{% endblock %}

{# Macro must be defined BEFORE being used #}
{% macro render_tree_node(url, level) %}
<div class="tree-node" style="margin-left: {{ level * 20 }}px;">
    <div class="tree-item" style="display: flex; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 4px; background: {% if url.is_broken %}#fee2e2{% else %}#f9fafb{% endif %};">
        <!-- Expand/Collapse Button -->
        {% if url.children %}
        <button onclick="toggleNode(this)" class="tree-toggle" style="border: none; background: none; cursor: pointer; padding: 0 8px; font-size: 16px; color: #6b7280;">
            ‚ñ∂
        </button>
        {% else %}
        <span style="width: 24px; display: inline-block;"></span>
        {% endif %}

        <!-- Status Icon -->
        <span style="font-size: 18px; margin-right: 8px;">
            {% if url.is_broken %}
                ‚ùå
            {% elif url.status_code and url.status_code >= 200 and url.status_code < 300 %}
                ‚úÖ
            {% elif url.status_code and url.status_code >= 300 and url.status_code < 400 %}
                üîÑ
            {% elif url.status_code %}
                ‚ö†Ô∏è
            {% else %}
                ‚ö™
            {% endif %}
        </span>

        <!-- URL -->
        <div style="flex: 1; min-width: 0;">
            <a href="{{ url.url }}" target="_blank" style="color: {% if url.is_broken %}#dc2626{% else %}#2563eb{% endif %}; text-decoration: none; word-break: break-all;">
                {{ url.url }}
            </a>

            <!-- Metadata -->
            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                <span style="margin-right: 10px;">Depth: {{ url.depth }}</span>
                {% if url.status_code %}
                <span style="margin-right: 10px;">Status: {{ url.status_code }}</span>
                {% endif %}
                {% if url.response_time %}
                <span style="margin-right: 10px;">{{ "%.2f"|format(url.response_time) }}s</span>
                {% endif %}
                {% if url.last_checked %}
                <span>Checked: {{ url.last_checked.strftime('%d/%m/%Y %H:%M') }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Children (hidden by default) -->
    {% if url.children %}
    <div class="tree-children" style="display: none;">
        {% for child in url.children %}
            {{ render_tree_node(child, level + 1) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}

{% block content %}
<div class="container">
    <h1>üå≥ Tree View</h1>
    <p style="color: #9ca3af; margin-bottom: 30px;">
        Vista jer√°rquica de todas las URLs descubiertas
    </p>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 10px;">TOTAL URLs</div>
            <div style="font-size: 36px; font-weight: bold; color: #111827;">{{ stats.total }}</div>
        </div>

        <div style="background: #dcfce7; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 10px;">URLs OK</div>
            <div style="font-size: 36px; font-weight: bold; color: #10b981;">{{ stats.ok }}</div>
        </div>

        <div style="background: #fee2e2; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 10px;">ROTAS</div>
            <div style="font-size: 36px; font-weight: bold; color: #ef4444;">{{ stats.broken }}</div>
        </div>

        <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 10px;">MAX DEPTH</div>
            <div style="font-size: 36px; font-weight: bold; color: #111827;">{{ stats.max_depth_value }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #111827;">Filtros</h3>

        <form method="get" action="{{ url_for('crawler.tree') }}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; align-items: end;">
            <!-- Broken Only -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 600; font-size: 14px;">
                    <input type="checkbox" name="broken_only" value="1" {% if show_broken_only %}checked{% endif %}
                           onchange="this.form.submit()">
                    Solo enlaces rotos
                </label>
            </div>

            <!-- Max Depth -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 600; font-size: 14px;">
                    Profundidad m√°xima
                </label>
                <select name="max_depth" onchange="this.form.submit()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="">Todas</option>
                    {% for i in range(stats.max_depth_value + 1) %}
                    <option value="{{ i }}" {% if max_depth_filter == i %}selected{% endif %}>Nivel {{ i }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Search -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #374151; font-weight: 600; font-size: 14px;">
                    Buscar URL
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Buscar..."
                           style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <button type="submit" class="btn" style="margin: 0;">üîç Buscar</button>
                </div>
            </div>

            <!-- Clear Filters -->
            <div style="text-align: right;">
                <a href="{{ url_for('crawler.tree') }}" class="btn" style="display: inline-block; margin: 0; background: #6b7280;">
                    Limpiar filtros
                </a>
            </div>
        </form>
    </div>

    <!-- Tree Controls -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button onclick="expandAll()" class="btn" style="margin: 0; background: #10b981;">
            ‚ûï Expandir todo
        </button>
        <button onclick="collapseAll()" class="btn" style="margin: 0; background: #6b7280;">
            ‚ûñ Contraer todo
        </button>
    </div>

    <!-- Tree View -->
    <div style="background: white; padding: 20px; border-radius: 8px;">
        {% if root_urls %}
        <div id="tree-container">
            {% for url in root_urls %}
                {{ render_tree_node(url, 0) }}
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #9ca3af;">
            <p><strong>No se encontraron URLs con los filtros seleccionados.</strong></p>
            <p><a href="{{ url_for('crawler.tree') }}">Limpiar filtros</a></p>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: 10px; margin-top: 30px;">
        <a href="{{ url_for('crawler.dashboard') }}" class="btn">‚Üê Volver al Dashboard</a>
        <a href="{{ url_for('crawler.results') }}" class="btn">üìã Ver Lista</a>
        <a href="{{ url_for('crawler.broken') }}" class="btn">üîç Solo Rotas</a>
    </div>
</div>

<script>
// Toggle node expand/collapse
function toggleNode(button) {
    const treeNode = button.closest('.tree-node');
    const children = treeNode.querySelector('.tree-children');

    if (children) {
        if (children.style.display === 'none') {
            children.style.display = 'block';
            button.textContent = '‚ñº';
        } else {
            children.style.display = 'none';
            button.textContent = '‚ñ∂';
        }
    }
}

// Expand all nodes
function expandAll() {
    const allChildren = document.querySelectorAll('.tree-children');
    const allToggles = document.querySelectorAll('.tree-toggle');

    allChildren.forEach(child => {
        child.style.display = 'block';
    });

    allToggles.forEach(toggle => {
        toggle.textContent = '‚ñº';
    });
}

// Collapse all nodes
function collapseAll() {
    const allChildren = document.querySelectorAll('.tree-children');
    const allToggles = document.querySelectorAll('.tree-toggle');

    allChildren.forEach(child => {
        child.style.display = 'none';
    });

    allToggles.forEach(toggle => {
        toggle.textContent = '‚ñ∂';
    });
}

// Auto-expand first level on load
document.addEventListener('DOMContentLoaded', function() {
    const firstLevelToggles = document.querySelectorAll('#tree-container > .tree-node > .tree-item > .tree-toggle');
    firstLevelToggles.forEach(toggle => {
        toggle.click();
    });
});
</script>

<style>
.tree-node {
    transition: all 0.2s ease;
}

.tree-item:hover {
    background: #f3f4f6 !important;
}

.tree-toggle:hover {
    color: #111827;
}

.tree-children {
    border-left: 2px solid #e5e7eb;
    margin-left: 12px;
}
</style>

{% endblock %}

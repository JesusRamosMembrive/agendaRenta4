{% extends "base.html" %}

{% block title %}Tree View - Crawler{% endblock %}

{# Macro must be defined BEFORE being used #}
{% macro render_tree_node(url, level) %}
<div class="tree-node" style="margin-left: {{ level * 20 }}px;">
  <div class="tree-item" style="display: flex; align-items: center; padding: var(--space-sm); border-radius: var(--radius-sm); margin-bottom: var(--space-xs); background: {% if url.is_broken %}var(--danger-light){% else %}var(--bg-secondary){% endif %};">
    <!-- Expand/Collapse Button -->
    {% if url.children %}
    <button onclick="toggleNode(this)" class="tree-toggle" style="border: none; background: none; cursor: pointer; padding: 0 var(--space-sm); color: var(--muted); display: flex; align-items: center;">
      <i data-lucide="chevron-right" class="icon-sm"></i>
    </button>
    {% else %}
    <span style="width: 32px; display: inline-block;"></span>
    {% endif %}

    <!-- Status Icon -->
    <span style="margin-right: var(--space-sm);">
      {% if url.is_broken %}
        <i data-lucide="x-circle" class="icon-sm" style="color: var(--danger);"></i>
      {% elif url.status_code and url.status_code >= 200 and url.status_code < 300 %}
        <i data-lucide="check-circle" class="icon-sm" style="color: var(--success);"></i>
      {% elif url.status_code and url.status_code >= 300 and url.status_code < 400 %}
        <i data-lucide="refresh-cw" class="icon-sm" style="color: var(--warning);"></i>
      {% elif url.status_code %}
        <i data-lucide="alert-triangle" class="icon-sm" style="color: var(--warning);"></i>
      {% else %}
        <i data-lucide="circle" class="icon-sm" style="color: var(--muted);"></i>
      {% endif %}
    </span>

    <!-- URL -->
    <div style="flex: 1; min-width: 0;">
      <a href="{{ url.url }}" target="_blank" style="color: {% if url.is_broken %}var(--danger){% else %}var(--primary){% endif %}; text-decoration: none; word-break: break-all; display: flex; align-items: center; gap: var(--space-xs);">
        {{ url.url }}
        <i data-lucide="external-link" class="icon-xs" style="opacity: 0.5;"></i>
      </a>

      <!-- Metadata -->
      <div style="font-size: var(--text-xs); color: var(--muted); margin-top: var(--space-xs); display: flex; gap: var(--space-md); flex-wrap: wrap;">
        <span style="display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="layers" class="icon-xs"></i>
          Depth: {{ url.depth }}
        </span>
        {% if url.status_code %}
        <span style="display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="info" class="icon-xs"></i>
          Status: {{ url.status_code }}
        </span>
        {% endif %}
        {% if url.response_time %}
        <span style="display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="timer" class="icon-xs"></i>
          {{ "%.2f"|format(url.response_time) }}s
        </span>
        {% endif %}
        {% if url.last_checked %}
        <span style="display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="clock" class="icon-xs"></i>
          {{ url.last_checked.strftime('%d/%m/%Y %H:%M') }}
        </span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Children (hidden by default) -->
  {% if url.children %}
  <div class="tree-children" style="display: none;">
    {% for child in url.children %}
      {{ render_tree_node(child, level + 1) }}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Tree View</h1>
  <p class="page-description">
    Vista jerárquica de todas las URLs descubiertas
  </p>
</div>

<!-- ===============================================================
     Statistics Cards
     =============================================================== -->
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl);">
  <!-- Total URLs -->
  <div class="card" style="flex: 1; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="globe" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Total URLs
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.total }}
    </div>
  </div>

  <!-- URLs OK -->
  <div class="card" style="flex: 1; border-left: 4px solid var(--success); text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="check-circle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        URLs OK
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--success); line-height: 1;">
      {{ stats.ok }}
    </div>
  </div>

  <!-- Rotas -->
  <div class="card" style="flex: 1; border-left: 4px solid var(--danger); text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="x-circle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Rotas
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--danger); line-height: 1;">
      {{ stats.broken }}
    </div>
  </div>

  <!-- Max Depth -->
  <div class="card" style="flex: 1; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="layers" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Max Depth
      </span>
    </div>
    <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.max_depth_value }}
    </div>
  </div>
</div>

<!-- ===============================================================
     Filters
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--primary);">
  <h3 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="filter" class="icon-md"></i>
    <span>Filtros</span>
  </h3>

  <form method="get" action="{{ url_for('crawler.tree') }}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md); align-items: end;">
    <!-- Broken Only -->
    <div>
      <label style="display: flex; align-items: center; cursor: pointer; color: var(--text); font-weight: var(--font-semibold); font-size: var(--text-sm);">
        <input type="checkbox" name="broken_only" value="1" {% if show_broken_only %}checked{% endif %}
               onchange="this.form.submit()" style="width: 16px; height: 16px; margin-right: var(--space-xs); cursor: pointer;">
        Solo enlaces rotos
      </label>
    </div>

    <!-- Max Depth -->
    <div>
      <label style="display: block; margin-bottom: var(--space-xs); color: var(--text); font-weight: var(--font-semibold); font-size: var(--text-sm);">
        Profundidad máxima
      </label>
      <select name="max_depth" onchange="this.form.submit()" style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text);">
        <option value="">Todas</option>
        {% for i in range(stats.max_depth_value + 1) %}
        <option value="{{ i }}" {% if max_depth_filter == i %}selected{% endif %}>Nivel {{ i }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Search -->
    <div>
      <label style="display: block; margin-bottom: var(--space-xs); color: var(--text); font-weight: var(--font-semibold); font-size: var(--text-sm);">
        Buscar URL
      </label>
      <div style="display: flex; gap: var(--space-sm);">
        <input type="text" name="search" value="{{ search_query }}" placeholder="Buscar..."
               style="flex: 1; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text);">
        <button type="submit" class="btn primary">
          <i data-lucide="search" class="icon-xs"></i>
          <span>Buscar</span>
        </button>
      </div>
    </div>

    <!-- Clear Filters -->
    <div style="text-align: right;">
      <a href="{{ url_for('crawler.tree') }}" class="btn ghost">
        <i data-lucide="x" class="icon-xs"></i>
        <span>Limpiar filtros</span>
      </a>
    </div>
  </form>
</div>

<!-- ===============================================================
     Tree Controls
     =============================================================== -->
<div style="margin-bottom: var(--space-lg); display: flex; gap: var(--space-md);">
  <button onclick="expandAll()" class="btn" style="background: var(--success); color: white;">
    <i data-lucide="chevrons-down" class="icon-xs"></i>
    <span>Expandir todo</span>
  </button>
  <button onclick="collapseAll()" class="btn ghost">
    <i data-lucide="chevrons-up" class="icon-xs"></i>
    <span>Contraer todo</span>
  </button>
</div>

<!-- ===============================================================
     Tree View
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl);">
  {% if root_urls %}
  <div id="tree-container">
    {% for url in root_urls %}
      {{ render_tree_node(url, 0) }}
    {% endfor %}
  </div>
  {% else %}
  <div style="text-align: center; padding: var(--space-2xl); color: var(--muted);">
    <i data-lucide="search-x" class="icon-2xl" style="margin-bottom: var(--space-md); opacity: 0.5;"></i>
    <p style="font-weight: var(--font-bold); margin-bottom: var(--space-sm);">No se encontraron URLs con los filtros seleccionados.</p>
    <a href="{{ url_for('crawler.tree') }}" class="btn primary" style="text-decoration: none;">
      <i data-lucide="refresh-cw" class="icon-xs"></i>
      <span>Limpiar filtros</span>
    </a>
  </div>
  {% endif %}
</div>

<!-- ===============================================================
     Actions
     =============================================================== -->
<div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
  <a href="{{ url_for('crawler.dashboard') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="arrow-left" class="icon-xs"></i>
    <span>Volver al Dashboard</span>
  </a>
  <a href="{{ url_for('crawler.results') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="list" class="icon-xs"></i>
    <span>Ver Lista</span>
  </a>
  <a href="{{ url_for('crawler.broken') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="link-2-off" class="icon-xs"></i>
    <span>Solo Rotas</span>
  </a>
</div>

<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();

  // Auto-expand first level on load
  const firstLevelToggles = document.querySelectorAll('#tree-container > .tree-node > .tree-item > .tree-toggle');
  firstLevelToggles.forEach(toggle => {
    toggle.click();
  });
});

// Toggle node expand/collapse
function toggleNode(button) {
  const treeNode = button.closest('.tree-node');
  const children = treeNode.querySelector('.tree-children');
  const icon = button.querySelector('i');

  if (children) {
    if (children.style.display === 'none') {
      children.style.display = 'block';
      icon.setAttribute('data-lucide', 'chevron-down');
    } else {
      children.style.display = 'none';
      icon.setAttribute('data-lucide', 'chevron-right');
    }
    lucide.createIcons();
  }
}

// Expand all nodes
function expandAll() {
  const allChildren = document.querySelectorAll('.tree-children');
  const allToggles = document.querySelectorAll('.tree-toggle');

  allChildren.forEach(child => {
    child.style.display = 'block';
  });

  allToggles.forEach(toggle => {
    const icon = toggle.querySelector('i');
    if (icon) {
      icon.setAttribute('data-lucide', 'chevron-down');
    }
  });

  lucide.createIcons();
}

// Collapse all nodes
function collapseAll() {
  const allChildren = document.querySelectorAll('.tree-children');
  const allToggles = document.querySelectorAll('.tree-toggle');

  allChildren.forEach(child => {
    child.style.display = 'none';
  });

  allToggles.forEach(toggle => {
    const icon = toggle.querySelector('i');
    if (icon) {
      icon.setAttribute('data-lucide', 'chevron-right');
    }
  });

  lucide.createIcons();
}
</script>

<style>
.tree-node {
  transition: all 0.2s ease;
}

.tree-item:hover {
  background: var(--bg-secondary) !important;
  border: 1px solid var(--border);
}

.tree-toggle:hover {
  color: var(--text);
}

.tree-children {
  border-left: 2px solid var(--border);
  margin-left: var(--space-md);
}
</style>

{% endblock %}

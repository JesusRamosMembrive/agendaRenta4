{% extends "base.html" %}

{% block title %}Calidad de Imágenes{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Calidad de Imágenes</h1>
  <p class="page-description">
    Verificación automática de la carga de imágenes en cada página
  </p>
</div>

<!-- ===============================================================
     Statistics Cards - Horizontal Layout
     =============================================================== -->
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl); flex-wrap: wrap;">
  <!-- Total Checks -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="list-checks" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Total Checks
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--primary); line-height: 1;">
      {{ stats.total_checks or 0 }}
    </div>
  </div>

  <!-- Average Score -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="gauge" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Puntuación Media
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); line-height: 1;
      {% if (stats.avg_score or 0) >= 80 %}color: var(--success);
      {% elif (stats.avg_score or 0) >= 50 %}color: var(--warning);
      {% else %}color: var(--danger);{% endif %}">
      {{ "%.0f"|format(stats.avg_score or 0) }}
    </div>
  </div>

  <!-- OK Count -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md); background: var(--success-light); border-left: 4px solid var(--success);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="check-circle" class="icon-xs" style="color: var(--success);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--success); text-transform: uppercase; letter-spacing: 0.5px;">
        OK
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--success); line-height: 1;">
      {{ stats.ok_count or 0 }}
    </div>
  </div>

  <!-- Warning Count -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md); background: var(--warning-light); border-left: 4px solid var(--warning);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="alert-triangle" class="icon-xs" style="color: var(--warning);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--warning); text-transform: uppercase; letter-spacing: 0.5px;">
        Warnings
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--warning); line-height: 1;">
      {{ stats.warning_count or 0 }}
    </div>
  </div>

  <!-- Error Count -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md); background: var(--danger-light); border-left: 4px solid var(--danger);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="x-circle" class="icon-xs" style="color: var(--danger);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--danger); text-transform: uppercase; letter-spacing: 0.5px;">
        Errors
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--danger); line-height: 1;">
      {{ stats.error_count or 0 }}
    </div>
  </div>

  <!-- Total Issues -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="alert-circle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Issues Found
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.total_issues or 0 }}
    </div>
  </div>
</div>

<!-- ===============================================================
     Info Card + Run Tests Button
     =============================================================== -->
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl); align-items: stretch;">
  <!-- Info Card -->
  <div class="card card-glass" style="flex: 1; border-left: 4px solid var(--primary);">
    <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
      <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="image" class="icon-lg" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--text);">
          Verificación de Imágenes
        </h3>
        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
          Este check verifica que todas las imágenes de cada página se carguen correctamente.<br>
          <strong style="color: var(--success);">OK (100)</strong> = Todas las imágenes funcionan correctamente<br>
          <strong style="color: var(--danger);">Error (0)</strong> = Hay imágenes rotas o que no cargan
        </div>
      </div>
    </div>
  </div>

  <!-- Run Tests Button -->
  <div style="display: flex; align-items: center;">
    <button onclick="openRunTestsModal()" class="btn primary" style="padding: var(--space-md) var(--space-xl); font-size: var(--text-lg); font-weight: var(--font-bold); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
      <i data-lucide="zap" class="icon-sm"></i>
      <span>Ejecutar Tests Ahora</span>
    </button>
  </div>
</div>

<!-- ===============================================================
     Filters
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); padding: var(--space-md);">
  <form method="get" style="display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
    <label style="display: flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="filter" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Estado:</span>
      <select name="status" onchange="this.form.submit()" style="padding: var(--space-sm) var(--space-md); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: var(--text-sm);">
        <option value="">Todos</option>
        <option value="ok" {% if status_filter == 'ok' %}selected{% endif %}>OK</option>
        <option value="warning" {% if status_filter == 'warning' %}selected{% endif %}>Warning</option>
        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
      </select>
    </label>
    {% if status_filter %}
    <a href="{{ url_for('crawler.quality') }}" class="btn ghost" style="text-decoration: none;">
      <i data-lucide="x" class="icon-xs"></i>
      <span>Limpiar Filtros</span>
    </a>
    {% endif %}
  </form>
</div>

<!-- ===============================================================
     Quality Checks Table
     =============================================================== -->
{% if quality_checks %}
  <div class="card" style="overflow-x: auto; padding: 0;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border);">
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URL</th>
          <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Estado</th>
          <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Puntuación</th>
          <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Problemas</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Detalles</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Fecha Check</th>
        </tr>
      </thead>
      <tbody>
        {% for check in quality_checks %}
        <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;"
            onmouseover="this.style.background='var(--bg-secondary)'"
            onmouseout="this.style.background='transparent'">
          <td style="padding: var(--space-md);">
            <a href="{{ check.url }}" target="_blank" style="color: var(--primary); word-break: break-all; text-decoration: none; transition: opacity 0.2s;"
               onmouseover="this.style.opacity='0.7'"
               onmouseout="this.style.opacity='1'">
              {{ check.url_name or check.url[:50] }}
            </a>
          </td>
          <td style="padding: var(--space-md); text-align: center;">
            {% if check.status == 'ok' %}
              <div class="badge badge-success">
                <i data-lucide="check" class="icon-xs"></i>
                <span>OK</span>
              </div>
            {% elif check.status == 'warning' %}
              <div class="badge" style="background: var(--warning-light); color: var(--warning);">
                <i data-lucide="alert-triangle" class="icon-xs"></i>
                <span>Warning</span>
              </div>
            {% else %}
              <div class="badge badge-danger">
                <i data-lucide="x" class="icon-xs"></i>
                <span>Error</span>
              </div>
            {% endif %}
          </td>
          <td style="padding: var(--space-md); text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs);">
              <div style="font-size: var(--text-xl); font-weight: var(--font-bold);
                {% if check.score >= 80 %}color: var(--success);
                {% elif check.score >= 50 %}color: var(--warning);
                {% else %}color: var(--danger);{% endif %}">
                {{ check.score }}
              </div>
              <div style="color: var(--muted); font-size: var(--text-sm);">/100</div>
            </div>
          </td>
          <td style="padding: var(--space-md); text-align: center;">
            <span style="font-size: var(--text-lg); font-weight: var(--font-bold);
              {% if check.issues_found == 0 %}color: var(--success);
              {% elif check.issues_found <= 3 %}color: var(--warning);
              {% else %}color: var(--danger);{% endif %}">
              {{ check.issues_found }}
            </span>
          </td>
          <td style="padding: var(--space-md);">
            <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
              {% if check.details %}
                {% set details = check.details if check.details is mapping else check.details|fromjson %}
                <div style="margin-bottom: var(--space-xs);">
                  <i data-lucide="image" class="icon-xs" style="color: var(--muted); vertical-align: middle;"></i>
                  <strong>Total imágenes:</strong> {{ details.total_images }}
                </div>
                {% if details.broken_images > 0 %}
                <div style="color: var(--danger); margin-bottom: var(--space-sm);">
                  <i data-lucide="x-circle" class="icon-xs" style="vertical-align: middle;"></i>
                  Rotas: {{ details.broken_images }}
                </div>
                {% endif %}

                {% if check.issues_found > 0 and details.broken_images_list %}
                <div style="margin-top: var(--space-md);">
                  <button onclick="toggleDetails('details-{{ loop.index }}')" class="btn ghost btn-sm">
                    <i data-lucide="eye" class="icon-xs"></i>
                    <span>Ver imágenes rotas</span>
                  </button>
                </div>

                <div id="details-{{ loop.index }}" style="display: none; margin-top: var(--space-md); padding: var(--space-md); background: var(--danger-light); border-radius: var(--radius-sm); border-left: 3px solid var(--danger);">
                  <strong style="color: var(--danger); display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
                    <i data-lucide="x-circle" class="icon-sm"></i>
                    Imágenes rotas ({{ details.broken_images }}):
                  </strong>
                  <ul style="margin: 0; padding-left: var(--space-lg); font-size: var(--text-xs); list-style: none;">
                  {% for img in details.broken_images_list %}
                    <li style="margin-bottom: var(--space-xs); word-break: break-all; display: flex; align-items: start; gap: var(--space-xs);">
                      <i data-lucide="link-2-off" class="icon-xs" style="color: var(--danger); flex-shrink: 0; margin-top: 2px;"></i>
                      <div>
                        <a href="{{ img.url }}" target="_blank" style="color: var(--primary); text-decoration: none;">{{ img.url }}</a>
                        <span style="color: var(--danger); font-weight: var(--font-semibold);"> ({{ img.status }})</span>
                      </div>
                    </li>
                  {% endfor %}
                  </ul>
                </div>
                {% endif %}
              {% endif %}
            </div>
          </td>
          <td style="padding: var(--space-md); font-size: var(--text-sm); color: var(--text-secondary);">
            {{ check.checked_at.strftime('%d/%m/%Y %H:%M') if check.checked_at else '-' }}
            <div style="font-size: var(--text-xs); color: var(--muted); margin-top: var(--space-xs);">
              ({{ check.execution_time_ms }}ms)
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ===============================================================
       Pagination
       =============================================================== -->
  {% if total_pages > 1 %}
  <div style="margin-top: var(--space-xl); display: flex; justify-content: center; align-items: center; gap: var(--space-md);">
    {% if page > 1 %}
      <a href="{{ url_for('crawler.quality', page=page-1, status=status_filter) }}" class="btn ghost" style="text-decoration: none;">
        <i data-lucide="chevron-left" class="icon-xs"></i>
        <span>Anterior</span>
      </a>
    {% else %}
      <button class="btn ghost" disabled style="opacity: 0.5; cursor: not-allowed;">
        <i data-lucide="chevron-left" class="icon-xs"></i>
        <span>Anterior</span>
      </button>
    {% endif %}

    <span style="padding: var(--space-sm) var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm); color: var(--text); font-weight: var(--font-semibold); font-size: var(--text-sm);">
      Página {{ page }} de {{ total_pages }}
    </span>

    {% if page < total_pages %}
      <a href="{{ url_for('crawler.quality', page=page+1, status=status_filter) }}" class="btn ghost" style="text-decoration: none;">
        <span>Siguiente</span>
        <i data-lucide="chevron-right" class="icon-xs"></i>
      </a>
    {% else %}
      <button class="btn ghost" disabled style="opacity: 0.5; cursor: not-allowed;">
        <span>Siguiente</span>
        <i data-lucide="chevron-right" class="icon-xs"></i>
      </button>
    {% endif %}
  </div>
  {% endif %}

{% else %}
  <!-- ===============================================================
       Empty State
       =============================================================== -->
  <div class="card" style="text-align: center; padding: var(--space-2xl);">
    <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;">
      <i data-lucide="image" class="icon-2xl" style="color: var(--muted);"></i>
    </div>
    <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text);">
      No hay checks de calidad de imágenes todavía
    </h3>
    <p style="margin: 0 0 var(--space-lg) 0; color: var(--text-secondary); font-size: var(--text-base);">
      Ejecuta checks de calidad desde el botón de arriba
    </p>
    <button onclick="openRunTestsModal()" class="btn primary" style="text-decoration: none;">
      <i data-lucide="play-circle" class="icon-xs"></i>
      <span>Ejecutar Tests</span>
    </button>
  </div>
{% endif %}

<!-- ===============================================================
     Modal for Running Tests
     =============================================================== -->
<div id="runTestsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div class="card" style="max-width: 500px; width: 90%; margin: var(--space-xl);">
    <h2 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="image" class="icon-lg"></i>
      <span>Calidad de Imágenes</span>
    </h2>

    <p style="color: var(--text-secondary); margin-bottom: var(--space-xl); font-size: var(--text-sm); line-height: 1.6;">
      Selecciona el alcance del análisis. El checker verificará que todas las imágenes de cada página se carguen correctamente, detectando imágenes rotas o que no responden.
    </p>

    <!-- Scope Selection -->
    <div style="margin-bottom: var(--space-xl);">
      <label style="display: block; font-weight: var(--font-semibold); margin-bottom: var(--space-md); color: var(--text);">
        Alcance del análisis:
      </label>

      <label style="display: block; padding: var(--space-md); border: 2px solid var(--border); border-radius: var(--radius-sm); margin-bottom: var(--space-md); cursor: pointer; transition: all 0.2s;"
             onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'"
             onmouseout="this.style.borderColor='var(--border)'; this.style.background='transparent'">
        <input type="radio" name="scope" value="priority" checked style="margin-right: var(--space-sm);">
        <strong style="color: var(--text); display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="star" class="icon-xs" style="color: var(--warning);"></i>
          URLs Prioritarias
        </strong>
        <span style="display: block; margin-left: var(--space-lg); font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-xs);">
          {{ url_info.priority_count }} URLs • Tiempo estimado: {{ url_info.image_quality_priority_time }}
        </span>
      </label>

      <label style="display: block; padding: var(--space-md); border: 2px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s;"
             onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'"
             onmouseout="this.style.borderColor='var(--border)'; this.style.background='transparent'">
        <input type="radio" name="scope" value="all" style="margin-right: var(--space-sm);">
        <strong style="color: var(--text); display: flex; align-items: center; gap: var(--space-xs);">
          <i data-lucide="globe" class="icon-xs"></i>
          Todas las URLs
        </strong>
        <span style="display: block; margin-left: var(--space-lg); font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-xs);">
          {{ url_info.total_count }} URLs • Tiempo estimado: {{ url_info.image_quality_all_time }}
        </span>
      </label>
    </div>

    <!-- Progress (hidden initially) -->
    <div id="progressContainer" style="display: none; margin: var(--space-lg) 0;">
      <div style="background: var(--bg-secondary); border-radius: var(--radius-sm); height: 8px; overflow: hidden; position: relative;">
        <div id="progressBar" style="background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
      </div>
      <p id="progressText" style="text-align: center; margin-top: var(--space-md); color: var(--text-secondary); font-size: var(--text-sm);">
        Preparando análisis...
      </p>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: var(--space-md); justify-content: flex-end; margin-top: var(--space-xl);">
      <button onclick="closeRunTestsModal()" id="cancelButton" class="btn ghost">
        Cancelar
      </button>
      <button onclick="runQualityTests()" id="runButton" class="btn primary">
        <i data-lucide="rocket" class="icon-xs"></i>
        <span>Ejecutar Análisis</span>
      </button>
    </div>
  </div>
</div>

<script>
function toggleDetails(detailsId) {
  const detailsDiv = document.getElementById(detailsId);
  const button = event.target.closest('button');

  if (detailsDiv.style.display === 'none') {
    detailsDiv.style.display = 'block';
    button.innerHTML = '<i data-lucide="eye-off" class="icon-xs"></i><span>Ocultar imágenes rotas</span>';
  } else {
    detailsDiv.style.display = 'none';
    button.innerHTML = '<i data-lucide="eye" class="icon-xs"></i><span>Ver imágenes rotas</span>';
  }
  lucide.createIcons();
}

function openRunTestsModal() {
  document.getElementById('runTestsModal').style.display = 'flex';
  lucide.createIcons();
}

function closeRunTestsModal() {
  document.getElementById('runTestsModal').style.display = 'none';
  // Reset progress
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('runButton').disabled = false;
  document.getElementById('runButton').innerHTML = '<i data-lucide="rocket" class="icon-xs"></i><span>Ejecutar Análisis</span>';
  lucide.createIcons();
}

async function runQualityTests() {
  const checkTypes = ['image_quality'];
  const scope = document.querySelector('input[name="scope"]:checked').value;

  // Disable button and show progress
  const runButton = document.getElementById('runButton');
  runButton.disabled = true;
  runButton.innerHTML = '<i data-lucide="loader" class="icon-xs"></i><span>Ejecutando...</span>';
  lucide.createIcons();

  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  progressContainer.style.display = 'block';
  progressText.textContent = 'Iniciando tests...';
  progressBar.style.width = '10%';

  let estimatedTime = '';
  if (scope === 'priority') {
    estimatedTime = ' (analizando {{ url_info.priority_count }} URLs, {{ url_info.image_quality_priority_time }}, por favor espere...)';
  } else {
    estimatedTime = ' (analizando {{ url_info.total_count }} URLs, {{ url_info.image_quality_all_time }}, por favor espere...)';
  }

  try {
    progressBar.style.width = '20%';
    progressText.textContent = 'Analizando calidad de imágenes' + estimatedTime;

    const response = await fetch('/crawler/quality/run', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        check_types: checkTypes,
        scope: scope
      })
    });

    progressBar.style.width = '90%';
    progressText.textContent = 'Procesando resultados...';

    const data = await response.json();

    progressBar.style.width = '100%';

    if (data.success) {
      progressText.textContent = '✅ Test completado exitosamente';

      const checks = data.results.checks || [];
      const imageCheck = checks.find(c => c.check_type === 'image_quality') || checks[0];

      let message = 'Test de Calidad de Imágenes completado!\n\n';

      if (imageCheck) {
        message += `Estado: ${imageCheck.status || 'unknown'}\n`;

        const stats = imageCheck.stats || {};
        message += `URLs procesadas: ${stats.processed || 0}\n`;
        message += `Guardadas en BD: ${stats.successful || 0}\n`;

        if (imageCheck.message) {
          message += `\nDetalles: ${imageCheck.message}`;
        }
      }

      alert(message);

      closeRunTestsModal();
      window.location.reload();

    } else {
      progressText.textContent = '❌ Error al ejecutar test';
      progressBar.style.background = 'var(--danger)';
      alert('Error: ' + data.error);
      runButton.disabled = false;
      runButton.innerHTML = '<i data-lucide="rocket" class="icon-xs"></i><span>Ejecutar Análisis</span>';
      lucide.createIcons();
    }

  } catch (error) {
    console.error('Error running tests:', error);
    progressBar.style.background = 'var(--danger)';
    progressText.textContent = '❌ Error de conexión';
    alert('Error al ejecutar tests: ' + error.message);
    runButton.disabled = false;
    runButton.innerHTML = '<i data-lucide="rocket" class="icon-xs"></i><span>Ejecutar Análisis</span>';
    lucide.createIcons();
  }
}

// Initialize Lucide icons on page load
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
});
</script>
{% endblock %}

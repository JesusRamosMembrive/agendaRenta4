{% extends "base.html" %}
{% from 'components/stat_card.html' import stat_card %}

{% block title %}Enlaces Rotos - Crawler{% endblock %}

{% block content %}
<div class="container">
    <h1>‚ùå Enlaces Rotos</h1>
    <p class="subtitle">URLs con errores detectadas por el crawler</p>

    {% if not crawl_run %}
    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; margin: 20px 0; border-radius: 8px; color: #78350f;">
        <strong style="font-size: 16px;">‚ö†Ô∏è No hay crawls disponibles</strong>
        <p style="margin: 10px 0 15px 0; font-size: 14px;">Ejecuta el crawler primero para descubrir URLs.</p>
        <a href="{{ url_for('crawler.dashboard') }}" class="btn" style="display: inline-block; margin-top: 5px; background: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none;">Ir al Dashboard</a>
    </div>
    {% else %}

    <!-- Stats Cards -->
    <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
        {{ stat_card(value=stats.total_validated, label='URLs Validadas', gradient='green') }}
        {{ stat_card(value=stats.priority_validated, label='‚≠ê URLs Prioritarias', gradient='orange') }}
        {{ stat_card(value=stats.total_broken, label='‚ùå Enlaces Rotos', gradient='red') }}
    </div>

    <!-- Action Button -->
    <div style="margin: 30px 0; text-align: center;">
        <button onclick="openValidateModal()" class="btn" style="background: #10b981; color: white; padding: 16px 24px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">
            ‚ö° Validar URLs Ahora
        </button>
    </div>

    {% if broken_urls %}
    <!-- Filter Buttons -->
    <div style="margin: 20px 0;">
        <button onclick="filterTable('all')" class="btn btn-primary" id="filter-all">Todas ({{ broken_urls|length }})</button>
        <button onclick="filterTable('priority')" class="btn" id="filter-priority">‚≠ê Prioritarias ({{ stats.priority_broken }})</button>
        <button onclick="filterTable('non-priority')" class="btn" id="filter-non-priority">üìÑ Nuevas ({{ stats.non_priority_broken }})</button>
    </div>
    <!-- Broken URLs Table -->
    <div class="table-container" style="margin: 20px 0;">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th style="width: 50px;">‚≠ê</th>
                    <th style="width: 500px;">URL</th>
                    <th style="width: 100px;">C√≥digo</th>
                    <th style="width: 120px;">Tiempo (s)</th>
                    <th>Error</th>
                    <th style="width: 180px;">√öltima Revisi√≥n</th>
                </tr>
            </thead>
            <tbody id="broken-urls-table">
                {% for url in broken_urls %}
                <tr class="url-row" data-priority="{{ url.is_priority|lower }}">
                    <td>{{ loop.index }}</td>
                    <td style="text-align: center;">
                        {% if url.is_priority %}
                            <span style="font-size: 1.2em;">‚≠ê</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url.url }}" target="_blank" style="color: #3b82f6; text-decoration: none; word-break: break-all;">
                            {{ url.url }}
                        </a>
                    </td>
                    <td>
                        <span class="status-badge status-{{ url.status_code if url.status_code else 'error' }}">
                            {{ url.status_code if url.status_code else 'N/A' }}
                        </span>
                    </td>
                    <td style="text-align: right;">
                        {% if url.response_time %}
                            {{ "%.2f"|format(url.response_time) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <span style="color: #dc2626; font-size: 13px;">
                            {{ url.error_message if url.error_message else 'Error desconocido' }}
                        </span>
                    </td>
                    <td style="font-size: 13px;">
                        {% if url.last_checked %}
                            {{ url.last_checked.strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                            No validada
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 20px; margin: 20px 0; border-radius: 8px; color: #000000;">
        <strong style="color: #000000;">‚úÖ ¬°Excelente!</strong>
        <p style="margin: 10px 0 0 0; color: #000000;">No se encontraron enlaces rotos en el √∫ltimo crawl. Todas las {{ stats.total_validated }} URLs validadas funcionan correctamente.</p>
    </div>
    {% endif %}

    <!-- Crawl Info -->
    <div style="margin-top: 40px; padding: 20px; background: #f3f4f6; border-radius: 8px; color: #000000;">
        <h3 style="margin: 0 0 10px 0; color: #000000;">Informaci√≥n del Crawl</h3>
        <p style="margin: 5px 0; color: #000000;"><strong>Iniciado:</strong> {{ crawl_run.started_at.strftime('%d/%m/%Y %H:%M:%S') }}</p>
        {% if crawl_run.finished_at %}
        <p style="margin: 5px 0; color: #000000;"><strong>Finalizado:</strong> {{ crawl_run.finished_at.strftime('%d/%m/%Y %H:%M:%S') }}</p>
        {% endif %}
        <p style="margin: 5px 0; color: #000000;"><strong>URLs Descubiertas:</strong> {{ crawl_run.urls_discovered }}</p>
        <p style="margin: 5px 0; color: #000000;"><strong>URLs Validadas:</strong> {{ stats.total_validated }}</p>
    </div>

    <!-- Actions -->
    <div style="margin: 30px 0;">
        <a href="{{ url_for('crawler.dashboard') }}" class="btn">‚¨ÖÔ∏è Volver al Dashboard</a>
        <a href="{{ url_for('crawler.results') }}" class="btn">üìã Ver Todas las URLs</a>
    </div>

    {% endif %}

    <!-- Modal for Running Validation -->
    <div id="validateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üîç Validar URLs</h2>

            <p style="color: #374151; margin-bottom: 25px; font-size: 14px;">
                Selecciona qu√© URLs validar. La validaci√≥n verificar√° enlaces rotos, timeouts y c√≥digos de estado HTTP.
            </p>

            <!-- Scope Selection -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">Alcance de la validaci√≥n:</label>

                <label style="display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px; cursor: pointer;">
                    <input type="radio" name="validateScope" value="priority" checked style="margin-right: 8px;">
                    <strong style="color: #1f2937;">‚≠ê URLs Prioritarias</strong>
                    <span style="display: block; margin-left: 24px; font-size: 13px; color: #374151;">
                        {{ url_info.priority_count }} URLs ‚Ä¢ Tiempo estimado: {{ url_info.broken_links_priority_time }}
                    </span>
                </label>

                <label style="display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="validateScope" value="all" style="margin-right: 8px;">
                    <strong style="color: #1f2937;">üåê Todas las URLs</strong>
                    <span style="display: block; margin-left: 24px; font-size: 13px; color: #374151;">
                        {{ url_info.total_count }} URLs ‚Ä¢ Tiempo estimado: {{ url_info.broken_links_all_time }}
                    </span>
                </label>
            </div>

            <!-- Progress (hidden initially) -->
            <div id="validateProgress" style="display: none; margin: 20px 0;">
                <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="validateProgressBar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="validateProgressText" style="text-align: center; margin-top: 10px; color: #374151; font-size: 14px;">
                    Preparando validaci√≥n...
                </p>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button onclick="closeValidateModal()" id="validateCancelBtn" class="btn" style="background: #e5e7eb; color: #374151; padding: 10px 20px; border: none; cursor: pointer; border-radius: 6px;">
                    Cancelar
                </button>
                <button onclick="runValidation()" id="validateRunBtn" class="btn" style="background: #10b981; color: white; padding: 10px 20px; font-weight: 600; border: none; cursor: pointer; border-radius: 6px;">
                    üöÄ Validar
                </button>
            </div>
        </div>
    </div>

</div>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
    display: inline-block;
}

.status-404 {
    background: #fee2e2;
    color: #dc2626;
}

.status-500, .status-503 {
    background: #fef3c7;
    color: #f59e0b;
}

.status-error, .status-N/A {
    background: #e5e7eb;
    color: #6b7280;
}

.btn.active {
    background: #3b82f6;
    color: white;
}

.url-row.hidden {
    display: none;
}
</style>

<script>
let currentFilter = 'all';

function filterTable(filter) {
    currentFilter = filter;
    const rows = document.querySelectorAll('.url-row');
    const buttons = {
        'all': document.getElementById('filter-all'),
        'priority': document.getElementById('filter-priority'),
        'non-priority': document.getElementById('filter-non-priority')
    };

    // Update button states
    Object.values(buttons).forEach(btn => btn.classList.remove('active'));
    buttons[filter].classList.add('active');

    // Filter rows
    rows.forEach(row => {
        const isPriority = row.dataset.priority === 'true';

        if (filter === 'all') {
            row.classList.remove('hidden');
        } else if (filter === 'priority' && isPriority) {
            row.classList.remove('hidden');
        } else if (filter === 'non-priority' && !isPriority) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });

    // Update row numbers
    let visibleIndex = 1;
    rows.forEach(row => {
        if (!row.classList.contains('hidden')) {
            row.querySelector('td:first-child').textContent = visibleIndex++;
        }
    });
}

// Initialize with 'all' filter active
document.addEventListener('DOMContentLoaded', () => {
    filterTable('all');
});

// ========== Validation Functions ==========

function openValidateModal() {
    const modal = document.getElementById('validateModal');
    modal.style.display = 'flex';
}

function closeValidateModal() {
    const modal = document.getElementById('validateModal');
    modal.style.display = 'none';

    // Reset progress
    document.getElementById('validateProgress').style.display = 'none';
    document.getElementById('validateProgressBar').style.width = '0%';
    document.getElementById('validateProgressText').textContent = 'Preparando validaci√≥n...';

    // Re-enable buttons
    document.getElementById('validateRunBtn').disabled = false;
    document.getElementById('validateRunBtn').textContent = 'üöÄ Validar';
    document.getElementById('validateCancelBtn').disabled = false;
}

async function runValidation() {
    // Get selected scope
    const scopeRadios = document.getElementsByName('validateScope');
    let scope = 'priority';
    for (const radio of scopeRadios) {
        if (radio.checked) {
            scope = radio.value;
            break;
        }
    }

    // Disable buttons
    const runButton = document.getElementById('validateRunBtn');
    const cancelButton = document.getElementById('validateCancelBtn');
    runButton.disabled = true;
    runButton.textContent = '‚è≥ Validando...';
    cancelButton.disabled = true;

    // Show progress
    const progressDiv = document.getElementById('validateProgress');
    const progressBar = document.getElementById('validateProgressBar');
    const progressText = document.getElementById('validateProgressText');
    progressDiv.style.display = 'block';

    // Show estimated time (use values from template)
    let estimatedTime = '';
    if (scope === 'priority') {
        estimatedTime = 'Validando {{ url_info.priority_count }} URLs ({{ url_info.broken_links_priority_time }})';
    } else {
        estimatedTime = 'Validando {{ url_info.total_count }} URLs ({{ url_info.broken_links_all_time }})';
    }
    progressText.textContent = estimatedTime + '...';

    // Simulate progress (indeterminate)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress = (progress + 5) % 100;
        progressBar.style.width = progress + '%';
    }, 200);

    try {
        // Call API endpoint
        const response = await fetch('/crawler/quality/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                check_types: ['broken_links'],
                scope: scope
            })
        });

        const data = await response.json();

        // Stop progress animation
        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (data.success) {
            // Get the broken_links check result from the checks array
            const checks = data.results.checks || [];
            const brokenLinksCheck = checks.find(c => c.check_type === 'broken_links') || checks[0];

            progressText.textContent = '‚úÖ Validaci√≥n completada';

            // Show results
            let message = `Validaci√≥n completada!\n\n`;

            if (brokenLinksCheck) {
                message += `Estado: ${brokenLinksCheck.status || 'unknown'}\n`;

                // Access stats object correctly
                const stats = brokenLinksCheck.stats || {};
                message += `URLs validadas: ${stats.validated || 0}\n`;
                message += `Enlaces rotos encontrados: ${stats.broken || 0}\n`;

                if (brokenLinksCheck.message) {
                    message += `\nDetalles: ${brokenLinksCheck.message}\n`;
                }
            } else {
                message += 'No se encontraron resultados de validaci√≥n.\n';
            }

            alert(message);

            // Close modal and reload
            closeValidateModal();
            window.location.reload();

        } else {
            clearInterval(progressInterval);
            progressText.textContent = '‚ùå Error al ejecutar validaci√≥n';
            alert('Error: ' + (data.error || 'Error desconocido'));
            runButton.disabled = false;
            runButton.textContent = 'üöÄ Validar';
            cancelButton.disabled = false;
        }

    } catch (error) {
        clearInterval(progressInterval);
        console.error('Error:', error);
        progressText.textContent = '‚ùå Error de conexi√≥n';
        alert('Error al ejecutar validaci√≥n: ' + error.message);
        runButton.disabled = false;
        runButton.textContent = 'üöÄ Validar';
        cancelButton.disabled = false;
    }
}
</script>

<!-- Load modal utilities -->
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>

{% endblock %}

{% extends "base.html" %}
{% from 'components/stat_card.html' import stat_card %}

{% block title %}Correcci√≥n Ortogr√°fica - Crawler{% endblock %}

{% block content %}
<div class="container">
    <h1>üìù Correcci√≥n Ortogr√°fica</h1>
    <p class="subtitle">Errores ortogr√°ficos detectados en el contenido de las p√°ginas</p>

    {% if not crawl_run %}
    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; margin: 20px 0; border-radius: 8px; color: #78350f;">
        <strong style="font-size: 16px;">‚ö†Ô∏è No hay resultados disponibles</strong>
        <p style="margin: 10px 0 15px 0; font-size: 14px;">Ejecuta el spell checker desde el Test Runner para analizar las p√°ginas.</p>
        <a href="{{ url_for('crawler.test_runner') }}" class="btn" style="display: inline-block; margin-top: 5px; background: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none;">Ir al Test Runner</a>
    </div>
    {% else %}

    <!-- Stats Cards -->
    <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
        {{ stat_card(value=stats.total_checked|default(0), label='URLs Analizadas', gradient='blue') }}
        {{ stat_card(value='%d%%'|format(stats.avg_score|default(0)|round|int), label='Puntuaci√≥n Media', gradient='purple') }}
        {{ stat_card(value=stats.total_issues|default(0), label='Errores Totales', gradient='red') }}
        {{ stat_card(value=stats.ok_count|default(0), label='‚úÖ Sin Errores', gradient='green') }}
    </div>

    <!-- Action Button -->
    <div style="margin: 30px 0; text-align: center;">
        <button onclick="openSpellCheckModal()" class="btn" style="background: #8b5cf6; color: white; padding: 16px 24px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;">
            ‚ö° Ejecutar An√°lisis Ahora
        </button>
    </div>

    {% if spell_results %}
    <!-- Filter Buttons -->
    <div style="margin: 20px 0;">
        <button onclick="filterTable('all')" class="btn btn-primary" id="filter-all">Todas ({{ spell_results|length }})</button>
        <button onclick="filterTable('error')" class="btn" id="filter-error">‚ùå Con Errores ({{ stats.error_count + stats.warning_count }})</button>
        <button onclick="filterTable('ok')" class="btn" id="filter-ok">‚úÖ Sin Errores ({{ stats.ok_count }})</button>
        <button onclick="filterTable('priority')" class="btn" id="filter-priority">‚≠ê Prioritarias</button>
    </div>

    <!-- Results Table -->
    <div class="table-container" style="margin: 20px 0;">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th style="width: 50px;">‚≠ê</th>
                    <th style="width: 500px;">URL</th>
                    <th style="width: 80px;">Estado</th>
                    <th style="width: 100px;">Puntuaci√≥n</th>
                    <th style="width: 100px;">Errores</th>
                    <th style="width: 80px;">Detalles</th>
                    <th style="width: 180px;">√öltima Revisi√≥n</th>
                </tr>
            </thead>
            <tbody id="spell-check-table">
                {% for result in spell_results %}
                <tr class="result-row" data-status="{{ result.status }}" data-priority="{{ result.is_priority|lower }}">
                    <td>{{ loop.index }}</td>
                    <td style="text-align: center;">
                        {% if result.is_priority %}
                            <span style="font-size: 1.2em;">‚≠ê</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ result.url }}" target="_blank" style="color: #3b82f6; text-decoration: none; word-break: break-all;">
                            {{ result.url }}
                        </a>
                    </td>
                    <td>
                        {% if result.status == 'ok' %}
                            <span class="status-badge" style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚úÖ OK</span>
                        {% elif result.status == 'warning' %}
                            <span class="status-badge" style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚ö†Ô∏è Warning</span>
                        {% else %}
                            <span class="status-badge" style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚ùå Error</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <span style="font-weight: 600; font-size: 16px;
                            {% if result.score >= 80 %}color: #10b981;
                            {% elif result.score >= 50 %}color: #f59e0b;
                            {% else %}color: #dc2626;{% endif %}">
                            {{ result.score }}%
                        </span>
                    </td>
                    <td style="text-align: center;">
                        {% if result.issues_found > 0 %}
                            <span style="color: #dc2626; font-weight: 600;">{{ result.issues_found }}</span>
                        {% else %}
                            <span style="color: #10b981;">0</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            {% if result.issues_found > 0 %}
                                <button onclick="toggleDetails({{ loop.index }})" class="btn" style="padding: 4px 12px; font-size: 12px; background: #3b82f6; color: white;">
                                    Ver
                                </button>
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                            <button
                                onclick="recheckUrl({{ result.id }}, {{ loop.index }})"
                                class="btn btn-recheck"
                                title="Re-analizar con diccionario actualizado"
                                style="padding: 4px 12px; font-size: 12px; background: #10b981; color: white;">
                                üîÑ
                            </button>
                        </div>
                    </td>
                    <td style="font-size: 13px; color: #6b7280;">
                        {{ result.checked_at.strftime('%d/%m/%Y %H:%M') if result.checked_at else 'N/A' }}
                    </td>
                </tr>
                <!-- Details Row (hidden by default) -->
                {% if result.issues_found > 0 %}
                <tr id="details-{{ loop.index }}" style="display: none;" class="details-row">
                    <td colspan="8" style="background: #f9fafb; padding: 20px;">
                        <div style="max-width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #1f2937; font-size: 14px; font-weight: 600;">
                                    üìù Errores Ortogr√°ficos Detectados ({{ result.details.spelling_errors|length if result.details.spelling_errors else 0 }})
                                </h4>
                                {% if result.details.spelling_errors and result.details.spelling_errors|length > 1 %}
                                <button
                                    class="btn-add-all-dict"
                                    data-result-id="{{ result.id }}"
                                    data-errors='{{ result.details.spelling_errors|tojson }}'
                                    title="A√±adir todas las palabras de esta URL al diccionario"
                                    style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    üìñ A√±adir Todas al Diccionario ({{ result.details.spelling_errors|length }})
                                </button>
                                {% endif %}
                            </div>

                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Total de Palabras</div>
                                        <div style="font-size: 18px; font-weight: 600; color: #1f2937;">{{ result.details.total_words }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Idioma</div>
                                        <div style="font-size: 18px; font-weight: 600; color: #1f2937;">{{ result.details.language|upper }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Longitud de Texto</div>
                                        <div style="font-size: 18px; font-weight: 600; color: #1f2937;">{{ result.details.text_length }} chars</div>
                                    </div>
                                </div>
                            </div>

                            {% if result.details.spelling_errors %}
                            <div style="max-height: 400px; overflow-y: auto;">
                                {% for error in result.details.spelling_errors[:20] %}
                                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 10px; border-radius: 4px;" id="error-{{ result.id }}-{{ loop.index }}">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">Error</span>
                                            <span style="font-weight: 600; color: #991b1b; font-size: 14px;">{{ error.word }}</span>
                                        </div>
                                        <button
                                            onclick="addWordToDictionary('{{ error.word }}', {{ result.id }}, {{ loop.index }})"
                                            class="btn-add-dict"
                                            title="A√±adir al diccionario personalizado"
                                            style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                            üìñ A√±adir al Diccionario
                                        </button>
                                    </div>
                                    <div style="font-size: 13px; color: #78350f; font-family: monospace; background: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                        {{ error.context|replace('**' + error.word + '**', '<span style="background: #fee2e2; color: #991b1b; padding: 2px 4px; border-radius: 2px; font-weight: 600;">' + error.word + '</span>')|safe }}
                                    </div>
                                    {% if error.sentence and error.sentence != error.context %}
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 6px; font-style: italic;">
                                        Oraci√≥n completa: {{ error.sentence }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                {% if result.details.spelling_errors|length > 20 %}
                                <div style="text-align: center; padding: 10px; color: #6b7280; font-size: 13px; background: #f3f4f6; border-radius: 4px;">
                                    ... y {{ result.details.spelling_errors|length - 20 }} errores m√°s
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <p style="margin: 0; font-size: 13px; color: #6b7280;">
                                    <strong>Mensaje:</strong> {{ result.message }}
                                </p>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 20px; margin: 20px 0; border-radius: 8px; color: #000000;">
        <strong style="color: #000000;">‚úÖ ¬°Excelente!</strong>
        <p style="margin: 10px 0 0 0; color: #000000;">No hay resultados de spell check disponibles a√∫n. Ejecuta el an√°lisis desde el Test Runner.</p>
    </div>
    {% endif %}

    {% endif %}

    <!-- Modal for Running Spell Check -->
    <div id="spellCheckModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
            <h2 style="margin: 0 0 20px 0; color: #1f2937;">üìù An√°lisis Ortogr√°fico</h2>

            <p style="color: #374151; margin-bottom: 25px; font-size: 14px;">
                Selecciona el alcance del an√°lisis. El spell checker revisar√° el contenido de las p√°ginas en busca de errores ortogr√°ficos.
            </p>

            <!-- Scope Selection -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">Alcance del an√°lisis:</label>

                <label style="display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px; cursor: pointer;">
                    <input type="radio" name="spellCheckScope" value="priority" checked style="margin-right: 8px;">
                    <strong style="color: #1f2937;">‚≠ê URLs Prioritarias</strong>
                    <span style="display: block; margin-left: 24px; font-size: 13px; color: #374151;">
                        {{ url_info.priority_count }} URLs ‚Ä¢ Tiempo estimado: {{ url_info.spell_check_priority_time }}
                    </span>
                </label>

                <label style="display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="spellCheckScope" value="all" style="margin-right: 8px;">
                    <strong style="color: #1f2937;">üåê Todas las URLs</strong>
                    <span style="display: block; margin-left: 24px; font-size: 13px; color: #374151;">
                        {{ url_info.total_count }} URLs ‚Ä¢ Tiempo estimado: {{ url_info.spell_check_all_time }}
                    </span>
                </label>
            </div>

            <!-- Progress (hidden initially) -->
            <div id="spellCheckProgress" style="display: none; margin: 20px 0;">
                <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden; position: relative;">
                    <div id="spellCheckProgressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #10b981 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p id="spellCheckProgressText" style="text-align: center; margin-top: 10px; color: #374151; font-size: 14px;">
                    Preparando an√°lisis...
                </p>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button onclick="closeSpellCheckModal()" id="spellCheckCancelBtn" class="btn" style="background: #e5e7eb; color: #374151; padding: 10px 20px; border: none; cursor: pointer; border-radius: 6px;">
                    Cancelar
                </button>
                <button onclick="runSpellCheck()" id="spellCheckRunBtn" class="btn" style="background: #8b5cf6; color: white; padding: 10px 20px; font-weight: 600; border: none; cursor: pointer; border-radius: 6px;">
                    üöÄ Ejecutar An√°lisis
                </button>
            </div>
        </div>
    </div>

</div>

<script>
// ========== Modal Functions ==========

function openSpellCheckModal() {
    const modal = document.getElementById('spellCheckModal');
    modal.style.display = 'flex';
}

function closeSpellCheckModal() {
    const modal = document.getElementById('spellCheckModal');
    modal.style.display = 'none';

    // Reset progress
    const progressBar = document.getElementById('spellCheckProgressBar');
    document.getElementById('spellCheckProgress').style.display = 'none';
    progressBar.style.width = '0%';
    progressBar.style.animation = 'none';
    progressBar.style.background = 'linear-gradient(90deg, #3b82f6 0%, #10b981 100%)';
    document.getElementById('spellCheckProgressText').textContent = 'Preparando an√°lisis...';

    // Re-enable buttons
    document.getElementById('spellCheckRunBtn').disabled = false;
    document.getElementById('spellCheckRunBtn').textContent = 'üöÄ Ejecutar An√°lisis';
    document.getElementById('spellCheckCancelBtn').disabled = false;
}

async function runSpellCheck() {
    // Get selected scope
    const scopeRadios = document.getElementsByName('spellCheckScope');
    let scope = 'priority';
    for (const radio of scopeRadios) {
        if (radio.checked) {
            scope = radio.value;
            break;
        }
    }

    // Disable buttons
    const runButton = document.getElementById('spellCheckRunBtn');
    const cancelButton = document.getElementById('spellCheckCancelBtn');
    runButton.disabled = true;
    runButton.textContent = '‚è≥ Analizando...';
    cancelButton.disabled = true;

    // Show progress
    const progressDiv = document.getElementById('spellCheckProgress');
    const progressBar = document.getElementById('spellCheckProgressBar');
    const progressText = document.getElementById('spellCheckProgressText');
    progressDiv.style.display = 'block';

    // Show estimated time
    let estimatedTime = '';
    if (scope === 'priority') {
        estimatedTime = 'Analizando {{ url_info.priority_count }} URLs ({{ url_info.spell_check_priority_time }})';
    } else {
        estimatedTime = 'Analizando {{ url_info.total_count }} URLs ({{ url_info.spell_check_all_time }})';
    }
    progressText.textContent = estimatedTime + '...';

    // Indeterminate animation (like test_runner)
    progressBar.style.width = '40%';
    progressBar.style.animation = 'progressSlide 2s ease-in-out infinite';

    try {
        // Call API endpoint
        const response = await fetch('/crawler/quality/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                check_types: ['spell_check'],
                scope: scope
            })
        });

        const data = await response.json();

        // Stop progress animation
        progressBar.style.animation = 'none';
        progressBar.style.width = '100%';

        if (data.success) {
            // Get the spell_check result from the checks array
            const checks = data.results.checks || [];
            const spellCheckResult = checks.find(c => c.check_type === 'spell_check') || checks[0];

            progressText.textContent = '‚úÖ An√°lisis completado';

            // Show results
            let message = `An√°lisis ortogr√°fico completado!\n\n`;

            if (spellCheckResult) {
                message += `Estado: ${spellCheckResult.status || 'unknown'}\n`;
                message += `Mensaje: ${spellCheckResult.message || 'N/A'}\n\n`;

                if (spellCheckResult.stats) {
                    message += `URLs procesadas: ${spellCheckResult.stats.processed || 0}\n`;
                    message += `URLs exitosas: ${spellCheckResult.stats.successful || 0}\n`;
                    message += `URLs fallidas: ${spellCheckResult.stats.failed || 0}\n`;
                }
            }

            // Show alert
            setTimeout(() => {
                alert(message);
                // Reload page to show new results
                window.location.reload();
            }, 500);
        } else {
            progressText.textContent = '‚ùå Error en el an√°lisis';
            alert('Error: ' + (data.message || 'Error desconocido'));
            closeSpellCheckModal();
        }
    } catch (error) {
        progressBar.style.animation = 'none';
        progressBar.style.width = '100%';
        progressBar.style.background = '#dc2626';
        progressText.textContent = '‚ùå Error de conexi√≥n';
        alert('Error de conexi√≥n: ' + error.message);
        closeSpellCheckModal();
    }
}

// ========== Filter Functions ==========

function filterTable(filter) {
    const rows = document.querySelectorAll('.result-row');
    const detailsRows = document.querySelectorAll('.details-row');

    // Hide all details first
    detailsRows.forEach(row => row.style.display = 'none');

    // Update button styles
    document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
    });
    document.getElementById(`filter-${filter}`).classList.add('btn-primary');

    // Filter rows
    rows.forEach(row => {
        if (filter === 'all') {
            row.style.display = '';
        } else if (filter === 'ok') {
            row.style.display = row.dataset.status === 'ok' ? '' : 'none';
        } else if (filter === 'error') {
            row.style.display = (row.dataset.status === 'warning' || row.dataset.status === 'error') ? '' : 'none';
        } else if (filter === 'priority') {
            row.style.display = row.dataset.priority === 'true' ? '' : 'none';
        }
    });
}

function toggleDetails(index) {
    const detailsRow = document.getElementById(`details-${index}`);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = '';
    } else {
        detailsRow.style.display = 'none';
    }
}

// ========== Dictionary Functions ==========

async function addWordToDictionary(word, resultId, errorIndex) {
    // Confirm action
    if (!confirm(`¬øA√±adir "${word}" al diccionario personalizado?\n\nEsta palabra ya no se marcar√° como error en futuros an√°lisis.`)) {
        return;
    }

    const errorDiv = document.getElementById(`error-${resultId}-${errorIndex}`);
    const button = errorDiv.querySelector('.btn-add-dict');

    // Disable button
    button.disabled = true;
    button.textContent = '‚è≥ A√±adiendo...';
    button.style.opacity = '0.6';

    try {
        // Add word to dictionary
        const formData = new FormData();
        formData.append('word', word);
        formData.append('category', 'other');
        formData.append('frequency', '1');
        formData.append('notes', 'A√±adida desde spell check');

        const response = await fetch('{{ url_for("add_custom_word") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Show success message
            errorDiv.style.background = '#d1fae5';
            errorDiv.style.borderLeftColor = '#10b981';
            errorDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; color: #065f46;">
                    <span style="font-size: 20px;">‚úÖ</span>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Palabra "${word}" a√±adida correctamente</div>
                        <div style="font-size: 13px; opacity: 0.8;">Ya no se marcar√° como error en futuros an√°lisis</div>
                    </div>
                </div>
            `;

            // Fade out after 3 seconds
            setTimeout(() => {
                errorDiv.style.transition = 'opacity 0.5s, max-height 0.5s';
                errorDiv.style.opacity = '0';
                errorDiv.style.maxHeight = '0';
                errorDiv.style.padding = '0';
                errorDiv.style.marginBottom = '0';
                setTimeout(() => errorDiv.remove(), 500);
            }, 3000);
        } else {
            // Show error
            alert(`Error: ${result.error}`);
            button.disabled = false;
            button.textContent = 'üìñ A√±adir al Diccionario';
            button.style.opacity = '1';
        }
    } catch (error) {
        alert(`Error de conexi√≥n: ${error.message}`);
        button.disabled = false;
        button.textContent = 'üìñ A√±adir al Diccionario';
        button.style.opacity = '1';
    }
}

async function addAllWordsFromUrl(resultId, spellingErrors) {
    // Extract unique words
    const words = [...new Set(spellingErrors.map(error => error.word))];

    // Confirm action
    const confirmMsg = `¬øA√±adir TODAS las ${words.length} palabras de esta URL al diccionario?\n\n` +
                      `Palabras: ${words.slice(0, 10).join(', ')}` +
                      (words.length > 10 ? `, y ${words.length - 10} m√°s...` : '') +
                      `\n\nEsta acci√≥n no se puede deshacer f√°cilmente.`;

    if (!confirm(confirmMsg)) {
        return;
    }

    // Find the button that was clicked
    const bulkButton = document.querySelector(`.btn-add-all-dict[data-result-id="${resultId}"]`);
    if (bulkButton) {
        bulkButton.disabled = true;
        bulkButton.textContent = '‚è≥ A√±adiendo todas...';
        bulkButton.style.opacity = '0.6';
    }

    let added = 0;
    let errors = 0;
    const failedWords = [];

    // Add each word
    for (let i = 0; i < words.length; i++) {
        const word = words[i];

        try {
            const formData = new FormData();
            formData.append('word', word);
            formData.append('category', 'other');
            formData.append('frequency', '1');
            formData.append('notes', 'A√±adida masivamente desde spell check');

            const response = await fetch('{{ url_for("add_custom_word") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                added++;

                // Remove error div if exists
                spellingErrors.forEach((error, idx) => {
                    if (error.word === word) {
                        const errorDiv = document.getElementById(`error-${resultId}-${idx + 1}`);
                        if (errorDiv) {
                            errorDiv.style.transition = 'opacity 0.3s';
                            errorDiv.style.opacity = '0';
                            setTimeout(() => errorDiv.remove(), 300);
                        }
                    }
                });
            } else {
                errors++;
                failedWords.push(word);
            }
        } catch (error) {
            errors++;
            failedWords.push(word);
        }
    }

    // Show results
    let resultMsg = `‚úÖ Proceso completado!\n\n`;
    resultMsg += `Palabras a√±adidas: ${added}\n`;
    if (errors > 0) {
        resultMsg += `Errores: ${errors}\n`;
        resultMsg += `\nPalabras que fallaron: ${failedWords.join(', ')}`;
    }

    alert(resultMsg);

    // Reload page after 1 second to reflect changes
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Add event listener for bulk add buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-add-all-dict').forEach(button => {
        button.addEventListener('click', function() {
            const resultId = parseInt(this.dataset.resultId);
            const spellingErrors = JSON.parse(this.dataset.errors);
            addAllWordsFromUrl(resultId, spellingErrors);
        });
    });
});

// ========== Recheck Functions ==========

async function recheckUrl(checkId, rowIndex) {
    if (!confirm('¬øRe-analizar esta URL con el diccionario actualizado?\n\nEsto actualizar√° los resultados del spell check.')) {
        return;
    }

    // Find the row
    const row = document.querySelectorAll('.result-row')[rowIndex - 1];
    if (!row) return;

    const recheckBtn = row.querySelector('.btn-recheck');
    const originalContent = recheckBtn.innerHTML;

    // Show loading
    recheckBtn.disabled = true;
    recheckBtn.innerHTML = '‚è≥';
    recheckBtn.style.opacity = '0.6';

    try {
        const response = await fetch(`/crawler/spell-check/recheck/${checkId}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            const check = result.check;

            // Update the row with new data
            const statusCell = row.cells[3];
            const scoreCell = row.cells[4];
            const errorsCell = row.cells[5];

            // Update status badge
            let statusBadge = '';
            if (check.status === 'ok') {
                statusBadge = '<span class="status-badge" style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚úÖ OK</span>';
            } else if (check.status === 'warning') {
                statusBadge = '<span class="status-badge" style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚ö†Ô∏è Warning</span>';
            } else {
                statusBadge = '<span class="status-badge" style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚ùå Error</span>';
            }
            statusCell.innerHTML = statusBadge;

            // Update score
            let scoreColor = '#dc2626';
            if (check.score >= 80) scoreColor = '#10b981';
            else if (check.score >= 50) scoreColor = '#f59e0b';

            scoreCell.innerHTML = `<span style="font-weight: 600; font-size: 16px; color: ${scoreColor};">${check.score}%</span>`;

            // Update errors count
            if (check.issues_found > 0) {
                errorsCell.innerHTML = `<span style="color: #dc2626; font-weight: 600;">${check.issues_found}</span>`;
            } else {
                errorsCell.innerHTML = '<span style="color: #10b981;">0</span>';
            }

            // Show success notification
            alert(`‚úÖ Re-an√°lisis completado!\n\nPuntuaci√≥n: ${check.score}%\nErrores: ${check.issues_found}\n\nRecarga la p√°gina para ver los detalles actualizados.`);

            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert(`Error: ${result.error}`);
            recheckBtn.disabled = false;
            recheckBtn.innerHTML = originalContent;
            recheckBtn.style.opacity = '1';
        }
    } catch (error) {
        alert(`Error de conexi√≥n: ${error.message}`);
        recheckBtn.disabled = false;
        recheckBtn.innerHTML = originalContent;
        recheckBtn.style.opacity = '1';
    }
}
</script>

<style>
.result-row {
    transition: background-color 0.2s;
}

.result-row:hover {
    background-color: #f9fafb;
}

.details-row td {
    border-top: none !important;
}

.btn {
    transition: all 0.2s;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

/* Progress bar animation */
@keyframes progressSlide {
    0% {
        left: -40%;
    }
    100% {
        left: 100%;
    }
}

#spellCheckProgressBar {
    position: relative;
}

/* Add to Dictionary Button */
.btn-add-dict:hover {
    background: #7c3aed !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
}

.btn-add-dict:active {
    transform: translateY(0);
}

.btn-add-dict:disabled {
    cursor: not-allowed;
}

/* Add All to Dictionary Button */
.btn-add-all-dict:hover {
    background: #7c3aed !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
}

.btn-add-all-dict:active {
    transform: translateY(0);
}

.btn-add-all-dict:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
</style>
{% endblock %}

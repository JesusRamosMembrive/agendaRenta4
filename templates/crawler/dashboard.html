{% extends "base.html" %}

{% block title %}Crawler - Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h1>üï∑Ô∏è Web Crawler - Dashboard</h1>
    <p class="subtitle">Descubrimiento autom√°tico de URLs</p>

    <!-- Stats Cards -->
    <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
            <div style="font-size: 2em; font-weight: bold;">{{ total_urls }}</div>
            <div>URLs Descubiertas</div>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px;">
            <div style="font-size: 2em; font-weight: bold;">{{ broken_urls }}</div>
            <div>Enlaces Rotos</div>
        </div>

        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px;">
            <div style="font-size: 2em; font-weight: bold;">{{ crawl_runs|length }}</div>
            <div>Crawls Recientes</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin: 30px 0;">
        <button onclick="startCrawl()" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px;">
            ‚ñ∂Ô∏è Iniciar Crawl Manual
        </button>
        <a href="{{ url_for('crawler_results') }}" class="btn" style="padding: 12px 30px; font-size: 16px;">
            üìã Ver Todas las URLs
        </a>
    </div>

    <!-- Crawl Runs History -->
    <h2 style="margin-top: 40px;">Historial de Crawls</h2>

    {% if crawl_runs %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Iniciado</th>
                <th>Finalizado</th>
                <th>Estado</th>
                <th>URLs Descubiertas</th>
                <th>Enlaces Rotos</th>
                <th>Iniciado Por</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for run in crawl_runs %}
            <tr>
                <td>{{ run.id }}</td>
                <td>{{ run.started_at.strftime('%d/%m/%Y %H:%M') if run.started_at else '-' }}</td>
                <td>{{ run.finished_at.strftime('%d/%m/%Y %H:%M') if run.finished_at else '-' }}</td>
                <td>
                    {% if run.status == 'completed' %}
                        <span style="color: #10b981;">‚úì Completado</span>
                    {% elif run.status == 'running' %}
                        <span style="color: #f59e0b;">‚è≥ En progreso</span>
                    {% elif run.status == 'failed' %}
                        <span style="color: #ef4444;">‚úó Fallido</span>
                    {% else %}
                        {{ run.status }}
                    {% endif %}
                </td>
                <td>{{ run.urls_discovered or 0 }}</td>
                <td>{{ run.urls_broken or 0 }}</td>
                <td>{{ run.created_by or 'system' }}</td>
                <td>
                    <a href="{{ url_for('crawler_results_by_run', crawl_run_id=run.id) }}" class="btn btn-sm">
                        Ver Resultados
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; background: #f3f4f6; border-radius: 8px;">
        <p>No hay crawls realizados todav√≠a.</p>
        <p>Haz click en "Iniciar Crawl Manual" para comenzar.</p>
    </div>
    {% endif %}
</div>

<script>
function startCrawl() {
    if (!confirm('¬øIniciar crawl manual? Esto puede tardar varios minutos.')) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Crawling...';

    fetch('{{ url_for("crawler_start") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Crawl completado!\n\nURLs descubiertas: ${data.stats.urls_discovered}\nURLs omitidas: ${data.stats.urls_skipped}\nErrores: ${data.stats.errors}`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Iniciar Crawl Manual';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al iniciar crawl');
        btn.disabled = false;
        btn.textContent = '‚ñ∂Ô∏è Iniciar Crawl Manual';
    });
}
</script>
{% endblock %}

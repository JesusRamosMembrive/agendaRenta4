{% extends "base.html" %}

{% block title %}Crawler - Dashboard{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Web Crawler — Dashboard</h1>
  <p class="page-description">
    Descubrimiento automático de URLs del sitio web
  </p>
</div>

<!-- ===============================================================
     Stats Cards - Horizontal layout
     =============================================================== -->
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl);">
  <!-- URLs Descubiertas -->
  <div class="card" style="flex: 1; border-left: 4px solid var(--primary);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <div style="width: 64px; height: 64px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="globe" class="icon-2xl" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          URLs Descubiertas
        </div>
        <div style="font-size: 48px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
          {{ total_urls }}
        </div>
      </div>
    </div>
  </div>

  <!-- Crawls Recientes -->
  <div class="card" style="flex: 1; border-left: 4px solid var(--success);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <div style="width: 64px; height: 64px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="activity" class="icon-2xl" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Crawls Recientes
        </div>
        <div style="font-size: 48px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
          {{ crawl_runs|length }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===============================================================
     Action Buttons
     =============================================================== -->
<div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap;">
  <button id="crawlBtn" onclick="startCrawl()" class="btn primary">
    <i data-lucide="play-circle" class="icon-sm"></i>
    <span>Iniciar Crawl Manual</span>
  </button>
  <a href="{{ url_for('crawler.tree') }}" class="btn success" style="text-decoration: none;">
    <i data-lucide="git-branch" class="icon-sm"></i>
    <span>Vista de Árbol</span>
  </a>
  <a href="{{ url_for('crawler.results') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="list" class="icon-sm"></i>
    <span>Ver Lista Completa</span>
  </a>
</div>

<!-- ===============================================================
     Progress Section (hidden by default)
     =============================================================== -->
<div id="progressSection" class="card" style="display: none; margin-bottom: var(--space-xl); border-left: 4px solid var(--primary); background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border);">
    <div style="display: flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="loader" class="icon-lg" style="color: var(--primary); animation: spin 2s linear infinite;"></i>
      <h3 style="margin: 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text);">
        Crawl en Progreso
      </h3>
    </div>
    <button id="cancelBtn" onclick="cancelCrawl()" class="btn danger btn-sm">
      <i data-lucide="x-circle" class="icon-xs"></i>
      <span>Cancelar Crawl</span>
    </button>
  </div>

  <!-- Progress Bar -->
  <div style="background: var(--bg-secondary); border-radius: var(--radius-md); height: 8px; margin-bottom: var(--space-lg); overflow: hidden; position: relative;">
    <div id="progressBar" style="
      position: absolute;
      height: 100%;
      width: 40%;
      background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, var(--primary-hover) 100%);
      animation: progressSlide 1.5s ease-in-out infinite;
    "></div>
  </div>

  <!-- Metrics Grid -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-md);">
    <div>
      <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="globe" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">URLs Descubiertas</span>
      </div>
      <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text);" id="urlsDiscovered">0</div>
    </div>

    <div>
      <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="zap" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Velocidad</span>
      </div>
      <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text);" id="crawlSpeed">0</div>
      <div style="font-size: var(--text-xs); color: var(--muted);">URLs/min</div>
    </div>

    <div>
      <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="clock" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Tiempo Transcurrido</span>
      </div>
      <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text);" id="elapsedTime">0s</div>
    </div>

    <div>
      <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="layers" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Profundidad Actual</span>
      </div>
      <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text);" id="currentDepth">0</div>
    </div>
  </div>

  <!-- Last URL -->
  <div style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border-left: 3px solid var(--primary);">
    <div style="font-size: var(--text-xs); color: var(--muted); margin-bottom: var(--space-xs); text-transform: uppercase; letter-spacing: 0.5px;">Última URL procesada:</div>
    <div id="lastUrl" style="font-size: var(--text-sm); word-break: break-all; font-family: 'Courier New', monospace; color: var(--text-secondary);">-</div>
  </div>

  <!-- Estimated Time -->
  <div id="estimatedTime" style="margin-top: var(--space-md); text-align: center; font-size: var(--text-sm); color: var(--text-secondary);">
    <!-- Filled by JavaScript -->
  </div>
</div>

<!-- ===============================================================
     Crawl Runs History
     =============================================================== -->
<div>
  <h2 style="margin-bottom: var(--space-lg); font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="history" class="icon-md"></i>
    <span>Historial de Crawls</span>
  </h2>

  {% if crawl_runs %}
    <div class="card" style="overflow-x: auto; padding: 0;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border);">
            <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">ID</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Iniciado</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Finalizado</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Estado</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URLs Descubiertas</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Enlaces Rotos</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Iniciado Por</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for run in crawl_runs %}
          <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
            <td style="padding: var(--space-md); color: var(--text-secondary);">{{ run.id }}</td>
            <td style="padding: var(--space-md); color: var(--text-secondary);">{{ run.started_at.strftime('%d/%m/%Y %H:%M') if run.started_at else '-' }}</td>
            <td style="padding: var(--space-md); color: var(--text-secondary);">{{ run.finished_at.strftime('%d/%m/%Y %H:%M') if run.finished_at else '-' }}</td>
            <td style="padding: var(--space-md);">
              {% if run.status == 'completed' %}
                <div class="badge badge-success">
                  <i data-lucide="check-circle" class="icon-xs"></i>
                  <span>Completado</span>
                </div>
              {% elif run.status == 'running' %}
                <div class="badge badge-warning">
                  <i data-lucide="loader" class="icon-xs"></i>
                  <span>En progreso</span>
                </div>
              {% elif run.status == 'failed' %}
                <div class="badge badge-danger">
                  <i data-lucide="x-circle" class="icon-xs"></i>
                  <span>Fallido</span>
                </div>
              {% else %}
                <span style="color: var(--text-secondary);">{{ run.status }}</span>
              {% endif %}
            </td>
            <td style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text);">{{ run.urls_discovered or 0 }}</td>
            <td style="padding: var(--space-md); text-align: center; font-weight: var(--font-semibold); color: var(--text);">{{ run.urls_broken or 0 }}</td>
            <td style="padding: var(--space-md); color: var(--text-secondary);">{{ run.created_by or 'system' }}</td>
            <td style="padding: var(--space-md); text-align: center;">
              <a href="{{ url_for('crawler.results_by_run', crawl_run_id=run.id) }}" class="btn ghost btn-sm" style="text-decoration: none;">
                <i data-lucide="eye" class="icon-xs"></i>
                <span>Ver</span>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="card" style="text-align: center; padding: var(--space-2xl); border: 2px dashed var(--border);">
      <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;">
        <i data-lucide="inbox" class="icon-2xl" style="color: var(--muted);"></i>
      </div>
      <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text);">
        No hay crawls realizados todavía
      </h3>
      <p style="margin: 0; color: var(--text-secondary); font-size: var(--text-base);">
        Haz click en "Iniciar Crawl Manual" para comenzar.
      </p>
    </div>
  {% endif %}
</div>

<style>
  @keyframes progressSlide {
    0% { left: -40%; }
    100% { left: 100%; }
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<script>
let progressInterval = null;
let crawlWasRunning = false;

// Check if crawl is already running on page load
window.addEventListener('DOMContentLoaded', function() {
    checkCrawlStatus();
});

function checkCrawlStatus() {
    console.log('[DEBUG] Checking initial crawl status...');
    fetch('{{ url_for("crawler.progress") }}')
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] Initial status:', data);
            if (data.is_running) {
                console.log('[DEBUG] Crawl is running, showing progress...');
                crawlWasRunning = true;
                showProgress();
                updateProgressUI(data);
                startProgressPolling();
            } else {
                console.log('[DEBUG] No crawl running');
            }
        })
        .catch(error => {
            console.error('[ERROR] Checking crawl status:', error);
        });
}

function startCrawl() {
    if (!confirm('¿Iniciar crawl manual? Esto puede tardar varios minutos.')) {
        return;
    }

    const btn = document.getElementById('crawlBtn');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="icon-sm"></i><span>Iniciando...</span>';
    lucide.createIcons();

    crawlWasRunning = false;

    console.log('[DEBUG] Starting crawl...');

    fetch('{{ url_for("crawler.start") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('[DEBUG] Start response:', data);

        if (data.success) {
            console.log('[DEBUG] Crawl started successfully, showing progress...');
            showProgress();
            startProgressPolling();
        } else {
            console.error('[ERROR] Failed to start crawl:', data.error);
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="play-circle" class="icon-sm"></i><span>Iniciar Crawl Manual</span>';
            lucide.createIcons();
        }
    })
    .catch(error => {
        console.error('[ERROR] Starting crawl:', error);
        alert('Error al iniciar crawl: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="play-circle" class="icon-sm"></i><span>Iniciar Crawl Manual</span>';
        lucide.createIcons();
    });
}

function startProgressPolling() {
    progressInterval = setInterval(fetchProgress, 2000);
    fetchProgress();
}

function stopProgressPolling() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

function fetchProgress() {
    console.log('[DEBUG] Fetching progress...');
    fetch('{{ url_for("crawler.progress") }}')
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] Progress data:', data);
            if (data.is_running) {
                crawlWasRunning = true;
                updateProgressUI(data);
            } else {
                console.log('[DEBUG] Crawl not running, was it running before?', crawlWasRunning);
                if (crawlWasRunning) {
                    console.log('[DEBUG] Crawl finished, stopping polling');
                    stopProgressPolling();
                    onCrawlComplete();
                } else {
                    console.log('[DEBUG] Crawl not started yet, continuing to poll...');
                }
            }
        })
        .catch(error => {
            console.error('[ERROR] Fetching progress:', error);
        });
}

function onCrawlComplete() {
    console.log('[DEBUG] Crawl completed, showing alert and reloading...');
    alert('Crawl completado! La página se recargará para mostrar los resultados.');
    window.location.reload();
}

function updateProgressUI(data) {
    document.getElementById('urlsDiscovered').textContent = data.urls_discovered || 0;
    document.getElementById('crawlSpeed').textContent = data.urls_per_minute || 0;

    const elapsedMinutes = Math.floor(data.elapsed_seconds / 60);
    const elapsedSeconds = data.elapsed_seconds % 60;
    const timeStr = elapsedMinutes > 0
        ? `${elapsedMinutes}m ${elapsedSeconds}s`
        : `${elapsedSeconds}s`;
    document.getElementById('elapsedTime').textContent = timeStr;

    document.getElementById('currentDepth').textContent = data.current_depth || 0;

    if (data.last_url) {
        document.getElementById('lastUrl').textContent = data.last_url;
    }

    const estimatedDiv = document.getElementById('estimatedTime');
    if (data.estimated_total) {
        const percentage = data.percentage || 0;
        let statusStr = `Progreso: ${data.urls_discovered} / ~${data.estimated_total} URLs (${percentage}%)`;

        if (data.estimated_remaining_minutes !== null && data.estimated_remaining_minutes !== undefined) {
            const hours = Math.floor(data.estimated_remaining_minutes / 60);
            const mins = data.estimated_remaining_minutes % 60;
            if (hours > 0) {
                statusStr += ` • Tiempo estimado: ${hours}h ${mins}min`;
            } else {
                statusStr += ` • Tiempo estimado: ${mins} minutos`;
            }
        }
        estimatedDiv.textContent = statusStr;
    } else {
        estimatedDiv.textContent = `Descubriendo URLs... (${data.urls_discovered} encontradas hasta ahora)`;
    }
}

function showProgress() {
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('crawlBtn').disabled = true;
    document.getElementById('crawlBtn').innerHTML = '<i data-lucide="loader" class="icon-sm"></i><span>Crawl en Progreso...</span>';
    lucide.createIcons();
}

function hideProgress() {
    document.getElementById('progressSection').style.display = 'none';
}

function cancelCrawl() {
    if (!confirm('¿Estás seguro de que quieres cancelar el crawl? El progreso actual se perderá.')) {
        return;
    }

    console.log('[DEBUG] Requesting crawl cancellation...');

    const cancelBtn = document.getElementById('cancelBtn');
    cancelBtn.disabled = true;
    cancelBtn.innerHTML = '<i data-lucide="loader" class="icon-xs"></i><span>Cancelando...</span>';
    lucide.createIcons();

    fetch('{{ url_for("crawler.cancel") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('[DEBUG] Cancel response:', data);
        if (data.success) {
            alert('Crawl cancelado. La página se recargará.');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i><span>Cancelar Crawl</span>';
            lucide.createIcons();
        }
    })
    .catch(error => {
        console.error('[ERROR] Cancelling crawl:', error);
        alert('Error al cancelar crawl: ' + error.message);
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = '<i data-lucide="x-circle" class="icon-xs"></i><span>Cancelar Crawl</span>';
        lucide.createIcons();
    });
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Scheduler Configuration - Crawler{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Configuración del Scheduler</h1>
  <p class="page-description">
    Programa la revalidación automática de URLs
  </p>
</div>

<!-- ===============================================================
     Current Status Card
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); border-left: 4px solid {% if schedule_info %}var(--success){% else %}var(--muted){% endif %}; background: {% if schedule_info %}var(--success-light){% else %}var(--bg-secondary){% endif %};">
  <h3 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="activity" class="icon-md"></i>
    <span>Estado Actual</span>
  </h3>

  {% if schedule_info %}
    <!-- Active Status -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-lg);">
      <!-- Estado -->
      <div>
        <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
          <i data-lucide="circle-check" class="icon-xs" style="color: var(--muted);"></i>
          <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Estado
          </span>
        </div>
        <div class="badge badge-success">
          <i data-lucide="play-circle" class="icon-xs"></i>
          <span>Activo</span>
        </div>
      </div>

      <!-- Próxima ejecución -->
      <div>
        <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
          <i data-lucide="clock" class="icon-xs" style="color: var(--muted);"></i>
          <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Próxima ejecución
          </span>
        </div>
        <div style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-base);">
          {{ schedule_info.next_run.strftime('%d/%m/%Y %H:%M:%S') if schedule_info.next_run else 'N/A' }}
        </div>
      </div>

      <!-- Configuración -->
      <div>
        <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
          <i data-lucide="settings" class="icon-xs" style="color: var(--muted);"></i>
          <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Configuración
          </span>
        </div>
        <div style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-base);">
          {{ schedule_info.trigger }}
        </div>
      </div>
    </div>

    <!-- Stop Button -->
    <form method="POST">
      <input type="hidden" name="action" value="stop">
      <button type="submit" class="btn" style="background: var(--danger); color: white;">
        <i data-lucide="square" class="icon-xs"></i>
        <span>Detener Scheduler</span>
      </button>
    </form>

  {% else %}
    <!-- Inactive Status -->
    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
      <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="pause-circle" class="icon-lg" style="color: var(--muted);"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-weight: var(--font-bold); color: var(--text); font-size: var(--text-lg); margin-bottom: var(--space-xs);">
          Scheduler inactivo
        </div>
        <div style="color: var(--text-secondary); font-size: var(--text-sm);">
          El scheduler no está en ejecución. Configura y activa la revalidación automática abajo.
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- ===============================================================
     Configuration Form
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--primary);">
  <h3 style="margin: 0 0 var(--space-lg) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="calendar-clock" class="icon-md"></i>
    <span>Configurar Nueva Programación</span>
  </h3>

  <form method="POST">
    <input type="hidden" name="action" value="start">

    <!-- Frecuencia -->
    <div style="margin-bottom: var(--space-lg);">
      <label for="frequency" style="display: block; font-weight: var(--font-semibold); margin-bottom: var(--space-sm); color: var(--text); font-size: var(--text-sm);">
        <i data-lucide="repeat" class="icon-xs" style="vertical-align: middle;"></i>
        Frecuencia:
      </label>
      <select id="frequency" name="frequency" style="width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: var(--text-base);">
        <option value="daily">Diaria</option>
        <option value="weekly">Semanal (Lunes)</option>
      </select>
    </div>

    <!-- Time Input Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
      <!-- Hour -->
      <div>
        <label for="hour" style="display: block; font-weight: var(--font-semibold); margin-bottom: var(--space-sm); color: var(--text); font-size: var(--text-sm);">
          <i data-lucide="clock" class="icon-xs" style="vertical-align: middle;"></i>
          Hora (0-23):
        </label>
        <input type="number" id="hour" name="hour" min="0" max="23" value="3"
               style="width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: var(--text-base);">
      </div>

      <!-- Minute -->
      <div>
        <label for="minute" style="display: block; font-weight: var(--font-semibold); margin-bottom: var(--space-sm); color: var(--text); font-size: var(--text-sm);">
          <i data-lucide="timer" class="icon-xs" style="vertical-align: middle;"></i>
          Minuto (0-59):
        </label>
        <input type="number" id="minute" name="minute" min="0" max="59" value="0"
               style="width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg); color: var(--text); font-size: var(--text-base);">
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn primary">
      <i data-lucide="play" class="icon-xs"></i>
      <span>Iniciar Scheduler</span>
    </button>
  </form>
</div>

<!-- ===============================================================
     Manual Execution
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--warning); background: var(--warning-light);">
  <div style="display: flex; align-items: flex-start; gap: var(--space-lg);">
    <div style="width: 56px; height: 56px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i data-lucide="zap" class="icon-2xl" style="color: white;"></i>
    </div>
    <div style="flex: 1;">
      <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text);">
        Ejecución Manual
      </h3>
      <p style="margin: 0 0 var(--space-md) 0; color: var(--text-secondary); font-size: var(--text-base); line-height: 1.6;">
        Ejecuta una revalidación inmediata sin esperar al scheduler.
        <strong style="color: var(--warning);">Esto puede tomar varios minutos.</strong>
      </p>

      <form method="POST" onsubmit="return confirm('¿Ejecutar revalidación ahora? Esto validará todas las URLs descubiertas.');">
        <input type="hidden" name="action" value="run_now">
        <button type="submit" class="btn" style="background: var(--warning); color: var(--text); font-weight: var(--font-semibold);">
          <i data-lucide="play" class="icon-xs"></i>
          <span>Ejecutar Revalidación Ahora</span>
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ===============================================================
     Information Panel
     =============================================================== -->
<div class="card card-glass" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--primary);">
  <div style="display: flex; align-items: flex-start; gap: var(--space-lg);">
    <div style="width: 56px; height: 56px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i data-lucide="info" class="icon-2xl" style="color: white;"></i>
    </div>
    <div style="flex: 1;">
      <h3 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text);">
        Información del Scheduler
      </h3>

      <ul style="margin: 0; padding-left: var(--space-lg); color: var(--text-secondary); line-height: 1.8; list-style: none;">
        <li style="display: flex; align-items: flex-start; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i data-lucide="check" class="icon-xs" style="color: var(--primary); flex-shrink: 0; margin-top: 4px;"></i>
          <span><strong style="color: var(--text);">Revalidación automática:</strong> El scheduler ejecutará la validación de URLs según la frecuencia configurada.</span>
        </li>
        <li style="display: flex; align-items: flex-start; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i data-lucide="mail" class="icon-xs" style="color: var(--primary); flex-shrink: 0; margin-top: 4px;"></i>
          <span><strong style="color: var(--text);">Notificaciones por email:</strong> Si se detectan nuevos enlaces rotos, se enviará un email de alerta automáticamente.</span>
        </li>
        <li style="display: flex; align-items: flex-start; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i data-lucide="heart-pulse" class="icon-xs" style="color: var(--primary); flex-shrink: 0; margin-top: 4px;"></i>
          <span><strong style="color: var(--text);">Health tracking:</strong> Cada ejecución guarda un snapshot de salud para seguimiento histórico.</span>
        </li>
        <li style="display: flex; align-items: flex-start; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i data-lucide="gauge" class="icon-xs" style="color: var(--primary); flex-shrink: 0; margin-top: 4px;"></i>
          <span><strong style="color: var(--text);">Rate limiting:</strong> La validación respeta límites de 2 req/segundo para no saturar el servidor.</span>
        </li>
        <li style="display: flex; align-items: flex-start; gap: var(--space-sm);">
          <i data-lucide="timer" class="icon-xs" style="color: var(--primary); flex-shrink: 0; margin-top: 4px;"></i>
          <span><strong style="color: var(--text);">Tiempo estimado:</strong> ~{{ ((2839 * 0.5) / 60)|round(1) }} minutos para validar todas las URLs descubiertas.</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- ===============================================================
     Actions
     =============================================================== -->
<div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
  <a href="{{ url_for('crawler.health') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="heart-pulse" class="icon-xs"></i>
    <span>Ver Health Dashboard</span>
  </a>
  <a href="{{ url_for('crawler.dashboard') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="arrow-left" class="icon-xs"></i>
    <span>Volver al Dashboard</span>
  </a>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      {% for category, message in messages %}
        alert("{{ message }}");
      {% endfor %}
    </script>
  {% endif %}
{% endwith %}
{% endblock %}

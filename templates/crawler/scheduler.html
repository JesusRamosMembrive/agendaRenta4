{% extends "base.html" %}

{% block title %}Scheduler Configuration - Crawler{% endblock %}

{% block content %}
<div class="container">
    <h1>‚öôÔ∏è Configuraci√≥n del Scheduler</h1>
    <p style="color: #9ca3af; margin-bottom: 30px;">
        Programa la revalidaci√≥n autom√°tica de URLs
    </p>

    <!-- Current Status -->
    <div style="background: {% if schedule_info %}#dcfce7{% else %}#f3f4f6{% endif %}; padding: 20px; border-radius: 8px; margin-bottom: 40px; color: #111827;">
        <h3 style="margin-top: 0; color: #111827;">Estado Actual</h3>

        {% if schedule_info %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <strong style="color: #374151;">Estado:</strong>
                <span style="color: #059669;">üü¢ Activo</span>
            </div>
            <div>
                <strong style="color: #374151;">Pr√≥xima ejecuci√≥n:</strong>
                <span style="color: #111827;">{{ schedule_info.next_run.strftime('%d/%m/%Y %H:%M:%S') if schedule_info.next_run else 'N/A' }}</span>
            </div>
            <div>
                <strong style="color: #374151;">Configuraci√≥n:</strong>
                <span style="color: #111827;">{{ schedule_info.trigger }}</span>
            </div>
        </div>

        <form method="POST" style="margin-top: 20px;">
            <input type="hidden" name="action" value="stop">
            <button type="submit" class="btn" style="background: #ef4444;">
                üõë Detener Scheduler
            </button>
        </form>
        {% else %}
        <p><strong style="color: #111827;">‚ö™ Scheduler inactivo</strong></p>
        <p style="color: #4b5563;">El scheduler no est√° en ejecuci√≥n. Configura y activa la revalidaci√≥n autom√°tica abajo.</p>
        {% endif %}
    </div>

    <!-- Configuration Form -->
    <div style="background: #f9fafb; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #111827;">Configurar Nueva Programaci√≥n</h3>

        <form method="POST">
            <input type="hidden" name="action" value="start">

            <div style="margin-bottom: 20px;">
                <label for="frequency" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                    Frecuencia:
                </label>
                <select id="frequency" name="frequency" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; color: #111827;">
                    <option value="daily">Diaria</option>
                    <option value="weekly">Semanal (Lunes)</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="hour" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                        Hora (0-23):
                    </label>
                    <input type="number" id="hour" name="hour" min="0" max="23" value="3"
                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; color: #111827;">
                </div>

                <div>
                    <label for="minute" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                        Minuto (0-59):
                    </label>
                    <input type="number" id="minute" name="minute" min="0" max="59" value="0"
                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; color: #111827;">
                </div>
            </div>

            <button type="submit" class="btn" style="background: #10b981;">
                ‚ñ∂Ô∏è Iniciar Scheduler
            </button>
        </form>
    </div>

    <!-- Manual Execution -->
    <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #78350f;">Ejecuci√≥n Manual</h3>
        <p style="color: #78350f; margin-bottom: 15px;">
            Ejecuta una revalidaci√≥n inmediata sin esperar al scheduler.
            <strong>Esto puede tomar varios minutos.</strong>
        </p>

        <form method="POST" onsubmit="return confirm('¬øEjecutar revalidaci√≥n ahora? Esto validar√° todas las URLs descubiertas.');">
            <input type="hidden" name="action" value="run_now">
            <button type="submit" class="btn" style="background: #f59e0b;">
                ‚ñ∂Ô∏è Ejecutar Revalidaci√≥n Ahora
            </button>
        </form>
    </div>

    <!-- Information Panel -->
    <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #1e40af;">‚ÑπÔ∏è Informaci√≥n del Scheduler</h3>

        <ul style="color: #1e40af; line-height: 1.8;">
            <li><strong style="color: #1e3a8a;">Revalidaci√≥n autom√°tica:</strong> El scheduler ejecutar√° la validaci√≥n de URLs seg√∫n la frecuencia configurada.</li>
            <li><strong style="color: #1e3a8a;">Notificaciones por email:</strong> Si se detectan nuevos enlaces rotos, se enviar√° un email de alerta autom√°ticamente.</li>
            <li><strong style="color: #1e3a8a;">Health tracking:</strong> Cada ejecuci√≥n guarda un snapshot de salud para seguimiento hist√≥rico.</li>
            <li><strong style="color: #1e3a8a;">Rate limiting:</strong> La validaci√≥n respeta l√≠mites de 2 req/segundo para no saturar el servidor.</li>
            <li><strong style="color: #1e3a8a;">Tiempo estimado:</strong> ~{{ ((2839 * 0.5) / 60)|round(1) }} minutos para validar todas las URLs descubiertas.</li>
        </ul>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('crawler.health') }}" class="btn">üíö Ver Health Dashboard</a>
        <a href="{{ url_for('crawler.dashboard') }}" class="btn">‚Üê Volver al Dashboard</a>
    </div>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <script>
            {% for category, message in messages %}
                alert("{{ message }}");
            {% endfor %}
        </script>
    {% endif %}
{% endwith %}
{% endblock %}

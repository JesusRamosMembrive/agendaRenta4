{% extends "base.html" %}

{% block title %}Resultados de Validación de CTAs - Agenda Renta4{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
    <div>
      <h1 class="page-title">Resultados de Validación de CTAs</h1>
      <p class="page-description">
        Análisis de los llamados a la acción en el sitio web
      </p>
    </div>
    <div style="display: flex; gap: var(--space-sm);">
      <a href="{{ url_for('crawler.cta_config') }}" class="btn ghost" style="text-decoration: none;">
        <i data-lucide="settings" class="icon-xs"></i>
        <span>Configuración</span>
      </a>
      <a href="{{ url_for('crawler.quality') }}" class="btn ghost" style="text-decoration: none;">
        <i data-lucide="arrow-left" class="icon-xs"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
</div>

<!-- ===============================================================
     Summary Stats
     =============================================================== -->
{% if stats %}
<div style="display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl); flex-wrap: wrap;">
  <!-- Total Checks -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="list-checks" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Total Checks
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.total_checks or 0 }}
    </div>
  </div>

  <!-- OK -->
  <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid var(--success); text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="check-circle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        OK
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--success); line-height: 1;">
      {{ stats.ok_count or 0 }}
    </div>
  </div>

  <!-- Warnings -->
  <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid var(--warning); text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="alert-triangle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Warnings
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--warning); line-height: 1;">
      {{ stats.warning_count or 0 }}
    </div>
  </div>

  <!-- Errors -->
  <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid var(--danger); text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="x-circle" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Errors
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--danger); line-height: 1;">
      {{ stats.error_count or 0 }}
    </div>
  </div>

  <!-- Score Promedio -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="gauge" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Score Promedio
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.avg_score or 0 }}
    </div>
  </div>

  <!-- Issues -->
  <div class="card" style="flex: 1; min-width: 150px; text-align: center; padding: var(--space-md);">
    <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
      <i data-lucide="alert-octagon" class="icon-xs" style="color: var(--muted);"></i>
      <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
        Issues
      </span>
    </div>
    <div style="font-size: 28px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
      {{ stats.total_issues or 0 }}
    </div>
  </div>
</div>
{% endif %}

<!-- ===============================================================
     Results Table
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <div style="border-bottom: 1px solid var(--border); padding-bottom: var(--space-md); margin-bottom: var(--space-lg);">
    <h3 style="margin: 0; font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="bar-chart-3" class="icon-md"></i>
      <span>Últimas 100 Validaciones</span>
    </h3>
  </div>

  {% if checks %}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 2px solid var(--border);">
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">URL</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Estado</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Score</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Mensaje</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Issues</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Fecha</th>
          <th style="padding: var(--space-md); text-align: left; font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">Detalles</th>
        </tr>
      </thead>
      <tbody>
        {% for check in checks %}
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: var(--space-md);">
            <a href="{{ check.url }}" target="_blank" style="color: var(--primary); text-decoration: none; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 300px;">
              {{ check.url }}
            </a>
          </td>
          <td style="padding: var(--space-md);">
            {% if check.status == 'ok' %}
            <span class="badge badge-success">
              <i data-lucide="check-circle" class="icon-xs"></i>
              <span>OK</span>
            </span>
            {% elif check.status == 'warning' %}
            <span class="badge badge-warning">
              <i data-lucide="alert-triangle" class="icon-xs"></i>
              <span>Warning</span>
            </span>
            {% else %}
            <span class="badge badge-danger">
              <i data-lucide="x-circle" class="icon-xs"></i>
              <span>Error</span>
            </span>
            {% endif %}
          </td>
          <td style="padding: var(--space-md);">
            <strong>{{ check.score }}</strong>/100
          </td>
          <td style="padding: var(--space-md); color: var(--text-secondary); font-size: var(--text-sm);">
            {{ check.message }}
          </td>
          <td style="padding: var(--space-md);">
            {% if check.issues_found > 0 %}
            <span class="badge badge-danger">{{ check.issues_found }}</span>
            {% else %}
            <span class="badge badge-success">0</span>
            {% endif %}
          </td>
          <td style="padding: var(--space-md); color: var(--text-secondary); font-size: var(--text-sm);">
            {{ check.checked_at.strftime('%d/%m/%Y %H:%M') }}
          </td>
          <td style="padding: var(--space-md);">
            <button class="btn ghost" style="padding: var(--space-xs) var(--space-sm); font-size: var(--text-sm);" onclick="toggleDetails('details-{{ check.id }}')">
              <i data-lucide="eye" class="icon-xs"></i>
              <span>Ver</span>
            </button>
          </td>
        </tr>
        <tr id="details-{{ check.id }}" style="display: none;">
          <td colspan="7" style="padding: var(--space-lg); background: var(--bg-secondary);">
            <div class="card" style="margin: 0;">
              {% if check.details %}
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-xl);">
                <!-- Estadísticas -->
                <div>
                  <h4 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-xs);">
                    <i data-lucide="bar-chart-2" class="icon-sm"></i>
                    <span>Estadísticas</span>
                  </h4>
                  <ul style="margin: 0; padding-left: var(--space-lg); line-height: 1.8; color: var(--text-secondary);">
                    <li>Total de reglas: <strong style="color: var(--text);">{{ check.details.total_rules }}</strong></li>
                    <li>Reglas requeridas: <strong style="color: var(--text);">{{ check.details.required_rules }}</strong></li>
                    <li>Reglas opcionales: <strong style="color: var(--text);">{{ check.details.optional_rules }}</strong></li>
                    <li>CTAs encontrados: <strong style="color: var(--text);">{{ check.details.found_ctas }}</strong></li>
                  </ul>
                </div>

                <!-- Issues -->
                <div>
                  {% if check.details.missing_required %}
                  <h4 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--danger); display: flex; align-items: center; gap: var(--space-xs);">
                    <i data-lucide="x-circle" class="icon-sm"></i>
                    <span>CTAs Requeridos Faltantes</span>
                  </h4>
                  <ul style="margin: 0 0 var(--space-lg) 0; padding-left: var(--space-lg); line-height: 1.8; color: var(--text-secondary);">
                    {% for cta in check.details.missing_required %}
                    <li>
                      <strong style="color: var(--text);">{{ cta.expected_text }}</strong>
                      {% if cta.is_global %}
                      <span class="badge badge-primary" style="margin-left: var(--space-xs);">Global</span>
                      {% else %}
                      <span class="badge" style="margin-left: var(--space-xs); background: var(--muted); color: white;">{{ cta.page_type }}</span>
                      {% endif %}
                      <br>
                      <small style="color: var(--muted); font-size: var(--text-xs);">Esperado: {{ cta.expected_url }}</small>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if check.details.incorrect_urls %}
                  <h4 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--warning); display: flex; align-items: center; gap: var(--space-xs);">
                    <i data-lucide="alert-triangle" class="icon-sm"></i>
                    <span>CTAs con URL Incorrecta</span>
                  </h4>
                  <ul style="margin: 0 0 var(--space-lg) 0; padding-left: var(--space-lg); line-height: 1.8; color: var(--text-secondary);">
                    {% for cta in check.details.incorrect_urls %}
                    <li>
                      <strong style="color: var(--text);">{{ cta.cta_text }}</strong>
                      <br>
                      <small style="color: var(--muted); font-size: var(--text-xs);">
                        Encontrado: <code style="background: var(--bg-secondary); padding: 2px 4px; border-radius: 3px;">{{ cta.found_url }}</code>
                      </small>
                      <br>
                      <small style="color: var(--muted); font-size: var(--text-xs);">
                        Esperado: <code style="background: var(--bg-secondary); padding: 2px 4px; border-radius: 3px;">{{ cta.expected_url }}</code>
                      </small>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if check.details.matched_ctas %}
                  <h4 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--success); display: flex; align-items: center; gap: var(--space-xs);">
                    <i data-lucide="check-circle" class="icon-sm"></i>
                    <span>CTAs Correctos ({{ check.details.matched_ctas|length }})</span>
                  </h4>
                  <ul style="margin: 0; padding-left: var(--space-lg); line-height: 1.8; color: var(--text-secondary); font-size: var(--text-sm);">
                    {% for cta in check.details.matched_ctas[:5] %}
                    <li>{{ cta.text }}</li>
                    {% endfor %}
                    {% if check.details.matched_ctas|length > 5 %}
                    <li><em style="color: var(--muted);">... y {{ check.details.matched_ctas|length - 5 }} más</em></li>
                    {% endif %}
                  </ul>
                  {% endif %}
                </div>
              </div>
              {% else %}
              <p style="margin: 0; color: var(--muted); text-align: center; padding: var(--space-xl);">
                <i data-lucide="info" class="icon-md" style="opacity: 0.5; display: block; margin: 0 auto var(--space-sm);"></i>
                No hay detalles disponibles
              </p>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="text-align: center; padding: var(--space-2xl); color: var(--muted);">
    <i data-lucide="info" class="icon-2xl" style="margin-bottom: var(--space-md); opacity: 0.5;"></i>
    <h4 style="margin: 0 0 var(--space-md) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--text);">
      No hay resultados de validación
    </h4>
    <p style="margin: 0 0 var(--space-md) 0; color: var(--text-secondary);">
      No se han ejecutado validaciones de CTAs aún. Para ejecutar una validación:
    </p>
    <ol style="margin: 0 auto; padding-left: var(--space-lg); text-align: left; max-width: 500px; line-height: 1.8; color: var(--text-secondary);">
      <li>Ve al <a href="{{ url_for('crawler.quality') }}" style="color: var(--primary); text-decoration: underline;">Dashboard de Calidad</a></li>
      <li>Selecciona "Validación de CTAs" en los checks disponibles</li>
      <li>Ejecuta la validación manualmente</li>
    </ol>
  </div>
  {% endif %}
</div>

<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
});

// Toggle details row
function toggleDetails(id) {
  const detailsRow = document.getElementById(id);
  const button = event.target.closest('button');
  const icon = button.querySelector('i');

  if (detailsRow.style.display === 'none') {
    detailsRow.style.display = 'table-row';
    icon.setAttribute('data-lucide', 'eye-off');
  } else {
    detailsRow.style.display = 'none';
    icon.setAttribute('data-lucide', 'eye');
  }
  lucide.createIcons();
}
</script>
{% endblock %}

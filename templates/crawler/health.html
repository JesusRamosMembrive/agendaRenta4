{% extends "base.html" %}

{% block title %}Health Dashboard - Crawler{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Health Dashboard</h1>
  <p class="page-description">
    Seguimiento histórico de la salud del sitio web
  </p>
</div>

{% if current_health %}
  <!-- ===============================================================
       Current Health Summary Cards
       =============================================================== -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-xl);">
    <!-- Health Score Card -->
    <div class="card" style="border-left: 4px solid {% if current_health.health_score >= 95 %}var(--success){% elif current_health.health_score >= 80 %}var(--warning){% else %}var(--danger){% endif %}; background: {% if current_health.health_score >= 95 %}var(--success-light){% elif current_health.health_score >= 80 %}var(--warning-light){% else %}var(--danger-light){% endif %};">
      <div style="text-align: center;">
        <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
          <i data-lucide="heart-pulse" class="icon-xs" style="color: var(--muted);"></i>
          <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Health Score
          </span>
        </div>
        <div style="font-size: 48px; font-weight: var(--font-bold); color: {% if current_health.health_score >= 95 %}var(--success){% elif current_health.health_score >= 80 %}var(--warning){% else %}var(--danger){% endif %}; line-height: 1;">
          {{ "%.1f"|format(current_health.health_score) }}%
        </div>
        {% if trend != 0 %}
          <div style="margin-top: var(--space-sm); font-size: var(--text-xs); color: {% if trend > 0 %}var(--success){% else %}var(--danger){% endif %};">
            <i data-lucide="{% if trend > 0 %}trending-up{% else %}trending-down{% endif %}" class="icon-xs"></i>
            {{ "%.1f"|format(trend|abs) }}% (7 días)
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Total URLs -->
    <div class="card" style="border-left: 4px solid var(--primary); text-align: center;">
      <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
        <i data-lucide="globe" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Total URLs
        </span>
      </div>
      <div style="font-size: 36px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
        {{ current_health.total_urls }}
      </div>
      <div style="margin-top: var(--space-xs); font-size: var(--text-xs); color: var(--muted);">validadas</div>
    </div>

    <!-- OK URLs -->
    <div class="card" style="border-left: 4px solid var(--success); text-align: center;">
      <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
        <i data-lucide="check-circle" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          URLs OK
        </span>
      </div>
      <div style="font-size: 36px; font-weight: var(--font-bold); color: var(--success); line-height: 1;">
        {{ current_health.ok_urls }}
      </div>
      <div style="margin-top: var(--space-xs); font-size: var(--text-xs); color: var(--muted);">
        {{ "%.1f"|format((current_health.ok_urls / current_health.total_urls * 100) if current_health.total_urls > 0 else 0) }}%
      </div>
    </div>

    <!-- Broken URLs -->
    <div class="card" style="border-left: 4px solid var(--danger); text-align: center;">
      <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
        <i data-lucide="link-2-off" class="icon-xs" style="color: var(--muted);"></i>
        <span style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Enlaces Rotos
        </span>
      </div>
      <div style="font-size: 36px; font-weight: var(--font-bold); color: var(--danger); line-height: 1;">
        {{ current_health.broken_urls }}
      </div>
      <div style="margin-top: var(--space-xs); font-size: var(--text-xs); color: var(--muted);">
        {{ "%.1f"|format((current_health.broken_urls / current_health.total_urls * 100) if current_health.total_urls > 0 else 0) }}%
      </div>
    </div>
  </div>

  <!-- Last Updated -->
  <div style="text-align: center; margin-bottom: var(--space-xl); color: var(--muted); font-size: var(--text-sm); display: flex; align-items: center; justify-content: center; gap: var(--space-xs);">
    <i data-lucide="clock" class="icon-xs"></i>
    <span>Última actualización: {{ current_health.snapshot_date.strftime('%d/%m/%Y %H:%M:%S') }}</span>
  </div>

{% else %}
  <!-- ===============================================================
       No Data Available
       =============================================================== -->
  <div class="card" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--warning); background: var(--warning-light);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <i data-lucide="alert-triangle" class="icon-xl" style="color: var(--warning);"></i>
      <div style="flex: 1;">
        <h3 style="margin: 0 0 var(--space-xs) 0; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--text);">
          No hay datos de salud disponibles
        </h3>
        <p style="margin: 0; color: var(--text-secondary); font-size: var(--text-sm);">
          Ejecuta una <a href="{{ url_for('crawler.scheduler') }}" style="color: var(--warning-hover); text-decoration: underline; font-weight: var(--font-semibold);">revalidación</a> para generar el primer snapshot.
        </p>
      </div>
    </div>
  </div>
{% endif %}

<!-- ===============================================================
     Recent Changes
     =============================================================== -->
{% if recent_changes %}
  <h2 style="margin-bottom: var(--space-lg); font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="activity" class="icon-md"></i>
    <span>Cambios Recientes (últimos 7 días)</span>
  </h2>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl);">
    {% for change in recent_changes %}
    <div class="card" style="text-align: center; border-top: 3px solid var(--primary);">
      <div style="font-size: 32px; font-weight: var(--font-bold); margin-bottom: var(--space-xs); color: var(--text);">
        {{ change.count }}
      </div>
      <div style="font-size: var(--text-xs); color: var(--muted); text-transform: uppercase; font-weight: var(--font-semibold); letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: var(--space-xs);">
        {% if change.change_type == 'new' %}
          <i data-lucide="plus-circle" class="icon-xs"></i>
          <span>Nuevas</span>
        {% elif change.change_type == 'broken' %}
          <i data-lucide="x-circle" class="icon-xs"></i>
          <span>Rotas</span>
        {% elif change.change_type == 'fixed' %}
          <i data-lucide="check-circle" class="icon-xs"></i>
          <span>Corregidas</span>
        {% elif change.change_type == 'status_change' %}
          <i data-lucide="refresh-cw" class="icon-xs"></i>
          <span>Cambios</span>
        {% else %}
          <span>{{ change.change_type }}</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
{% endif %}

<!-- ===============================================================
     Historical Chart
     =============================================================== -->
{% if snapshots|length > 1 %}
  <h2 style="margin-bottom: var(--space-lg); font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="trending-up" class="icon-md"></i>
    <span>Evolución Histórica</span>
  </h2>

  <div class="card" style="margin-bottom: var(--space-xl);">
    <canvas id="healthChart" width="400" height="200"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    const ctx = document.getElementById('healthChart').getContext('2d');

    // Prepare data (reverse to show oldest first)
    const snapshots = {{ snapshots|tojson|safe }};
    snapshots.reverse();

    const labels = snapshots.map(s => {
      const date = new Date(s.snapshot_date);
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
    });

    const healthData = snapshots.map(s => s.health_score);
    const brokenData = snapshots.map(s => s.broken_urls);

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Health Score (%)',
            data: healthData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.3,
            yAxisID: 'y'
          },
          {
            label: 'Enlaces Rotos',
            data: brokenData,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.3,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  if (context.datasetIndex === 0) {
                    label += context.parsed.y.toFixed(1) + '%';
                  } else {
                    label += context.parsed.y;
                  }
                }
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            min: 0,
            max: 100,
            title: {
              display: true,
              text: 'Health Score (%)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            min: 0,
            title: {
              display: true,
              text: 'Enlaces Rotos'
            },
            grid: {
              drawOnChartArea: false
            }
          }
        }
      }
    });
  </script>
{% endif %}

<!-- ===============================================================
     Actions
     =============================================================== -->
<div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
  <a href="{{ url_for('crawler.scheduler') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="settings" class="icon-xs"></i>
    <span>Configurar Scheduler</span>
  </a>
  <a href="{{ url_for('crawler.broken') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="search" class="icon-xs"></i>
    <span>Ver Enlaces Rotos</span>
  </a>
  <a href="{{ url_for('crawler.dashboard') }}" class="btn ghost" style="text-decoration: none;">
    <i data-lucide="arrow-left" class="icon-xs"></i>
    <span>Volver al Dashboard</span>
  </a>
</div>
{% endblock %}

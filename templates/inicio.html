{% extends "base.html" %}

{% block title %}Inicio - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">Inicio — URLs del mes</div>

{% if sections %}
  <div class="table" role="table" aria-label="Listado de URLs y tareas">
    <table>
      <thead>
        <tr>
          <th class="sticky" style="width:22%">URL / Página</th>
          {% for task_type in task_types %}
            <th class="sticky task-head">{{ task_type.display_name }}</th>
          {% endfor %}
          <th class="sticky task-head" style="width:120px">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for section in sections %}
          <!-- Fila principal con URL y radios -->
          <tr class="url-row" data-section-url="{{ section.url }}" data-section-id="{{ section.id }}">
            <!-- Columna URL -->
            <td class="url-col" title="{{ section.url }}">
              <a href="{{ section.url }}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
                {{ section.name }}
              </a>
            </td>

            <!-- Columnas de tipos de tareas (8 columnas con botones toggle) -->
            {% for task_type in task_types %}
              {% set task = section.tasks_by_type.get(task_type.id) %}
              <td>
                <div class="cell-group" role="group" aria-label="{{ task_type.display_name }} {{ section.name }}">
                  <div class="task-buttons"
                       data-task-id="{{ task.id if task else '' }}"
                       data-section-id="{{ section.id }}"
                       data-task-type-id="{{ task_type.id }}"
                       data-period="{{ period }}"
                       data-current-status="{{ task.status if task else 'pending' }}">

                    <button type="button"
                            class="task-btn task-btn-ok {% if task and task.status == 'ok' %}active{% endif %}"
                            data-status="ok"
                            title="Marcar como OK">
                      ✓
                    </button>

                    <button type="button"
                            class="task-btn task-btn-problem {% if task and task.status == 'problem' %}active{% endif %}"
                            data-status="problem"
                            title="Marcar como Problema">
                      ⚠
                    </button>
                  </div>
                </div>
              </td>
            {% endfor %}

            <!-- Columna Status (dot con color) -->
            <td>
              <span class="status-dot sd-neutral" aria-label="Status"></span>
            </td>
          </tr>

          <!-- Fila de observaciones (se muestra solo si hay problemas) -->
          <tr class="url-detail">
            <td colspan="{{ task_types|length + 2 }}">
              <div class="label" style="margin-bottom:6px">
                Observaciones para {{ section.name }}
              </div>
              <form method="post" action="{{ url_for('save_observations') }}">
                <input type="hidden" name="section_id" value="{{ section.id }}" />
                <input type="hidden" name="period" value="{{ period }}" />
                <textarea
                  class="obs"
                  name="observations"
                  placeholder="Describe las incidencias encontradas..."
                  data-section-id="{{ section.id }}"
                >{% if section.observations %}{{ section.observations }}{% endif %}</textarea>
                <div style="margin-top: 8px; text-align: right;">
                  <button type="submit" class="btn primary">Guardar observaciones</button>
                </div>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top:14px; color:#a7afc5">
    <strong>Instrucciones:</strong>
    <ul style="margin: 8px 0; padding-left: 20px;">
      <li>Haz clic en "Ok" si todo está correcto</li>
      <li>Haz clic en "Problema" si hay incidencias</li>
      <li>Puedes desmarcar haciendo clic de nuevo en la opción seleccionada</li>
      <li>El círculo de Status indica: <span class="status-dot sd-green"></span> todo OK, <span class="status-dot sd-orange"></span> hay problemas, <span class="status-dot sd-red"></span> muchos problemas</li>
      <li>Las observaciones aparecen automáticamente cuando marcas algún problema</li>
    </ul>
  </div>

{% else %}
  <div class="panel">
    <h3>No hay secciones disponibles</h3>
    <p>No se encontraron URLs para revisar en este periodo.</p>
    <p style="margin-top: 12px;">
      <a href="{{ url_for('config.index') }}" class="btn primary">Ir a Configuración</a>
    </p>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit cuando se hace click en un botón de estado
document.addEventListener('DOMContentLoaded', function() {
  const taskButtons = document.querySelectorAll('.task-btn');

  taskButtons.forEach(button => {
    button.addEventListener('click', function() {
      const container = this.closest('.task-buttons');
      const clickedStatus = this.dataset.status;
      const currentStatus = container.dataset.currentStatus;
      const taskId = container.dataset.taskId;
      const isActive = this.classList.contains('active');

      console.log('Button clicked:', clickedStatus, 'Current:', currentStatus, 'IsActive:', isActive);

      let newStatus;

      // If clicking the active button, set to pending (unmark)
      if (isActive) {
        newStatus = 'pending';
        this.classList.remove('active');
      } else {
        // Remove active from all buttons in this group
        container.querySelectorAll('.task-btn').forEach(btn => btn.classList.remove('active'));
        // Set this button as active
        this.classList.add('active');
        newStatus = clickedStatus;
      }

      // Update container's current status
      container.dataset.currentStatus = newStatus;

      // Save to server
      saveTaskStatus(container, newStatus);

      // Update status dot for this row
      const row = this.closest('.url-row');
      updateRowStatus(row);
    });
  });

  function saveTaskStatus(container, status) {
    const taskId = container.dataset.taskId;
    const sectionId = container.dataset.sectionId;
    const taskTypeId = container.dataset.taskTypeId;
    const period = container.dataset.period;

    console.log('Saving - Task ID:', taskId || 'NEW', 'Status:', status);

    // Prepare form data
    const formData = new FormData();
    formData.append('task_id', taskId || '');
    formData.append('section_id', sectionId);
    formData.append('task_type_id', taskTypeId);
    formData.append('period', period);
    formData.append('status', status);

    fetch('{{ url_for("update_task") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Saved successfully. Task ID:', data.task_id);

        // Update task_id if it was a new task
        if (!taskId && data.task_id) {
          container.dataset.taskId = data.task_id;
        }
      } else {
        console.error('Error:', data.error);
        alert('Error al guardar. Por favor, intenta de nuevo.');
      }
    })
    .catch(error => {
      console.error('Network error:', error);
      alert('Error de conexión. Por favor, verifica tu conexión e intenta de nuevo.');
    });
  }

  // Auto-save observaciones con debounce
  const textareas = document.querySelectorAll('textarea.obs');
  textareas.forEach(textarea => {
    let timeout = null;

    textarea.addEventListener('input', function() {
      clearTimeout(timeout);

      timeout = setTimeout(() => {
        const form = this.closest('form');
        const formData = new FormData(form);

        fetch(form.action, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Observaciones guardadas');
          }
        })
        .catch(error => {
          console.error('Error guardando observaciones:', error);
        });
      }, 1000); // Auto-save después de 1 segundo de inactividad
    });
  });

  // Initialize status dots on page load
  document.querySelectorAll('.url-row').forEach(row => {
    updateRowStatus(row);
  });
});

// Function to update status dot based on task buttons
function updateRowStatus(row) {
  const taskButtons = row.querySelectorAll('.task-buttons');
  const statusDot = row.querySelector('.status-dot');

  if (!statusDot) return;

  let oks = 0;
  let problems = 0;
  const totalTasks = taskButtons.length;

  // Count active OK and Problem buttons
  taskButtons.forEach(container => {
    const okBtn = container.querySelector('.task-btn-ok.active');
    const problemBtn = container.querySelector('.task-btn-problem.active');

    if (okBtn) oks++;
    if (problemBtn) problems++;
  });

  // Update status dot class based on rules
  statusDot.className = 'status-dot sd-neutral';

  if (problems === 0 && oks === totalTasks) {
    // All OK - green
    statusDot.className = 'status-dot sd-green';
  } else if (problems > 4) {
    // More than 4 problems - red
    statusDot.className = 'status-dot sd-red';
  } else if (problems > 0) {
    // 1-4 problems - orange
    statusDot.className = 'status-dot sd-orange';
  }

  console.log('Row status updated:', { oks, problems, totalTasks, class: statusDot.className });
}
</script>
{% endblock %}
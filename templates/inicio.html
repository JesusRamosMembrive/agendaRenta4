{% extends "base.html" %}

{% block title %}Inicio - Agenda Renta4{% endblock %}

{% block content %}
<!-- ===================================================================
     Page Header
     =================================================================== -->
<div class="page-header">
  <h1 class="page-title">Dashboard — URLs del mes</h1>
  <p class="page-description">
    Revisa y marca cada URL según el estado de sus tareas
  </p>
</div>

<!-- ===================================================================
     Quick Stats - 3 Cards Horizontales
     =================================================================== -->
<div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-xl);">
  <!-- Pendientes Card -->
  <a href="{{ url_for('pendientes') }}" class="card card-interactive" style="flex: 1; text-decoration: none; color: inherit;">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="clock" class="icon-lg" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
          Pendientes
        </div>
        <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
          {{ task_counts.pending }}
        </div>
      </div>
    </div>
  </a>

  <!-- Problemas Card -->
  <a href="{{ url_for('problemas') }}" class="card card-interactive" style="flex: 1; text-decoration: none; color: inherit;">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--danger) 0%, var(--danger-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="alert-triangle" class="icon-lg" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
          Problemas
        </div>
        <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
          {{ task_counts.problems }}
        </div>
      </div>
    </div>
  </a>

  <!-- Realizadas Card -->
  <a href="{{ url_for('realizadas') }}" class="card card-interactive" style="flex: 1; text-decoration: none; color: inherit;">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
        <i data-lucide="check-circle" class="icon-lg" style="color: white;"></i>
      </div>
      <div style="flex: 1;">
        <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-xs);">
          Realizadas
        </div>
        <div style="font-size: 32px; font-weight: var(--font-bold); color: var(--text); line-height: 1;">
          {{ task_counts.completed }}
        </div>
      </div>
    </div>
  </a>
</div>

<!-- ===================================================================
     Guía Rápida Card
     =================================================================== -->
<div class="card card-glass" style="margin-bottom: var(--space-xl); border-left: 4px solid var(--primary);">
  <div style="display: flex; align-items: flex-start; gap: var(--space-lg);">
    <div style="width: 56px; height: 56px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i data-lucide="clipboard-list" class="icon-2xl" style="color: white;"></i>
    </div>

    <div style="flex: 1;">
      <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md);">
        <i data-lucide="help-circle" class="icon-sm icon-primary"></i>
        <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-base);">
          ¿Qué hago ahora?
        </span>
      </div>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm);">
        <div style="display: flex; align-items: flex-start; gap: var(--space-xs);">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: var(--font-bold); flex-shrink: 0; margin-top: 2px;">1</div>
          <div>
            <div style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm); margin-bottom: 2px;">Elige el periodo</div>
            <div style="color: var(--muted); font-size: var(--text-xs); line-height: var(--leading-relaxed);">Selecciona en la barra superior</div>
          </div>
        </div>

        <div style="display: flex; align-items: flex-start; gap: var(--space-xs);">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: var(--font-bold); flex-shrink: 0; margin-top: 2px;">2</div>
          <div>
            <div style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm); margin-bottom: 2px;">Marca cada tarea</div>
            <div style="color: var(--muted); font-size: var(--text-xs); line-height: var(--leading-relaxed);">✓ OK o ⚠ Problema</div>
          </div>
        </div>

        <div style="display: flex; align-items: flex-start; gap: var(--space-xs);">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: var(--font-bold); flex-shrink: 0; margin-top: 2px;">3</div>
          <div>
            <div style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm); margin-bottom: 2px;">Escribe notas</div>
            <div style="color: var(--muted); font-size: var(--text-xs); line-height: var(--leading-relaxed);">Si hay incidencias (auto-guardado)</div>
          </div>
        </div>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
      <a href="{{ url_for('config.index') }}" class="btn ghost" style="white-space: nowrap; display: inline-flex; align-items: center; gap: var(--space-xs);">
        <i data-lucide="settings" class="icon-sm"></i>
        <span>Configurar</span>
      </a>
      <a href="{{ url_for('alertas') }}" class="btn ghost" style="white-space: nowrap; display: inline-flex; align-items: center; gap: var(--space-xs);">
        <i data-lucide="bell" class="icon-sm"></i>
        <span>Alertas</span>
      </a>
    </div>
  </div>
</div>

<!-- ===================================================================
     URLs List - Card-based
     =================================================================== -->
{% if sections %}
  <div style="display: flex; flex-direction: column; gap: var(--space-md);">
    {% for section in sections %}
    <div class="card card-interactive url-card" data-section-id="{{ section.id }}">
      <!-- Card Header with URL and Status -->
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border);">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
            <i data-lucide="link" class="icon-sm icon-muted"></i>
            <a href="{{ section.url }}" target="_blank" rel="noopener noreferrer"
               style="font-weight: var(--font-semibold); color: var(--text); text-decoration: none; font-size: var(--text-base);"
               class="url-link">
              {{ section.name }}
            </a>
            <i data-lucide="external-link" class="icon-xs icon-muted"></i>
          </div>
          <div style="color: var(--muted); font-size: var(--text-xs); font-family: 'Courier New', monospace;">
            {{ section.url }}
          </div>
        </div>

        <!-- Status Indicator -->
        <div style="display: flex; align-items: center; gap: var(--space-sm);">
          <span style="font-size: var(--text-xs); color: var(--muted); font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;">Estado</span>
          <span class="status-dot sd-neutral url-status-dot" aria-label="Status" style="width: 12px; height: 12px;"></span>
        </div>
      </div>

      <!-- Task Types Grid -->
      <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--space-sm); margin-bottom: var(--space-md); align-items: center;">
        {% for task_type in task_types %}
          {% set task = section.tasks_by_type.get(task_type.id) %}

          <!-- Task Type Label -->
          <div style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            {{ task_type.display_name }}
          </div>

          <!-- Task Buttons -->
          <div class="task-type-card"
               data-task-id="{{ task.id if task else '' }}"
               data-section-id="{{ section.id }}"
               data-task-type-id="{{ task_type.id }}"
               data-period="{{ period }}"
               data-current-status="{{ task.status if task else 'pending' }}"
               style="display: flex; gap: 4px;">
            <button type="button"
                    class="task-btn task-btn-ok {% if task and task.status == 'ok' %}active{% endif %}"
                    data-status="ok"
                    title="Marcar como OK"
                    style="width: 28px; height: 28px; padding: 0; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center;">
              <i data-lucide="check" class="icon-xs"></i>
            </button>

            <button type="button"
                    class="task-btn task-btn-problem {% if task and task.status == 'problem' %}active{% endif %}"
                    data-status="problem"
                    title="Marcar como Problema"
                    style="width: 28px; height: 28px; padding: 0; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center;">
              <i data-lucide="alert-triangle" class="icon-xs"></i>
            </button>
          </div>
        {% endfor %}
      </div>

      <!-- Observaciones Section (hidden by default, shown when problems exist) -->
      <div class="observations-section" style="display: none; padding-top: var(--space-md); border-top: 1px solid var(--border);">
        <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
          <i data-lucide="file-text" class="icon-xs"></i>
          <span>Observaciones para {{ section.name }}</span>
        </label>

        <form method="post" action="{{ url_for('save_observations') }}" class="observations-form">
          <input type="hidden" name="section_id" value="{{ section.id }}" />
          <input type="hidden" name="period" value="{{ period }}" />
          <textarea
            class="textarea obs-textarea"
            name="observations"
            placeholder="Describe las incidencias encontradas..."
            data-section-id="{{ section.id }}"
            rows="3"
            style="width: 100%; resize: vertical;">{% if section.observations %}{{ section.observations }}{% endif %}</textarea>
          <div style="margin-top: var(--space-sm); text-align: right;">
            <button type="submit" class="btn primary btn-sm" style="display: inline-flex; align-items: center; gap: var(--space-xs);">
              <i data-lucide="save" class="icon-xs"></i>
              <span>Guardar observaciones</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Instructions Card -->
  <div class="card card-sm" style="margin-top: var(--space-xl);">
    <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
      <i data-lucide="info" class="icon-sm icon-primary" style="flex-shrink: 0; margin-top: 2px;"></i>
      <div style="flex: 1;">
        <div style="font-weight: var(--font-semibold); color: var(--text); margin-bottom: var(--space-sm); font-size: var(--text-sm);">
          Instrucciones de uso
        </div>
        <ul style="margin: 0; padding-left: var(--space-lg); color: var(--muted); font-size: var(--text-xs); line-height: var(--leading-relaxed);">
          <li>Haz clic en "OK" si todo está correcto</li>
          <li>Haz clic en "Problema" si hay incidencias</li>
          <li>Puedes desmarcar haciendo clic de nuevo en la opción seleccionada</li>
          <li>El círculo de Estado indica: <span class="status-dot sd-green" style="display: inline-block; vertical-align: middle;"></span> todo OK, <span class="status-dot sd-orange" style="display: inline-block; vertical-align: middle;"></span> hay problemas, <span class="status-dot sd-red" style="display: inline-block; vertical-align: middle;"></span> muchos problemas</li>
          <li>Las observaciones aparecen automáticamente cuando marcas algún problema</li>
        </ul>
      </div>
    </div>
  </div>

{% else %}
  <!-- Empty State -->
  <div class="card" style="text-align: center; padding: var(--space-2xl);">
    <div style="width: 64px; height: 64px; margin: 0 auto var(--space-lg); border-radius: 50%; background: linear-gradient(135deg, var(--muted-light) 0%, var(--border) 100%); display: flex; align-items: center; justify-content: center;">
      <i data-lucide="inbox" class="icon-xl icon-muted"></i>
    </div>
    <h3 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text);">
      No hay secciones disponibles
    </h3>
    <p style="margin: 0 0 var(--space-lg) 0; color: var(--muted); font-size: var(--text-sm);">
      No se encontraron URLs para revisar en este periodo.
    </p>
    <a href="{{ url_for('config.index') }}" class="btn primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
      <i data-lucide="settings" class="icon-sm"></i>
      <span>Ir a Configuración</span>
    </a>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<style>
/* Task Button Styles */
.task-btn {
  transition: all 0.2s ease;
}

.task-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.task-btn-ok.active {
  background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%) !important;
  border-color: var(--success) !important;
  color: white !important;
}

.task-btn-ok.active i {
  color: white !important;
}

.task-btn-problem.active {
  background: linear-gradient(135deg, var(--danger) 0%, var(--danger-hover) 100%) !important;
  border-color: var(--danger) !important;
  color: white !important;
}

.task-btn-problem.active i {
  color: white !important;
}

/* URL Link Hover */
.url-link:hover {
  color: var(--primary) !important;
}

/* Card Hover Effect */
.url-card {
  transition: all 0.3s ease;
}

.url-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

/* Card Active/Selected State */
.url-card.selected {
  border-left: 4px solid var(--success) !important;
  background: linear-gradient(to right, rgba(34, 197, 94, 0.05), transparent) !important;
}
</style>

<script>
// Auto-submit cuando se hace click en un botón de estado
document.addEventListener('DOMContentLoaded', function() {
  const taskButtons = document.querySelectorAll('.task-btn');

  // Handle card selection (highlight on click)
  const urlCards = document.querySelectorAll('.url-card');

  // Load selected card from localStorage
  const selectedCardId = localStorage.getItem('selectedUrlCard');
  if (selectedCardId) {
    const savedCard = document.querySelector(`.url-card[data-section-id="${selectedCardId}"]`);
    if (savedCard) {
      savedCard.classList.add('selected');
    }
  }

  // Add click handler to each card
  urlCards.forEach(card => {
    card.addEventListener('click', function(e) {
      // Don't toggle if clicking on a button or link
      if (e.target.closest('button') || e.target.closest('a') || e.target.closest('textarea')) {
        return;
      }

      const sectionId = this.dataset.sectionId;

      // Toggle selected state
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        localStorage.removeItem('selectedUrlCard');
      } else {
        // Remove selected from all cards
        urlCards.forEach(c => c.classList.remove('selected'));
        // Add selected to this card
        this.classList.add('selected');
        // Save to localStorage
        localStorage.setItem('selectedUrlCard', sectionId);
      }
    });
  });

  taskButtons.forEach(button => {
    button.addEventListener('click', function() {
      const container = this.closest('.task-type-card');
      const clickedStatus = this.dataset.status;
      const currentStatus = container.dataset.currentStatus;
      const taskId = container.dataset.taskId;
      const isActive = this.classList.contains('active');

      console.log('Button clicked:', clickedStatus, 'Current:', currentStatus, 'IsActive:', isActive);

      let newStatus;

      // If clicking the active button, set to pending (unmark)
      if (isActive) {
        newStatus = 'pending';
        this.classList.remove('active');
      } else {
        // Remove active from all buttons in this group
        container.querySelectorAll('.task-btn').forEach(btn => btn.classList.remove('active'));
        // Set this button as active
        this.classList.add('active');
        newStatus = clickedStatus;
      }

      // Update container's current status
      container.dataset.currentStatus = newStatus;

      // Save to server
      saveTaskStatus(container, newStatus);

      // Update status dot for this URL card
      const card = this.closest('.url-card');
      updateCardStatus(card);

      // Show/hide observations section
      updateObservationsVisibility(card);
    });
  });

  function saveTaskStatus(container, status) {
    const taskId = container.dataset.taskId;
    const sectionId = container.dataset.sectionId;
    const taskTypeId = container.dataset.taskTypeId;
    const period = container.dataset.period;

    console.log('Saving - Task ID:', taskId || 'NEW', 'Status:', status);

    // Prepare form data
    const formData = new FormData();
    formData.append('task_id', taskId || '');
    formData.append('section_id', sectionId);
    formData.append('task_type_id', taskTypeId);
    formData.append('period', period);
    formData.append('status', status);

    fetch('{{ url_for("update_task") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Saved successfully. Task ID:', data.task_id);

        // Update task_id if it was a new task
        if (!taskId && data.task_id) {
          container.dataset.taskId = data.task_id;
        }
      } else {
        console.error('Error:', data.error);
        alert('Error al guardar. Por favor, intenta de nuevo.');
      }
    })
    .catch(error => {
      console.error('Network error:', error);
      alert('Error de conexión. Por favor, verifica tu conexión e intenta de nuevo.');
    });
  }

  // Auto-save observaciones con debounce
  const textareas = document.querySelectorAll('textarea.obs-textarea');
  textareas.forEach(textarea => {
    let timeout = null;

    textarea.addEventListener('input', function() {
      clearTimeout(timeout);

      timeout = setTimeout(() => {
        const form = this.closest('form');
        const formData = new FormData(form);

        fetch(form.action, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Observaciones guardadas');
          }
        })
        .catch(error => {
          console.error('Error guardando observaciones:', error);
        });
      }, 1000); // Auto-save después de 1 segundo de inactividad
    });
  });

  // Initialize status dots and observations visibility on page load
  document.querySelectorAll('.url-card').forEach(card => {
    updateCardStatus(card);
    updateObservationsVisibility(card);
  });
});

// Function to update status dot based on task buttons
function updateCardStatus(card) {
  const taskContainers = card.querySelectorAll('.task-type-card');
  const statusDot = card.querySelector('.url-status-dot');

  if (!statusDot) return;

  let oks = 0;
  let problems = 0;
  const totalTasks = taskContainers.length;

  // Count active OK and Problem buttons
  taskContainers.forEach(container => {
    const okBtn = container.querySelector('.task-btn-ok.active');
    const problemBtn = container.querySelector('.task-btn-problem.active');

    if (okBtn) oks++;
    if (problemBtn) problems++;
  });

  // Update status dot class based on rules
  statusDot.className = 'status-dot url-status-dot sd-neutral';

  if (problems === 0 && oks === totalTasks) {
    // All OK - green
    statusDot.className = 'status-dot url-status-dot sd-green';
  } else if (problems > 4) {
    // More than 4 problems - red
    statusDot.className = 'status-dot url-status-dot sd-red';
  } else if (problems > 0) {
    // 1-4 problems - orange
    statusDot.className = 'status-dot url-status-dot sd-orange';
  }

  console.log('Card status updated:', { oks, problems, totalTasks, class: statusDot.className });
}

// Function to show/hide observations section based on problems
function updateObservationsVisibility(card) {
  const taskContainers = card.querySelectorAll('.task-type-card');
  const observationsSection = card.querySelector('.observations-section');

  if (!observationsSection) return;

  let hasProblems = false;

  // Check if any task has problems
  taskContainers.forEach(container => {
    const problemBtn = container.querySelector('.task-btn-problem.active');
    if (problemBtn) {
      hasProblems = true;
    }
  });

  // Show/hide observations section
  if (hasProblems) {
    observationsSection.style.display = 'block';
  } else {
    observationsSection.style.display = 'none';
  }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Diccionario Personalizado - Agenda Renta4{% endblock %}

{% block content %}
<div class="content-header">
  <h1>üìñ Diccionario Personalizado</h1>
  <p class="subtitle">Gesti√≥n de palabras personalizadas para el corrector ortogr√°fico</p>
</div>

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  <div class="stat-card">
    <div class="stat-value">{{ stats.total_words }}</div>
    <div class="stat-label">Palabras en Diccionario</div>
  </div>
  <div class="stat-card">
    <div class="stat-value">{{ candidates|length }}</div>
    <div class="stat-label">Candidatas para Revisar</div>
  </div>
  <div class="stat-card">
    <div class="stat-value">{{ stats.added_last_week }}</div>
    <div class="stat-label">A√±adidas Esta Semana</div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs-container" style="margin-bottom: 30px;">
  <button class="tab-button active" data-tab="candidates">
    üîç Candidatas ({{ candidates|length }})
  </button>
  <button class="tab-button" data-tab="dictionary">
    üìñ Diccionario ({{ stats.total_words }})
  </button>
  <button class="tab-button" data-tab="manual">
    ‚ûï A√±adir Manualmente
  </button>
</div>

<!-- Tab: Candidates -->
<div id="tab-candidates" class="tab-content active">
  <div class="card">
    <div class="card-header">
      <h2>üîç Palabras Candidatas</h2>
      <p style="margin: 5px 0 0 0; color: var(--text-muted); font-size: 14px;">
        Palabras marcadas como errores que podr√≠an ser correctas
      </p>
    </div>
    <div class="card-body">
      {% if candidates %}
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Palabra</th>
                <th>Frecuencia</th>
                <th>URLs de Ejemplo</th>
                <th style="text-align: center; width: 120px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for candidate in candidates %}
              <tr>
                <td><strong>{{ candidate.word }}</strong></td>
                <td>{{ candidate.frequency }} veces</td>
                <td style="font-size: 12px; color: var(--text-muted); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ candidate.example_urls or 'N/A' }}
                </td>
                <td style="text-align: center;">
                  <button
                    class="btn btn-small btn-success add-candidate-btn"
                    data-word="{{ candidate.word }}"
                    data-frequency="{{ candidate.frequency }}"
                    title="A√±adir al diccionario"
                  >
                    ‚úì A√±adir
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <p>‚úÖ No hay palabras candidatas para revisar</p>
          <p style="font-size: 14px; color: var(--text-muted);">
            Las palabras aparecer√°n aqu√≠ cuando se detecten errores ortogr√°ficos frecuentes
          </p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Tab: Dictionary -->
<div id="tab-dictionary" class="tab-content">
  <div class="card">
    <div class="card-header">
      <h2>üìñ Palabras en el Diccionario</h2>
      <p style="margin: 5px 0 0 0; color: var(--text-muted); font-size: 14px;">
        {{ stats.total_words }} palabras personalizadas
      </p>
    </div>
    <div class="card-body">
      {% if dictionary_words %}
        <!-- Category Filter -->
        <div style="margin-bottom: 20px;">
          <label style="font-weight: 600; margin-right: 10px;">Filtrar por categor√≠a:</label>
          <select id="category-filter" class="form-control" style="display: inline-block; width: auto;">
            <option value="">Todas</option>
            {% for category, count in stats.by_category.items() %}
              <option value="{{ category }}">{{ category|capitalize }} ({{ count }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="table-container">
          <table class="data-table" id="dictionary-table">
            <thead>
              <tr>
                <th>Palabra</th>
                <th>Categor√≠a</th>
                <th>Frecuencia</th>
                <th>A√±adida</th>
                <th>Notas</th>
                <th style="text-align: center; width: 100px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for word in dictionary_words %}
              <tr data-category="{{ word.category }}">
                <td><strong>{{ word.word }}</strong></td>
                <td><span class="badge badge-{{ word.category }}">{{ word.category }}</span></td>
                <td>{{ word.frequency }}</td>
                <td style="font-size: 12px; color: var(--text-muted);">
                  {{ word.approved_at.strftime('%Y-%m-%d') if word.approved_at else 'N/A' }}
                </td>
                <td style="font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ word.notes or '-' }}
                </td>
                <td style="text-align: center;">
                  <button
                    class="btn btn-small btn-danger remove-word-btn"
                    data-word-id="{{ word.id }}"
                    data-word="{{ word.word }}"
                    title="Eliminar del diccionario"
                  >
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <p>üìö El diccionario est√° vac√≠o</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Tab: Manual Add -->
<div id="tab-manual" class="tab-content">
  <div class="card" style="max-width: 600px;">
    <div class="card-header">
      <h2>‚ûï A√±adir Palabra Manualmente</h2>
    </div>
    <div class="card-body">
      <form id="manual-add-form">
        <div class="form-group">
          <label for="manual-word">Palabra *</label>
          <input
            type="text"
            id="manual-word"
            name="word"
            class="form-control"
            required
            placeholder="Ej: blockchain, startup, etc."
          />
        </div>

        <div class="form-group">
          <label for="manual-category">Categor√≠a</label>
          <select id="manual-category" name="category" class="form-control">
            <option value="other">Otra</option>
            <option value="technical">T√©cnica</option>
            <option value="geographic">Geogr√°fica</option>
            <option value="brand">Marca</option>
            <option value="financial">Financiera</option>
            <option value="verb">Verbo</option>
            <option value="variant">Variante</option>
          </select>
        </div>

        <div class="form-group">
          <label for="manual-notes">Notas (opcional)</label>
          <textarea
            id="manual-notes"
            name="notes"
            class="form-control"
            rows="3"
            placeholder="Ej: T√©rmino t√©cnico com√∫n en finanzas..."
          ></textarea>
        </div>

        <button type="submit" class="btn btn-primary">
          ‚úì A√±adir al Diccionario
        </button>
      </form>
    </div>
  </div>
</div>

<style>
.tabs-container {
  display: flex;
  gap: 10px;
  border-bottom: 2px solid var(--border);
}

.tab-button {
  padding: 12px 20px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-weight: 600;
  color: var(--text-muted);
  transition: all 0.2s;
}

.tab-button:hover {
  color: var(--text);
  background: var(--hover);
}

.tab-button.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.stat-label {
  font-size: 14px;
  color: var(--text-muted);
  font-weight: 500;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-technical { background: #e3f2fd; color: #1976d2; }
.badge-geographic { background: #f3e5f5; color: #7b1fa2; }
.badge-brand { background: #fff3e0; color: #e65100; }
.badge-financial { background: #e8f5e9; color: #2e7d32; }
.badge-verb { background: #fce4ec; color: #c2185b; }
.badge-variant { background: #f1f8e9; color: #558b2f; }
.badge-other { background: #f5f5f5; color: #616161; }

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}

.empty-state p:first-child {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 10px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text);
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  background: var(--card-bg);
  color: var(--text);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>

<script>
// Tab switching
document.querySelectorAll('.tab-button').forEach(button => {
  button.addEventListener('click', () => {
    const tabName = button.dataset.tab;

    // Update buttons
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    button.classList.add('active');

    // Update content
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
  });
});

// Category filter
const categoryFilter = document.getElementById('category-filter');
if (categoryFilter) {
  categoryFilter.addEventListener('change', (e) => {
    const category = e.target.value;
    const rows = document.querySelectorAll('#dictionary-table tbody tr');

    rows.forEach(row => {
      if (!category || row.dataset.category === category) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
}

// Add candidate word
document.querySelectorAll('.add-candidate-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const word = btn.dataset.word;
    const frequency = btn.dataset.frequency;

    if (!confirm(`¬øA√±adir "${word}" al diccionario personalizado?`)) {
      return;
    }

    try {
      const formData = new FormData();
      formData.append('word', word);
      formData.append('frequency', frequency);
      formData.append('category', 'other');
      formData.append('notes', 'A√±adida desde candidatas');

      const response = await fetch('{{ url_for("add_custom_word") }}', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        alert(`‚úì Palabra "${word}" a√±adida correctamente`);
        location.reload();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (error) {
      alert(`Error: ${error.message}`);
    }
  });
});

// Remove word
document.querySelectorAll('.remove-word-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const wordId = btn.dataset.wordId;
    const word = btn.dataset.word;

    if (!confirm(`¬øEliminar "${word}" del diccionario?`)) {
      return;
    }

    try {
      const response = await fetch(`{{ url_for("remove_custom_word", word_id=0) }}`.replace('0', wordId), {
        method: 'POST'
      });

      const result = await response.json();

      if (result.success) {
        alert(`‚úì Palabra "${word}" eliminada correctamente`);
        location.reload();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (error) {
      alert(`Error: ${error.message}`);
    }
  });
});

// Manual add form
document.getElementById('manual-add-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  formData.append('frequency', '0');

  try {
    const response = await fetch('{{ url_for("add_custom_word") }}', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      alert(`‚úì Palabra "${formData.get('word')}" a√±adida correctamente`);
      location.reload();
    } else {
      alert(`Error: ${result.error}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Herramientas de Análisis Automático - Agenda Renta4{% endblock %}

{% block content %}
<!-- ===============================================================
     Page Header
     =============================================================== -->
<div class="page-header">
  <h1 class="page-title">Herramientas de Análisis Automático</h1>
  <p class="page-description">
    Configura los análisis que se ejecutarán automáticamente después de cada crawl
  </p>
</div>

<!-- ===============================================================
     HERRAMIENTAS DE ANÁLISIS AUTOMÁTICAS
     =============================================================== -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <h2 style="margin: 0 0 var(--space-sm) 0; font-size: var(--text-xl); color: var(--text); font-weight: var(--font-bold); display: flex; align-items: center; gap: var(--space-sm);">
    <i data-lucide="settings" class="icon-md"></i>
    <span>Configuración de Análisis Automáticos</span>
  </h2>
  <p style="color: var(--muted); margin-bottom: var(--space-xl); font-size: var(--text-sm);">
    Activa y configura qué análisis se ejecutarán de forma automática.
  </p>

  <div id="quality-checks-config">
    <!-- Checks will be loaded dynamically -->
    <div style="text-align: center; padding: var(--space-2xl); color: var(--muted);">
      <i data-lucide="loader" class="icon-2xl" style="margin-bottom: var(--space-md); opacity: 0.5;"></i>
      <div>Cargando configuración...</div>
    </div>
  </div>

  <div style="text-align: right; margin-top: var(--space-xl);">
    <button id="save-checks-config" class="btn primary" onclick="saveQualityChecksConfig()" style="display: none;">
      <i data-lucide="save" class="icon-xs"></i>
      <span>Guardar Configuración de Análisis</span>
    </button>
  </div>

  <div class="card" style="margin-top: var(--space-lg); background: var(--bg-secondary); border-left: 4px solid var(--primary);">
    <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
      <i data-lucide="info" class="icon-md" style="color: var(--primary); flex-shrink: 0;"></i>
      <div>
        <strong style="color: var(--text); display: block; margin-bottom: var(--space-xs);">Información importante:</strong>
        <ul style="margin: 0; padding-left: var(--space-lg); font-size: var(--text-sm); line-height: 1.8; color: var(--text-secondary);">
          <li>Los análisis automáticos se ejecutan en segundo plano después de cada crawl</li>
          <li>También puedes ejecutar análisis manualmente desde los resultados del crawl</li>
          <li>Los análisis pueden tardar varios minutos según la cantidad de URLs</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
  loadQualityChecksConfig();
});

// ============================================================
// QUALITY CHECKS CONFIGURATION
// ============================================================

function loadQualityChecksConfig() {
  fetch('/crawler/config/checks', {
    credentials: 'same-origin'
  })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      return response.json();
    })
    .then(data => {
      if (!data) return; // Redirected case

      if (data.success) {
        renderQualityChecksConfig(data.checks);
      } else {
        document.getElementById('quality-checks-config').innerHTML =
          '<div style="color: var(--danger); padding: var(--space-2xl); text-align: center;"><i data-lucide="x-circle" class="icon-lg" style="margin-bottom: var(--space-sm);"></i><div>Error al cargar configuración</div></div>';
        lucide.createIcons();
      }
    })
    .catch(error => {
      console.error('Error loading quality checks config:', error);
      document.getElementById('quality-checks-config').innerHTML =
        '<div style="color: var(--danger); padding: var(--space-2xl); text-align: center;"><i data-lucide="x-circle" class="icon-lg" style="margin-bottom: var(--space-sm);"></i><div>Error al cargar configuración</div></div>';
      lucide.createIcons();
    });
}

function renderQualityChecksConfig(checks) {
  const container = document.getElementById('quality-checks-config');

  if (!checks || checks.length === 0) {
    container.innerHTML = '<div style="color: var(--muted); padding: var(--space-2xl); text-align: center;">No hay checks disponibles</div>';
    return;
  }

  let html = '<div style="display: flex; flex-direction: column; gap: var(--space-lg);">';

  checks.forEach(check => {
    const unavailableClass = !check.available ? ' style="opacity: 0.5;"' : '';
    const disabledAttr = !check.available ? ' disabled' : '';

    html += `
      <div class="notification-option"${unavailableClass}>
        <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--space-lg);">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
              <i data-lucide="${check.icon_name || 'check-square'}" class="icon-md"></i>
              <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-lg);">${check.name}</span>
              ${!check.available ? '<span class="badge badge-warning">Próximamente</span>' : ''}
            </div>
            <div style="color: var(--muted); font-size: var(--text-sm); margin-bottom: var(--space-md);">
              ${check.description}
            </div>

            <!-- Auto-run checkbox -->
            <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; opacity: ${check.enabled ? '1' : '0.5'}; margin-bottom: var(--space-md);">
              <input
                type="checkbox"
                class="check-auto-run"
                data-check-type="${check.check_type}"
                ${check.run_after_crawl ? 'checked' : ''}
                ${!check.enabled || !check.available ? 'disabled' : ''}
                style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: var(--text-sm); color: var(--text);">Ejecutar automáticamente después de cada crawl</span>
            </label>

            <!-- Scope radio buttons -->
            <div class="check-scope-selector" data-check-type="${check.check_type}" style="display: flex; gap: var(--space-xl); padding-left: 26px; opacity: ${check.enabled ? '1' : '0.5'};">
              <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; font-size: var(--text-sm);">
                <input
                  type="radio"
                  name="scope_${check.check_type}"
                  value="priority"
                  class="check-scope"
                  data-check-type="${check.check_type}"
                  ${check.scope === 'priority' ? 'checked' : ''}
                  ${!check.enabled || !check.available ? 'disabled' : ''}
                  style="width: 16px; height: 16px; cursor: pointer;">
                <span style="color: var(--text); display: flex; align-items: center; gap: var(--space-xs);">
                  <i data-lucide="star" class="icon-xs"></i>
                  Solo URLs Priority (117)
                </span>
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; font-size: var(--text-sm);">
                <input
                  type="radio"
                  name="scope_${check.check_type}"
                  value="all"
                  class="check-scope"
                  data-check-type="${check.check_type}"
                  ${check.scope === 'all' ? 'checked' : ''}
                  ${!check.enabled || !check.available ? 'disabled' : ''}
                  style="width: 16px; height: 16px; cursor: pointer;">
                <span style="color: var(--text); display: flex; align-items: center; gap: var(--space-xs);">
                  <i data-lucide="globe" class="icon-xs"></i>
                  Todas las URLs (~2,800)
                </span>
              </label>
            </div>
          </div>
          <label class="toggle-switch">
            <input
              type="checkbox"
              class="check-enabled"
              data-check-type="${check.check_type}"
              ${check.enabled ? 'checked' : ''}
              ${disabledAttr}
              onchange="toggleCheckEnabled('${check.check_type}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    `;
  });

  html += '</div>';
  container.innerHTML = html;

  // Initialize icons and show save button
  lucide.createIcons();
  document.getElementById('save-checks-config').style.display = 'inline-flex';
}

function toggleCheckEnabled(checkType, enabled) {
  // Enable/disable auto-run checkbox based on toggle state
  const autoRunCheckbox = document.querySelector(`.check-auto-run[data-check-type="${checkType}"]`);
  if (autoRunCheckbox) {
    if (enabled) {
      // Enable the auto-run checkbox
      autoRunCheckbox.disabled = false;
      autoRunCheckbox.parentElement.style.opacity = '1';
      autoRunCheckbox.parentElement.style.cursor = 'pointer';
    } else {
      // Disable and uncheck auto-run checkbox
      autoRunCheckbox.disabled = true;
      autoRunCheckbox.checked = false;
      autoRunCheckbox.parentElement.style.opacity = '0.5';
      autoRunCheckbox.parentElement.style.cursor = 'not-allowed';
    }
  }

  // Enable/disable scope radio buttons
  const scopeSelector = document.querySelector(`.check-scope-selector[data-check-type="${checkType}"]`);
  const scopeRadios = document.querySelectorAll(`.check-scope[data-check-type="${checkType}"]`);

  if (scopeSelector && scopeRadios.length > 0) {
    if (enabled) {
      // Enable scope selection
      scopeSelector.style.opacity = '1';
      scopeRadios.forEach(radio => {
        radio.disabled = false;
        radio.parentElement.style.cursor = 'pointer';
      });
    } else {
      // Disable scope selection
      scopeSelector.style.opacity = '0.5';
      scopeRadios.forEach(radio => {
        radio.disabled = true;
        radio.parentElement.style.cursor = 'not-allowed';
      });
    }
  }
}

function saveQualityChecksConfig() {
  const button = document.getElementById('save-checks-config');
  const icon = button.querySelector('i');
  const span = button.querySelector('span');
  const originalText = span.textContent;

  button.disabled = true;
  icon.setAttribute('data-lucide', 'loader');
  span.textContent = 'Guardando...';
  lucide.createIcons();

  // Collect all check configurations
  const enabledCheckboxes = document.querySelectorAll('.check-enabled');
  const autoRunCheckboxes = document.querySelectorAll('.check-auto-run');
  const scopeRadios = document.querySelectorAll('.check-scope:checked');

  const configs = [];
  enabledCheckboxes.forEach((checkbox, index) => {
    const checkType = checkbox.dataset.checkType;
    const enabled = checkbox.checked;
    const autoRunCheckbox = Array.from(autoRunCheckboxes).find(cb => cb.dataset.checkType === checkType);
    const runAfterCrawl = autoRunCheckbox ? autoRunCheckbox.checked : false;

    // Get scope for this check type
    const scopeRadio = Array.from(scopeRadios).find(r => r.dataset.checkType === checkType);
    const scope = scopeRadio ? scopeRadio.value : 'priority';

    configs.push({
      check_type: checkType,
      enabled: enabled,
      run_after_crawl: runAfterCrawl,
      scope: scope
    });
  });

  // Save each config
  let savePromises = configs.map(config =>
    fetch('/crawler/config/checks', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(config)
    })
  );

  Promise.all(savePromises)
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(results => {
      const allSuccess = results.every(r => r.success);

      if (allSuccess) {
        alert('✅ Configuración guardada correctamente');
      } else {
        alert('⚠️ Hubo algunos errores al guardar la configuración');
      }

      button.disabled = false;
      icon.setAttribute('data-lucide', 'save');
      span.textContent = originalText;
      lucide.createIcons();
    })
    .catch(error => {
      console.error('Error saving config:', error);
      alert('❌ Error al guardar la configuración');
      button.disabled = false;
      icon.setAttribute('data-lucide', 'save');
      span.textContent = originalText;
      lucide.createIcons();
    });
}
</script>

<style>
/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--muted);
  transition: 0.3s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: var(--bg);
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.notification-option {
  padding: var(--space-lg);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg);
  transition: all 0.2s ease;
}

.notification-option:hover {
  border-color: var(--primary);
  background: var(--bg-secondary);
}
</style>
{% endblock %}

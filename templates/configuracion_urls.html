{% extends "base.html" %}

{% block title %}GestiÃ³n de URLs - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">GestiÃ³n de URLs</div>

<!-- ============================================================
     GESTIÃ“N DE URLs
     ============================================================ -->
<div class="panel">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    ğŸŒ URLs para RevisiÃ³n PeriÃ³dica
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    AÃ±ade, edita o elimina las URLs que deseas revisar periÃ³dicamente.
  </p>

  <!-- Formulario para agregar nueva URL -->
  <div class="panel" style="margin-bottom: 20px; background: var(--card); border: 1px solid var(--border);">
    <h3 style="margin: 0 0 12px; font-size: 15px; font-weight: 600;">â• AÃ±adir Nueva URL</h3>
    <form id="form-add-url" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label class="label">Nombre</label>
        <input
          type="text"
          name="name"
          id="new-url-name"
          class="input"
          placeholder="Ej: PÃ¡gina de inicio"
          required
          style="width: 100%;">
      </div>
      <div style="flex: 2; min-width: 300px;">
        <label class="label">URL</label>
        <input
          type="url"
          name="url"
          id="new-url-url"
          class="input"
          placeholder="https://ejemplo.com/pagina"
          required
          style="width: 100%;">
      </div>
      <button type="submit" class="btn primary" style="white-space: nowrap;">
        â• AÃ±adir URL
      </button>
    </form>
  </div>

  <!-- Lista de URLs existentes -->
  <div class="table">
    <table id="urls-table">
      <thead>
        <tr>
          <th style="width: 25%">Nombre</th>
          <th style="width: 40%">URL</th>
          <th style="width: 12%; text-align: center;">Estado</th>
          <th style="width: 23%; text-align: right;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr data-url-id="{{ section.id }}" class="url-row">
          <td>
            <span class="url-name">{{ section.name }}</span>
            <input
              type="text"
              class="input url-name-edit"
              value="{{ section.name }}"
              style="display: none; width: 100%;">
          </td>
          <td>
            <span class="url-url" style="word-break: break-all;">{{ section.url }}</span>
            <input
              type="url"
              class="input url-url-edit"
              value="{{ section.url }}"
              style="display: none; width: 100%;">
          </td>
          <td style="text-align: center;">
            <span class="badge {% if section.active %}bd-done{% else %}bd-pend{% endif %}">
              {% if section.active %}âœ… Activa{% else %}â¸ï¸ Inactiva{% endif %}
            </span>
          </td>
          <td style="text-align: right;">
            <div class="url-actions">
              <button class="btn ghost btn-edit" onclick="editUrl({{ section.id }})" title="Editar">
                âœï¸
              </button>
              <button class="btn ghost btn-toggle" onclick="toggleUrl({{ section.id }})" title="Activar/Desactivar">
                {% if section.active %}â¸ï¸{% else %}â–¶ï¸{% endif %}
              </button>
              <button class="btn ghost btn-delete" onclick="deleteUrl({{ section.id }})" title="Eliminar" style="color: var(--danger);">
                ğŸ—‘ï¸
              </button>
              <button class="btn primary btn-save" onclick="saveUrl({{ section.id }})" style="display: none;">
                ğŸ’¾ Guardar
              </button>
              <button class="btn ghost btn-cancel" onclick="cancelEdit({{ section.id }})" style="display: none;">
                âŒ Cancelar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top: 14px; color: var(--muted); background: transparent; border: none; padding: 0;">
    <strong>ğŸ’¡ Nota:</strong>
    <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9em;">
      <li>Las URLs inactivas no aparecerÃ¡n en la pÃ¡gina de Inicio ni contarÃ¡n para tareas pendientes</li>
      <li>Solo puedes eliminar URLs que no tengan tareas asociadas</li>
      <li>Puedes desactivar temporalmente una URL sin eliminarla</li>
    </ul>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// CRUD DE URLs
// ============================================================

// AÃ±adir nueva URL
document.getElementById('form-add-url').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch('{{ url_for("config.add_url") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ' + data.message);
      location.reload(); // Recargar para mostrar la nueva URL
    } else {
      alert('âŒ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('âŒ Error al aÃ±adir la URL');
  });
});

// Editar URL
function editUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);

  // Ocultar spans y mostrar inputs
  row.querySelector('.url-name').style.display = 'none';
  row.querySelector('.url-name-edit').style.display = 'block';
  row.querySelector('.url-url').style.display = 'none';
  row.querySelector('.url-url-edit').style.display = 'block';

  // Ocultar botones normales y mostrar botones de guardar/cancelar
  row.querySelector('.btn-edit').style.display = 'none';
  row.querySelector('.btn-toggle').style.display = 'none';
  row.querySelector('.btn-delete').style.display = 'none';
  row.querySelector('.btn-save').style.display = 'inline-block';
  row.querySelector('.btn-cancel').style.display = 'inline-block';
}

// Guardar ediciÃ³n
function saveUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);
  const name = row.querySelector('.url-name-edit').value;
  const url = row.querySelector('.url-url-edit').value;

  const formData = new FormData();
  formData.append('name', name);
  formData.append('url', url);

  fetch(`/configuracion/url/edit/${urlId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ' + data.message);
      location.reload();
    } else {
      alert('âŒ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('âŒ Error al guardar los cambios');
  });
}

// Cancelar ediciÃ³n
function cancelEdit(urlId) {
  location.reload();
}

// Activar/Desactivar URL
function toggleUrl(urlId) {
  if (!confirm('Â¿Seguro que quieres cambiar el estado de esta URL?')) {
    return;
  }

  fetch(`/configuracion/url/toggle/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ' + data.message);
      location.reload();
    } else {
      alert('âŒ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('âŒ Error al cambiar el estado');
  });
}

// Eliminar URL
function deleteUrl(urlId) {
  if (!confirm('Â¿Seguro que quieres eliminar esta URL? Esta acciÃ³n no se puede deshacer.')) {
    return;
  }

  fetch(`/configuracion/url/delete/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('âœ… ' + data.message);
      location.reload();
    } else {
      alert('âŒ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('âŒ Error al eliminar la URL');
  });
}
</script>
{% endblock %}

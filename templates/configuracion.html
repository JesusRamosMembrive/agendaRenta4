{% extends "base.html" %}

{% block title %}Configuraci√≥n - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">Configuraci√≥n ‚Äî Ajustes del sistema</div>

<!-- ============================================================
     SECCI√ìN 1: ALERTAS DE TAREAS
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    ‚è∞ Alertas de Tareas
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Configura la frecuencia de las alertas para cada tipo de tarea. Las alertas te recordar√°n cu√°ndo debes revisar cada categor√≠a.
  </p>

  <div class="panel" style="margin-bottom: 16px; background: rgba(91, 140, 255, 0.1); border-left: 3px solid var(--primary); padding: 12px;">
    <strong style="color: var(--primary);">üí° Nota sobre d√≠as del mes:</strong>
    <p style="margin: 6px 0 0 0; font-size: 13px; color: var(--muted);">
      Si configuras una alerta para el d√≠a 29, 30 o 31 y el mes no tiene esos d√≠as, la alerta se generar√° el √∫ltimo d√≠a disponible del mes.
      Por ejemplo, si configuras d√≠a 31 en febrero, la alerta se generar√° el 28 (o 29 en a√±os bisiestos).
    </p>
  </div>

  <form id="form-alerts">
    <div class="table" style="margin-bottom: 16px;">
      <table>
        <thead>
          <tr>
            <th style="width: 30%">Tipo de Tarea</th>
            <th style="width: 25%">Frecuencia de Alerta</th>
            <th style="width: 25%">D√≠a de Aviso</th>
            <th style="width: 15%; text-align: center;">Activada</th>
          </tr>
        </thead>
        <tbody>
          {% for task_type in task_types %}
          <tr data-task-type-id="{{ task_type.id }}">
            <td>
              <strong>{{ task_type.display_name }}</strong>
              <div style="color: var(--muted); font-size: 0.85em; margin-top: 4px;">
                Periodicidad base: {{ task_type.periodicity }}
              </div>
            </td>
            <td>
              <select
                class="select alert-frequency"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                onchange="updateDayOptions({{ task_type.id }}, this.value)">
                <option value="daily" {% if task_type.alert.alert_frequency == 'daily' %}selected{% endif %}>Diario</option>
                <option value="weekly" {% if task_type.alert.alert_frequency == 'weekly' %}selected{% endif %}>Semanal</option>
                <option value="biweekly" {% if task_type.alert.alert_frequency == 'biweekly' %}selected{% endif %}>Quincenal</option>
                <option value="monthly" {% if task_type.alert.alert_frequency == 'monthly' %}selected{% endif %}>Mensual</option>
                <option value="quarterly" {% if task_type.alert.alert_frequency == 'quarterly' %}selected{% endif %}>Trimestral</option>
                <option value="semiannual" {% if task_type.alert.alert_frequency == 'semiannual' %}selected{% endif %}>Semestral</option>
                <option value="annual" {% if task_type.alert.alert_frequency == 'annual' %}selected{% endif %}>Anual</option>
              </select>
            </td>
            <td>
              <select
                class="select alert-day"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                id="alert-day-{{ task_type.id }}">
                <!-- Options will be populated by JavaScript -->
              </select>
            </td>
            <td style="text-align: center;">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  class="alert-enabled"
                  data-task-type-id="{{ task_type.id }}"
                  {% if task_type.alert.enabled %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="text-align: right;">
      <button type="submit" class="btn primary">
        üíæ Guardar Configuraci√≥n de Alertas
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCI√ìN 2: TIPO DE NOTIFICACIONES
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üîî Tipo de Notificaciones
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Elige c√≥mo quieres recibir las notificaciones cuando haya alertas pendientes.
  </p>

  <form id="form-notifications">
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <!-- Notificaci√≥n en App -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_in_app"
            id="enable_in_app"
            {% if notification_prefs.enable_in_app %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üîî Notificaci√≥n en la aplicaci√≥n
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Ver√°s un contador de notificaciones en la barra superior de la aplicaci√≥n
            </div>
          </div>
        </label>
      </div>

      <!-- Notificaci√≥n de Escritorio -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_desktop"
            id="enable_desktop"
            {% if notification_prefs.enable_desktop %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üñ•Ô∏è Notificaci√≥n de escritorio
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Recibir√°s notificaciones del sistema operativo (requiere permiso del navegador)
            </div>
          </div>
        </label>
      </div>

      <!-- Correo Electr√≥nico -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_email"
            id="enable_email"
            {% if notification_prefs.enable_email %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
              ‚úâÔ∏è Correo electr√≥nico
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-bottom: 8px;">
              Recibir√°s emails con las alertas pendientes
            </div>
            <input
              type="email"
              name="email"
              id="email"
              class="input"
              placeholder="tu@email.com"
              value="{{ notification_prefs.email or '' }}"
              style="width: 100%; max-width: 400px;">
          </div>
        </label>
      </div>
    </div>

    <div style="text-align: right; margin-top: 20px;">
      <button type="submit" class="btn primary">
        üíæ Guardar Preferencias de Notificaci√≥n
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCI√ìN 3: GESTI√ìN DE URLs
     ============================================================ -->
<div class="panel">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üåê Gesti√≥n de URLs
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    A√±ade, edita o elimina las URLs que deseas revisar peri√≥dicamente.
  </p>

  <!-- Formulario para agregar nueva URL -->
  <div class="panel" style="margin-bottom: 20px; background: var(--card); border: 1px solid var(--border);">
    <h3 style="margin: 0 0 12px; font-size: 15px; font-weight: 600;">‚ûï A√±adir Nueva URL</h3>
    <form id="form-add-url" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label class="label">Nombre</label>
        <input
          type="text"
          name="name"
          id="new-url-name"
          class="input"
          placeholder="Ej: P√°gina de inicio"
          required
          style="width: 100%;">
      </div>
      <div style="flex: 2; min-width: 300px;">
        <label class="label">URL</label>
        <input
          type="url"
          name="url"
          id="new-url-url"
          class="input"
          placeholder="https://ejemplo.com/pagina"
          required
          style="width: 100%;">
      </div>
      <button type="submit" class="btn primary" style="white-space: nowrap;">
        ‚ûï A√±adir URL
      </button>
    </form>
  </div>

  <!-- Lista de URLs existentes -->
  <div class="table">
    <table id="urls-table">
      <thead>
        <tr>
          <th style="width: 25%">Nombre</th>
          <th style="width: 40%">URL</th>
          <th style="width: 12%; text-align: center;">Estado</th>
          <th style="width: 23%; text-align: right;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr data-url-id="{{ section.id }}" class="url-row">
          <td>
            <span class="url-name">{{ section.name }}</span>
            <input
              type="text"
              class="input url-name-edit"
              value="{{ section.name }}"
              style="display: none; width: 100%;">
          </td>
          <td>
            <span class="url-url" style="word-break: break-all;">{{ section.url }}</span>
            <input
              type="url"
              class="input url-url-edit"
              value="{{ section.url }}"
              style="display: none; width: 100%;">
          </td>
          <td style="text-align: center;">
            <span class="badge {% if section.active %}bd-done{% else %}bd-pend{% endif %}">
              {% if section.active %}‚úÖ Activa{% else %}‚è∏Ô∏è Inactiva{% endif %}
            </span>
          </td>
          <td style="text-align: right;">
            <div class="url-actions">
              <button class="btn ghost btn-edit" onclick="editUrl({{ section.id }})" title="Editar">
                ‚úèÔ∏è
              </button>
              <button class="btn ghost btn-toggle" onclick="toggleUrl({{ section.id }})" title="Activar/Desactivar">
                {% if section.active %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}
              </button>
              <button class="btn ghost btn-delete" onclick="deleteUrl({{ section.id }})" title="Eliminar" style="color: var(--danger);">
                üóëÔ∏è
              </button>
              <button class="btn primary btn-save" onclick="saveUrl({{ section.id }})" style="display: none;">
                üíæ Guardar
              </button>
              <button class="btn ghost btn-cancel" onclick="cancelEdit({{ section.id }})" style="display: none;">
                ‚ùå Cancelar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top: 14px; color: #6b7280; background: transparent; border: none; padding: 0;">
    <strong>üí° Nota:</strong>
    <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9em;">
      <li>Las URLs inactivas no aparecer√°n en la p√°gina de Inicio ni contar√°n para tareas pendientes</li>
      <li>Solo puedes eliminar URLs que no tengan tareas asociadas</li>
      <li>Puedes desactivar temporalmente una URL sin eliminarla</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// ALERTAS DE TAREAS
// ============================================================

// Datos iniciales de alert_day desde el backend
const initialAlertDays = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_day or "1" }}',
  {% endfor %}
};

// Datos iniciales de alert_frequency desde el backend
const initialAlertFrequencies = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_frequency }}',
  {% endfor %}
};

// Funci√≥n para actualizar opciones del selector de d√≠a seg√∫n frecuencia
function updateDayOptions(taskTypeId, frequency) {
  const daySelect = document.getElementById('alert-day-' + taskTypeId);
  const currentValue = daySelect.value;

  // Limpiar opciones actuales
  daySelect.innerHTML = '';

  if (frequency === 'daily') {
    // Para diario, no necesita d√≠a espec√≠fico
    daySelect.disabled = true;
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Todos los d√≠as';
    daySelect.appendChild(option);
  } else if (frequency === 'weekly' || frequency === 'biweekly') {
    // Para semanal/quincenal: d√≠as de la semana
    daySelect.disabled = false;
    const daysOfWeek = [
      { value: 'monday', text: 'Lunes' },
      { value: 'tuesday', text: 'Martes' },
      { value: 'wednesday', text: 'Mi√©rcoles' },
      { value: 'thursday', text: 'Jueves' },
      { value: 'friday', text: 'Viernes' },
      { value: 'saturday', text: 'S√°bado' },
      { value: 'sunday', text: 'Domingo' }
    ];

    daysOfWeek.forEach(day => {
      const option = document.createElement('option');
      option.value = day.value;
      option.textContent = day.text;
      if (currentValue === day.value) {
        option.selected = true;
      }
      daySelect.appendChild(option);
    });

    // Si no hay valor seleccionado, seleccionar lunes por defecto
    if (!currentValue || !['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].includes(currentValue)) {
      daySelect.value = 'monday';
    }
  } else {
    // Para mensual/trimestral/semestral/anual: d√≠as del mes (1-31)
    daySelect.disabled = false;
    for (let i = 1; i <= 31; i++) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = 'D√≠a ' + i;
      if (currentValue === i.toString()) {
        option.selected = true;
      }
      daySelect.appendChild(option);
    }

    // Si no hay valor seleccionado, seleccionar d√≠a 1 por defecto
    if (!currentValue || isNaN(parseInt(currentValue))) {
      daySelect.value = '1';
    }
  }
}

// Inicializar selectores de d√≠a al cargar la p√°gina
function initializeDaySelectors() {
  {% for task_type in task_types %}
  updateDayOptions({{ task_type.id }}, '{{ task_type.alert.alert_frequency }}');
  // Restaurar el valor guardado
  const daySelect{{ task_type.id }} = document.getElementById('alert-day-{{ task_type.id }}');
  if (daySelect{{ task_type.id }} && !daySelect{{ task_type.id }}.disabled) {
    daySelect{{ task_type.id }}.value = initialAlertDays[{{ task_type.id }}] || daySelect{{ task_type.id }}.value;
  }
  {% endfor %}
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', initializeDaySelectors);

document.getElementById('form-alerts').addEventListener('submit', function(e) {
  e.preventDefault();

  const alertsData = [];
  const rows = document.querySelectorAll('#form-alerts tbody tr');

  rows.forEach(row => {
    const taskTypeId = row.dataset.taskTypeId;
    const frequency = row.querySelector('.alert-frequency').value;
    const daySelect = document.getElementById('alert-day-' + taskTypeId);
    const day = daySelect.disabled ? null : daySelect.value;
    const enabled = row.querySelector('.alert-enabled').checked;

    alertsData.push({
      task_type_id: parseInt(taskTypeId),
      alert_frequency: frequency,
      alert_day: day,
      enabled: enabled
    });
  });

  fetch('{{ url_for("save_alert_settings") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(alertsData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar la configuraci√≥n');
  });
});

// ============================================================
// NOTIFICACIONES
// ============================================================
document.getElementById('form-notifications').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append('email', document.getElementById('email').value);
  formData.append('enable_email', document.getElementById('enable_email').checked);
  formData.append('enable_desktop', document.getElementById('enable_desktop').checked);
  formData.append('enable_in_app', document.getElementById('enable_in_app').checked);

  fetch('{{ url_for("save_notification_preferences") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);

      // Si se habilit√≥ notificaciones de escritorio, pedir permiso
      if (document.getElementById('enable_desktop').checked) {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar las preferencias');
  });
});

// ============================================================
// CRUD DE URLs
// ============================================================

// A√±adir nueva URL
document.getElementById('form-add-url').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch('{{ url_for("add_url") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload(); // Recargar para mostrar la nueva URL
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al a√±adir la URL');
  });
});

// Editar URL
function editUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);

  // Ocultar spans y mostrar inputs
  row.querySelector('.url-name').style.display = 'none';
  row.querySelector('.url-name-edit').style.display = 'block';
  row.querySelector('.url-url').style.display = 'none';
  row.querySelector('.url-url-edit').style.display = 'block';

  // Ocultar botones normales y mostrar botones de guardar/cancelar
  row.querySelector('.btn-edit').style.display = 'none';
  row.querySelector('.btn-toggle').style.display = 'none';
  row.querySelector('.btn-delete').style.display = 'none';
  row.querySelector('.btn-save').style.display = 'inline-block';
  row.querySelector('.btn-cancel').style.display = 'inline-block';
}

// Guardar edici√≥n
function saveUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);
  const name = row.querySelector('.url-name-edit').value;
  const url = row.querySelector('.url-url-edit').value;

  const formData = new FormData();
  formData.append('name', name);
  formData.append('url', url);

  fetch(`/configuracion/url/edit/${urlId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar los cambios');
  });
}

// Cancelar edici√≥n
function cancelEdit(urlId) {
  location.reload();
}

// Activar/Desactivar URL
function toggleUrl(urlId) {
  if (!confirm('¬øSeguro que quieres cambiar el estado de esta URL?')) {
    return;
  }

  fetch(`/configuracion/url/toggle/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al cambiar el estado');
  });
}

// Eliminar URL
function deleteUrl(urlId) {
  if (!confirm('¬øSeguro que quieres eliminar esta URL? Esta acci√≥n no se puede deshacer.')) {
    return;
  }

  fetch(`/configuracion/url/delete/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al eliminar la URL');
  });
}
</script>

<style>
/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #374151;
  transition: 0.3s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.notification-option {
  padding: 16px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--card);
  transition: all 0.2s ease;
}

.notification-option:hover {
  border-color: var(--primary);
  background: linear-gradient(180deg, var(--card), #0f1320);
}
</style>
{% endblock %}

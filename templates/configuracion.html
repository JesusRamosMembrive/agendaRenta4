{% extends "base.html" %}

{% block title %}Configuraci√≥n - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">Configuraci√≥n ‚Äî Ajustes del sistema</div>

<!-- ============================================================
     SECCI√ìN 1: ALERTAS DE TAREAS
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    ‚è∞ Alertas de Tareas
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Configura la frecuencia de las alertas para cada tipo de tarea. Las alertas te recordar√°n cu√°ndo debes revisar cada categor√≠a.
  </p>

  <div class="panel" style="margin-bottom: 16px; background: rgba(193, 83, 99, 0.1); border-left: 3px solid var(--primary); padding: 12px;">
    <strong style="color: var(--primary);">üí° Nota sobre d√≠as del mes:</strong>
    <p style="margin: 6px 0 0 0; font-size: 13px; color: var(--muted);">
      Si configuras una alerta para el d√≠a 29, 30 o 31 y el mes no tiene esos d√≠as, la alerta se generar√° el √∫ltimo d√≠a disponible del mes.
      Por ejemplo, si configuras d√≠a 31 en febrero, la alerta se generar√° el 28 (o 29 en a√±os bisiestos).
    </p>
  </div>

  <form id="form-alerts">
    <div class="table" style="margin-bottom: 16px;">
      <table>
        <thead>
          <tr>
            <th style="width: 30%">Tipo de Tarea</th>
            <th style="width: 25%">Frecuencia de Alerta</th>
            <th style="width: 25%">D√≠a de Aviso</th>
            <th style="width: 15%; text-align: center;">Activada</th>
          </tr>
        </thead>
        <tbody>
          {% for task_type in task_types %}
          <tr data-task-type-id="{{ task_type.id }}">
            <td>
              <strong>{{ task_type.display_name }}</strong>
              <div style="color: var(--muted); font-size: 0.85em; margin-top: 4px;">
                Periodicidad base: {{ task_type.periodicity }}
              </div>
            </td>
            <td>
              <select
                class="select alert-frequency"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                onchange="updateDayOptions({{ task_type.id }}, this.value)">
                <option value="daily" {% if task_type.alert.alert_frequency == 'daily' %}selected{% endif %}>Diario</option>
                <option value="weekly" {% if task_type.alert.alert_frequency == 'weekly' %}selected{% endif %}>Semanal</option>
                <option value="biweekly" {% if task_type.alert.alert_frequency == 'biweekly' %}selected{% endif %}>Quincenal</option>
                <option value="monthly" {% if task_type.alert.alert_frequency == 'monthly' %}selected{% endif %}>Mensual</option>
                <option value="quarterly" {% if task_type.alert.alert_frequency == 'quarterly' %}selected{% endif %}>Trimestral</option>
                <option value="semiannual" {% if task_type.alert.alert_frequency == 'semiannual' %}selected{% endif %}>Semestral</option>
                <option value="annual" {% if task_type.alert.alert_frequency == 'annual' %}selected{% endif %}>Anual</option>
              </select>
            </td>
            <td>
              <select
                class="select alert-day"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                id="alert-day-{{ task_type.id }}">
                <!-- Options will be populated by JavaScript -->
              </select>
            </td>
            <td style="text-align: center;">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  class="alert-enabled"
                  data-task-type-id="{{ task_type.id }}"
                  {% if task_type.alert.enabled %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="text-align: right;">
      <button type="submit" class="btn primary">
        üíæ Guardar Configuraci√≥n de Alertas
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCI√ìN 2: TIPO DE NOTIFICACIONES
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üîî Tipo de Notificaciones
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Elige c√≥mo quieres recibir las notificaciones cuando haya alertas pendientes.
  </p>

  <form id="form-notifications">
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <!-- Notificaci√≥n en App -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_in_app"
            id="enable_in_app"
            {% if notification_prefs.enable_in_app %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üîî Notificaci√≥n en la aplicaci√≥n
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Ver√°s un contador de notificaciones en la barra superior de la aplicaci√≥n
            </div>
          </div>
        </label>
      </div>

      <!-- Notificaci√≥n de Escritorio -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_desktop"
            id="enable_desktop"
            {% if notification_prefs.enable_desktop %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üñ•Ô∏è Notificaci√≥n de escritorio
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Recibir√°s notificaciones del sistema operativo (requiere permiso del navegador)
            </div>
          </div>
        </label>
      </div>

      <!-- Correo Electr√≥nico -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_email"
            id="enable_email"
            {% if notification_prefs.enable_email %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
              ‚úâÔ∏è Correo electr√≥nico
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-bottom: 8px;">
              Recibir√°s emails con las alertas pendientes
            </div>
            <input
              type="email"
              name="email"
              id="email"
              class="input"
              placeholder="tu@email.com"
              value="{{ notification_prefs.email or '' }}"
              style="width: 100%; max-width: 400px;">
          </div>
        </label>
      </div>
    </div>

    <div style="text-align: right; margin-top: 20px;">
      <button type="submit" class="btn primary">
        üíæ Guardar Preferencias de Notificaci√≥n
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCI√ìN 3: GESTI√ìN DE URLs
     ============================================================ -->
<div class="panel">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üåê Gesti√≥n de URLs
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    A√±ade, edita o elimina las URLs que deseas revisar peri√≥dicamente.
  </p>

  <!-- Formulario para agregar nueva URL -->
  <div class="panel" style="margin-bottom: 20px; background: var(--card); border: 1px solid var(--border);">
    <h3 style="margin: 0 0 12px; font-size: 15px; font-weight: 600;">‚ûï A√±adir Nueva URL</h3>
    <form id="form-add-url" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label class="label">Nombre</label>
        <input
          type="text"
          name="name"
          id="new-url-name"
          class="input"
          placeholder="Ej: P√°gina de inicio"
          required
          style="width: 100%;">
      </div>
      <div style="flex: 2; min-width: 300px;">
        <label class="label">URL</label>
        <input
          type="url"
          name="url"
          id="new-url-url"
          class="input"
          placeholder="https://ejemplo.com/pagina"
          required
          style="width: 100%;">
      </div>
      <button type="submit" class="btn primary" style="white-space: nowrap;">
        ‚ûï A√±adir URL
      </button>
    </form>
  </div>

  <!-- Lista de URLs existentes -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
    <div>
      <span id="selected-count" style="color: var(--muted); font-size: 14px;">0 URLs seleccionadas</span>
    </div>
    <button id="batch-check-btn" class="btn primary" onclick="runBatchQualityCheck()" disabled style="display: flex; align-items: center; gap: 8px;">
      <span>üñºÔ∏è</span>
      <span>Comprobar Seleccionadas</span>
    </button>
  </div>

  <div class="table">
    <table id="urls-table">
      <thead>
        <tr>
          <th style="width: 5%; text-align: center;">
            <input type="checkbox" id="select-all-urls" onchange="toggleSelectAll()" title="Seleccionar todas">
          </th>
          <th style="width: 23%">Nombre</th>
          <th style="width: 37%">URL</th>
          <th style="width: 12%; text-align: center;">Estado</th>
          <th style="width: 23%; text-align: right;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr data-url-id="{{ section.id }}" class="url-row">
          <td style="text-align: center;">
            <input type="checkbox" class="url-checkbox" data-section-id="{{ section.id }}" onchange="updateSelectedCount()">
          </td>
          <td>
            <span class="url-name">{{ section.name }}</span>
            <input
              type="text"
              class="input url-name-edit"
              value="{{ section.name }}"
              style="display: none; width: 100%;">
          </td>
          <td>
            <span class="url-url" style="word-break: break-all;">{{ section.url }}</span>
            <input
              type="url"
              class="input url-url-edit"
              value="{{ section.url }}"
              style="display: none; width: 100%;">
          </td>
          <td style="text-align: center;">
            <span class="badge {% if section.active %}bd-done{% else %}bd-pend{% endif %}">
              {% if section.active %}‚úÖ Activa{% else %}‚è∏Ô∏è Inactiva{% endif %}
            </span>
          </td>
          <td style="text-align: right;">
            <div class="url-actions">
              <button class="btn ghost btn-edit" onclick="editUrl({{ section.id }})" title="Editar">
                ‚úèÔ∏è
              </button>
              <button class="btn ghost btn-toggle" onclick="toggleUrl({{ section.id }})" title="Activar/Desactivar">
                {% if section.active %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}
              </button>
              <button class="btn ghost btn-delete" onclick="deleteUrl({{ section.id }})" title="Eliminar" style="color: var(--danger);">
                üóëÔ∏è
              </button>
              <button class="btn ghost" onclick="runQualityCheck({{ section.id }})" title="Check Calidad de Im√°genes">
                üñºÔ∏è
              </button>
              <button class="btn primary btn-save" onclick="saveUrl({{ section.id }})" style="display: none;">
                üíæ Guardar
              </button>
              <button class="btn ghost btn-cancel" onclick="cancelEdit({{ section.id }})" style="display: none;">
                ‚ùå Cancelar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top: 14px; color: var(--muted); background: transparent; border: none; padding: 0;">
    <strong>üí° Nota:</strong>
    <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9em;">
      <li>Las URLs inactivas no aparecer√°n en la p√°gina de Inicio ni contar√°n para tareas pendientes</li>
      <li>Solo puedes eliminar URLs que no tengan tareas asociadas</li>
      <li>Puedes desactivar temporalmente una URL sin eliminarla</li>
    </ul>
  </div>
</div>

<!-- ============================================================
     SECCI√ìN 4: HERRAMIENTAS DE AN√ÅLISIS AUTOM√ÅTICAS
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üîß Herramientas de An√°lisis Autom√°ticas
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Configura qu√© an√°lisis se ejecutar√°n autom√°ticamente despu√©s de cada crawl.
  </p>

  <div id="quality-checks-config">
    <!-- Checks will be loaded dynamically -->
    <div style="text-align: center; padding: 20px; color: var(--muted);">
      <div style="font-size: 24px; margin-bottom: 8px;">‚è≥</div>
      Cargando configuraci√≥n...
    </div>
  </div>

  <div style="text-align: right; margin-top: 20px;">
    <button id="save-checks-config" class="btn primary" onclick="saveQualityChecksConfig()" style="display: none;">
      üíæ Guardar Configuraci√≥n de An√°lisis
    </button>
  </div>

  <div class="panel" style="margin-top: 14px; color: var(--muted); background: transparent; border: none; padding: 0;">
    <strong>üí° Nota:</strong>
    <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9em;">
      <li>Los an√°lisis autom√°ticos se ejecutan en segundo plano despu√©s de cada crawl</li>
      <li>Tambi√©n puedes ejecutar an√°lisis manualmente desde los resultados del crawl</li>
      <li>Los an√°lisis pueden tardar varios minutos seg√∫n la cantidad de URLs</li>
    </ul>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// ALERTAS DE TAREAS
// ============================================================

// Datos iniciales de alert_day desde el backend
const initialAlertDays = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_day or "1" }}',
  {% endfor %}
};

// Datos iniciales de alert_frequency desde el backend
const initialAlertFrequencies = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_frequency }}',
  {% endfor %}
};

// Funci√≥n para actualizar opciones del selector de d√≠a seg√∫n frecuencia
function updateDayOptions(taskTypeId, frequency) {
  const daySelect = document.getElementById('alert-day-' + taskTypeId);
  const currentValue = daySelect.value;

  // Limpiar opciones actuales
  daySelect.innerHTML = '';

  if (frequency === 'daily') {
    // Para diario, no necesita d√≠a espec√≠fico
    daySelect.disabled = true;
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Todos los d√≠as';
    daySelect.appendChild(option);
  } else if (frequency === 'weekly' || frequency === 'biweekly') {
    // Para semanal/quincenal: d√≠as de la semana
    daySelect.disabled = false;
    const daysOfWeek = [
      { value: 'monday', text: 'Lunes' },
      { value: 'tuesday', text: 'Martes' },
      { value: 'wednesday', text: 'Mi√©rcoles' },
      { value: 'thursday', text: 'Jueves' },
      { value: 'friday', text: 'Viernes' },
      { value: 'saturday', text: 'S√°bado' },
      { value: 'sunday', text: 'Domingo' }
    ];

    daysOfWeek.forEach(day => {
      const option = document.createElement('option');
      option.value = day.value;
      option.textContent = day.text;
      if (currentValue === day.value) {
        option.selected = true;
      }
      daySelect.appendChild(option);
    });

    // Si no hay valor seleccionado, seleccionar lunes por defecto
    if (!currentValue || !['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].includes(currentValue)) {
      daySelect.value = 'monday';
    }
  } else {
    // Para mensual/trimestral/semestral/anual: d√≠as del mes (1-31)
    daySelect.disabled = false;
    for (let i = 1; i <= 31; i++) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = 'D√≠a ' + i;
      if (currentValue === i.toString()) {
        option.selected = true;
      }
      daySelect.appendChild(option);
    }

    // Si no hay valor seleccionado, seleccionar d√≠a 1 por defecto
    if (!currentValue || isNaN(parseInt(currentValue))) {
      daySelect.value = '1';
    }
  }
}

// Inicializar selectores de d√≠a al cargar la p√°gina
function initializeDaySelectors() {
  {% for task_type in task_types %}
  updateDayOptions({{ task_type.id }}, '{{ task_type.alert.alert_frequency }}');
  // Restaurar el valor guardado
  const daySelect{{ task_type.id }} = document.getElementById('alert-day-{{ task_type.id }}');
  if (daySelect{{ task_type.id }} && !daySelect{{ task_type.id }}.disabled) {
    daySelect{{ task_type.id }}.value = initialAlertDays[{{ task_type.id }}] || daySelect{{ task_type.id }}.value;
  }
  {% endfor %}
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', initializeDaySelectors);

document.getElementById('form-alerts').addEventListener('submit', function(e) {
  e.preventDefault();

  const alertsData = [];
  const rows = document.querySelectorAll('#form-alerts tbody tr');

  rows.forEach(row => {
    const taskTypeId = row.dataset.taskTypeId;
    const frequency = row.querySelector('.alert-frequency').value;
    const daySelect = document.getElementById('alert-day-' + taskTypeId);
    const day = daySelect.disabled ? null : daySelect.value;
    const enabled = row.querySelector('.alert-enabled').checked;

    alertsData.push({
      task_type_id: parseInt(taskTypeId),
      alert_frequency: frequency,
      alert_day: day,
      enabled: enabled
    });
  });

  fetch('{{ url_for("config.save_alert_settings") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(alertsData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar la configuraci√≥n');
  });
});

// ============================================================
// NOTIFICACIONES
// ============================================================
document.getElementById('form-notifications').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append('email', document.getElementById('email').value);
  formData.append('enable_email', document.getElementById('enable_email').checked);
  formData.append('enable_desktop', document.getElementById('enable_desktop').checked);
  formData.append('enable_in_app', document.getElementById('enable_in_app').checked);

  fetch('{{ url_for("config.save_notification_preferences") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);

      // Si se habilit√≥ notificaciones de escritorio, pedir permiso
      if (document.getElementById('enable_desktop').checked) {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar las preferencias');
  });
});

// ============================================================
// CRUD DE URLs
// ============================================================

// A√±adir nueva URL
document.getElementById('form-add-url').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch('{{ url_for("config.add_url") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload(); // Recargar para mostrar la nueva URL
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al a√±adir la URL');
  });
});

// Editar URL
function editUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);

  // Ocultar spans y mostrar inputs
  row.querySelector('.url-name').style.display = 'none';
  row.querySelector('.url-name-edit').style.display = 'block';
  row.querySelector('.url-url').style.display = 'none';
  row.querySelector('.url-url-edit').style.display = 'block';

  // Ocultar botones normales y mostrar botones de guardar/cancelar
  row.querySelector('.btn-edit').style.display = 'none';
  row.querySelector('.btn-toggle').style.display = 'none';
  row.querySelector('.btn-delete').style.display = 'none';
  row.querySelector('.btn-save').style.display = 'inline-block';
  row.querySelector('.btn-cancel').style.display = 'inline-block';
}

// Guardar edici√≥n
function saveUrl(urlId) {
  const row = document.querySelector(`tr[data-url-id="${urlId}"]`);
  const name = row.querySelector('.url-name-edit').value;
  const url = row.querySelector('.url-url-edit').value;

  const formData = new FormData();
  formData.append('name', name);
  formData.append('url', url);

  fetch(`/configuracion/url/edit/${urlId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar los cambios');
  });
}

// Cancelar edici√≥n
function cancelEdit(urlId) {
  location.reload();
}

// Activar/Desactivar URL
function toggleUrl(urlId) {
  if (!confirm('¬øSeguro que quieres cambiar el estado de esta URL?')) {
    return;
  }

  fetch(`/configuracion/url/toggle/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al cambiar el estado');
  });
}

// Eliminar URL
function deleteUrl(urlId) {
  if (!confirm('¬øSeguro que quieres eliminar esta URL? Esta acci√≥n no se puede deshacer.')) {
    return;
  }

  fetch(`/configuracion/url/delete/${urlId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al eliminar la URL');
  });
}

// Ejecutar Check de Calidad de Im√°genes
function runQualityCheck(sectionId) {
  if (!confirm('¬øEjecutar check de calidad de im√°genes para esta URL?\n\nEsto puede tardar unos segundos.')) {
    return;
  }

  // Deshabilitar bot√≥n temporalmente
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥';

  fetch(`/crawler/quality/check/${sectionId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ Check completado!\n\nEstado: ${data.status}\nPuntuaci√≥n: ${data.score}/100\nProblemas encontrados: ${data.issues_found}`);
    } else {
      alert('‚ùå Error: ' + data.error);
    }
    // Re-habilitar bot√≥n
    btn.disabled = false;
    btn.textContent = 'üñºÔ∏è';
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al ejecutar el check de calidad');
    btn.disabled = false;
    btn.textContent = 'üñºÔ∏è';
  });
}

// ============================================================
// BATCH QUALITY CHECK FUNCTIONS
// ============================================================

function toggleSelectAll() {
  const selectAllCheckbox = document.getElementById('select-all-urls');
  const checkboxes = document.querySelectorAll('.url-checkbox');

  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAllCheckbox.checked;
  });

  updateSelectedCount();
}

function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('.url-checkbox:checked');
  const count = checkboxes.length;
  const countSpan = document.getElementById('selected-count');
  const batchBtn = document.getElementById('batch-check-btn');

  countSpan.textContent = `${count} URL${count !== 1 ? 's' : ''} seleccionada${count !== 1 ? 's' : ''}`;
  batchBtn.disabled = count === 0;
}

function runBatchQualityCheck() {
  const checkboxes = document.querySelectorAll('.url-checkbox:checked');
  const sectionIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.sectionId));

  if (sectionIds.length === 0) {
    alert('Por favor selecciona al menos una URL');
    return;
  }

  if (!confirm(`¬øEjecutar check de calidad de im√°genes en ${sectionIds.length} URL${sectionIds.length !== 1 ? 's' : ''}?\n\nEsto puede tardar varios minutos.`)) {
    return;
  }

  // Deshabilitar bot√≥n y mostrar progreso
  const batchBtn = document.getElementById('batch-check-btn');
  const originalHTML = batchBtn.innerHTML;
  batchBtn.disabled = true;
  batchBtn.innerHTML = '<span>‚è≥</span><span>Procesando...</span>';

  // Iniciar batch
  fetch('/crawler/quality/batch', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ section_ids: sectionIds })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const batchId = data.batch_id;

      // Mostrar resumen
      alert(`‚úÖ Batch completado!\n\nTotal: ${data.total}\nProcesadas: ${data.processed}\nExitosas: ${data.successful}\nFallidas: ${data.failed}`);

      // Desmarcar checkboxes
      document.querySelectorAll('.url-checkbox:checked').forEach(cb => cb.checked = false);
      document.getElementById('select-all-urls').checked = false;
      updateSelectedCount();
    } else {
      alert('‚ùå Error: ' + data.error);
    }

    // Re-habilitar bot√≥n
    batchBtn.disabled = false;
    batchBtn.innerHTML = originalHTML;
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al ejecutar el batch de checks');
    batchBtn.disabled = false;
    batchBtn.innerHTML = originalHTML;
  });
}

// ============================================================
// QUALITY CHECKS CONFIGURATION
// ============================================================

// Load quality checks configuration on page load
document.addEventListener('DOMContentLoaded', function() {
  loadQualityChecksConfig();
});

function loadQualityChecksConfig() {
  fetch('/crawler/config/checks')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        renderQualityChecksConfig(data.checks);
      } else {
        document.getElementById('quality-checks-config').innerHTML =
          '<div style="color: var(--danger); padding: 20px; text-align: center;">‚ùå Error al cargar configuraci√≥n</div>';
      }
    })
    .catch(error => {
      console.error('Error loading quality checks config:', error);
      document.getElementById('quality-checks-config').innerHTML =
        '<div style="color: var(--danger); padding: 20px; text-align: center;">‚ùå Error al cargar configuraci√≥n</div>';
    });
}

function renderQualityChecksConfig(checks) {
  const container = document.getElementById('quality-checks-config');

  if (!checks || checks.length === 0) {
    container.innerHTML = '<div style="color: var(--muted); padding: 20px; text-align: center;">No hay checks disponibles</div>';
    return;
  }

  let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';

  checks.forEach(check => {
    const unavailableClass = !check.available ? ' style="opacity: 0.5;"' : '';
    const disabledAttr = !check.available ? ' disabled' : '';

    html += `
      <div class="notification-option"${unavailableClass}>
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-size: 20px;">${check.icon}</span>
              <span style="font-weight: 600; color: var(--text);">${check.name}</span>
              ${!check.available ? '<span style="font-size: 0.85em; color: var(--warning); background: rgba(245, 158, 11, 0.1); padding: 2px 8px; border-radius: 4px;">Pr√≥ximamente</span>' : ''}
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-bottom: 12px;">
              ${check.description}
            </div>

            <!-- Auto-run checkbox -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; opacity: ${check.enabled ? '1' : '0.5'}; margin-bottom: 12px;">
              <input
                type="checkbox"
                class="check-auto-run"
                data-check-type="${check.check_type}"
                ${check.run_after_crawl ? 'checked' : ''}
                ${!check.enabled || !check.available ? 'disabled' : ''}
                style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 0.9em; color: var(--text);">Ejecutar autom√°ticamente despu√©s de cada crawl</span>
            </label>

            <!-- Scope radio buttons -->
            <div class="check-scope-selector" data-check-type="${check.check_type}" style="display: flex; gap: 16px; padding-left: 26px; opacity: ${check.enabled ? '1' : '0.5'};">
              <label style="display: flex; align-items: center; gap: 6px; cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; font-size: 0.9em;">
                <input
                  type="radio"
                  name="scope_${check.check_type}"
                  value="priority"
                  class="check-scope"
                  data-check-type="${check.check_type}"
                  ${check.scope === 'priority' ? 'checked' : ''}
                  ${!check.enabled || !check.available ? 'disabled' : ''}
                  style="width: 16px; height: 16px; cursor: pointer;">
                <span style="color: var(--text);">Solo URLs Priority (117)</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: ${check.enabled ? 'pointer' : 'not-allowed'}; font-size: 0.9em;">
                <input
                  type="radio"
                  name="scope_${check.check_type}"
                  value="all"
                  class="check-scope"
                  data-check-type="${check.check_type}"
                  ${check.scope === 'all' ? 'checked' : ''}
                  ${!check.enabled || !check.available ? 'disabled' : ''}
                  style="width: 16px; height: 16px; cursor: pointer;">
                <span style="color: var(--text);">Todas las URLs (~2,800)</span>
              </label>
            </div>
          </div>
          <label class="toggle-switch">
            <input
              type="checkbox"
              class="check-enabled"
              data-check-type="${check.check_type}"
              ${check.enabled ? 'checked' : ''}
              ${disabledAttr}
              onchange="toggleCheckEnabled('${check.check_type}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    `;
  });

  html += '</div>';
  container.innerHTML = html;

  // Show save button
  document.getElementById('save-checks-config').style.display = 'inline-block';
}

function toggleCheckEnabled(checkType, enabled) {
  // Enable/disable auto-run checkbox based on toggle state
  const autoRunCheckbox = document.querySelector(`.check-auto-run[data-check-type="${checkType}"]`);
  if (autoRunCheckbox) {
    if (enabled) {
      // Enable the auto-run checkbox
      autoRunCheckbox.disabled = false;
      autoRunCheckbox.parentElement.style.opacity = '1';
      autoRunCheckbox.parentElement.style.cursor = 'pointer';
    } else {
      // Disable and uncheck auto-run checkbox
      autoRunCheckbox.disabled = true;
      autoRunCheckbox.checked = false;
      autoRunCheckbox.parentElement.style.opacity = '0.5';
      autoRunCheckbox.parentElement.style.cursor = 'not-allowed';
    }
  }

  // Enable/disable scope radio buttons
  const scopeSelector = document.querySelector(`.check-scope-selector[data-check-type="${checkType}"]`);
  const scopeRadios = document.querySelectorAll(`.check-scope[data-check-type="${checkType}"]`);

  if (scopeSelector && scopeRadios.length > 0) {
    if (enabled) {
      // Enable scope selection
      scopeSelector.style.opacity = '1';
      scopeRadios.forEach(radio => {
        radio.disabled = false;
        radio.parentElement.style.cursor = 'pointer';
      });
    } else {
      // Disable scope selection
      scopeSelector.style.opacity = '0.5';
      scopeRadios.forEach(radio => {
        radio.disabled = true;
        radio.parentElement.style.cursor = 'not-allowed';
      });
    }
  }
}

function saveQualityChecksConfig() {
  const button = document.getElementById('save-checks-config');
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'üíæ Guardando...';

  // Collect all check configurations
  const enabledCheckboxes = document.querySelectorAll('.check-enabled');
  const autoRunCheckboxes = document.querySelectorAll('.check-auto-run');
  const scopeRadios = document.querySelectorAll('.check-scope:checked');

  const configs = [];
  enabledCheckboxes.forEach((checkbox, index) => {
    const checkType = checkbox.dataset.checkType;
    const enabled = checkbox.checked;
    const autoRunCheckbox = Array.from(autoRunCheckboxes).find(cb => cb.dataset.checkType === checkType);
    const runAfterCrawl = autoRunCheckbox ? autoRunCheckbox.checked : false;

    // Get scope for this check type
    const scopeRadio = Array.from(scopeRadios).find(r => r.dataset.checkType === checkType);
    const scope = scopeRadio ? scopeRadio.value : 'priority';

    configs.push({
      check_type: checkType,
      enabled: enabled,
      run_after_crawl: runAfterCrawl,
      scope: scope
    });
  });

  // Save each config
  let savePromises = configs.map(config =>
    fetch('/crawler/config/checks', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(config)
    })
  );

  Promise.all(savePromises)
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(results => {
      const allSuccess = results.every(r => r.success);

      if (allSuccess) {
        alert('‚úÖ Configuraci√≥n guardada correctamente');
      } else {
        alert('‚ö†Ô∏è Hubo algunos errores al guardar la configuraci√≥n');
      }

      button.disabled = false;
      button.textContent = originalText;
    })
    .catch(error => {
      console.error('Error saving config:', error);
      alert('‚ùå Error al guardar la configuraci√≥n');
      button.disabled = false;
      button.textContent = originalText;
    });
}
</script>

<style>
/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--muted);
  transition: 0.3s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: var(--bg);
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

.notification-option {
  padding: 16px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--card);
  transition: all 0.2s ease;
}

.notification-option:hover {
  border-color: var(--primary);
  background: rgba(193, 83, 99, 0.05);
}
</style>
{% endblock %}

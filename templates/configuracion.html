{% extends "base.html" %}

{% block title %}Alertas de Tareas - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">Alertas de Tareas</div>

<!-- Guía rápida con glassmorphism -->
<div class="card card-glass" style="margin-bottom: var(--space-xl); background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(56, 189, 248, 0.15) 100%); border: 1px solid rgba(14, 165, 233, 0.3); display: flex; gap: var(--space-lg); align-items: center;">
  <div style="font-size: 40px; line-height: 1; display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; background: rgba(14, 165, 233, 0.2); border-radius: var(--radius-full);">
    <i data-lucide="compass" class="icon-2xl" style="color: #0ea5e9;"></i>
  </div>
  <div style="flex: 1;">
    <div style="font-weight: var(--font-bold); font-size: var(--text-xl); margin-bottom: var(--space-sm); color: var(--text);">Guía rápida</div>
    <ul style="margin: 0; padding-left: 20px; font-size: var(--text-sm); line-height: var(--leading-relaxed); color: var(--text); list-style: none;">
      <li style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="check" class="icon-sm icon-primary" style="margin-top: 2px;"></i>
        <span>Elige cada cuánto quieres que te avisemos por tipo de tarea</span>
      </li>
      <li style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="check" class="icon-sm icon-primary" style="margin-top: 2px;"></i>
        <span>Si es semanal/quincenal, selecciona el día; si es mensual, el día del mes</span>
      </li>
      <li style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-xs);">
        <i data-lucide="check" class="icon-sm icon-primary" style="margin-top: 2px;"></i>
        <span>Activa "Correo electrónico" y añade tu email para recibir los avisos</span>
      </li>
      <li style="display: flex; gap: var(--space-xs);">
        <i data-lucide="check" class="icon-sm icon-primary" style="margin-top: 2px;"></i>
        <span>Cuando hayas configurado, visita <strong>Alertas</strong> para marcar como hechas</span>
      </li>
    </ul>
  </div>
  <div style="display: flex; flex-direction: column; gap: var(--space-sm); min-width: 180px;">
    <a class="btn ghost" href="{{ url_for('alertas') }}" style="background: rgba(14, 165, 233, 0.2); border: 1px solid rgba(14, 165, 233, 0.4); color: #0ea5e9; font-weight: var(--font-semibold); display: flex; align-items: center; gap: var(--space-xs); justify-content: center;">
      <i data-lucide="bell" class="icon-sm"></i>
      Ver alertas
    </a>
    <a class="btn ghost" href="{{ url_for('inicio') }}" style="background: rgba(14, 165, 233, 0.2); border: 1px solid rgba(14, 165, 233, 0.4); color: #0ea5e9; font-weight: var(--font-semibold); display: flex; align-items: center; gap: var(--space-xs); justify-content: center;">
      <i data-lucide="clipboard-list" class="icon-sm"></i>
      Ir a tareas
    </a>
  </div>
</div>

<!-- ============================================================
     SECCIÓN 1: ALERTAS DE TAREAS
     ============================================================ -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <div class="card-header">
    <div>
      <h2 class="card-title" style="display: flex; align-items: center; gap: var(--space-sm);">
        <i data-lucide="bell-ring" class="icon-lg icon-primary"></i>
        Alertas de Tareas
      </h2>
      <p class="card-subtitle">
        Configura la frecuencia de las alertas para cada tipo de tarea
      </p>
    </div>
  </div>

  <!-- Nota informativa -->
  <div style="margin-bottom: var(--space-lg); padding: var(--space-md); background: rgba(193, 83, 99, 0.08); border-left: 3px solid var(--primary); border-radius: var(--radius-md);">
    <div style="display: flex; gap: var(--space-sm); align-items: flex-start;">
      <i data-lucide="lightbulb" class="icon-md icon-primary" style="margin-top: 2px; flex-shrink: 0;"></i>
      <div>
        <strong style="color: var(--primary); font-size: var(--text-sm);">Nota sobre días del mes:</strong>
        <p style="margin: var(--space-xs) 0 0 0; font-size: var(--text-sm); color: var(--muted); line-height: var(--leading-relaxed);">
          Si configuras una alerta para el día 29, 30 o 31 y el mes no tiene esos días, la alerta se generará el último día disponible del mes.
        </p>
      </div>
    </div>
  </div>

  <form id="form-alerts">
    <!-- Grid de tarjetas de alertas (3 columnas) -->
    <div style="display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: var(--space-md); margin-bottom: var(--space-lg);">
      {% for task_type in task_types %}
      <div class="card card-sm card-status {% if task_type.alert.enabled %}status-success{% else %}status-muted{% endif %}" data-task-type-id="{{ task_type.id }}" style="transition: var(--transition); grid-column: auto !important;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-md);">
          <div style="flex: 1;">
            <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); margin: 0 0 var(--space-xs) 0; color: var(--text);">
              {{ task_type.display_name }}
            </h3>
            <div style="display: flex; align-items: center; gap: var(--space-xs);">
              <span class="badge badge-muted badge-sm">
                <i data-lucide="calendar" class="icon-xs"></i>
                {{ task_type.periodicity }}
              </span>
            </div>
          </div>
          <label class="toggle-switch" title="Activar/Desactivar">
            <input
              type="checkbox"
              class="alert-enabled"
              data-task-type-id="{{ task_type.id }}"
              {% if task_type.alert.enabled %}checked{% endif %}>
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
          <!-- Frecuencia -->
          <div>
            <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
              Frecuencia de Alerta
            </label>
            <select
              class="select alert-frequency"
              style="width: 100%;"
              data-task-type-id="{{ task_type.id }}"
              onchange="updateDayOptions({{ task_type.id }}, this.value)">
              <option value="daily" {% if task_type.alert.alert_frequency == 'daily' %}selected{% endif %}>Diario</option>
              <option value="weekly" {% if task_type.alert.alert_frequency == 'weekly' %}selected{% endif %}>Semanal</option>
              <option value="biweekly" {% if task_type.alert.alert_frequency == 'biweekly' %}selected{% endif %}>Quincenal</option>
              <option value="monthly" {% if task_type.alert.alert_frequency == 'monthly' %}selected{% endif %}>Mensual</option>
              <option value="quarterly" {% if task_type.alert.alert_frequency == 'quarterly' %}selected{% endif %}>Trimestral</option>
              <option value="semiannual" {% if task_type.alert.alert_frequency == 'semiannual' %}selected{% endif %}>Semestral</option>
              <option value="annual" {% if task_type.alert.alert_frequency == 'annual' %}selected{% endif %}>Anual</option>
            </select>
          </div>

          <!-- Día de aviso -->
          <div>
            <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
              Día de Aviso
            </label>
            {% set freq = task_type.alert.alert_frequency %}
            {% set current_day = task_type.alert.alert_day or '1' %}
            <select
              class="select alert-day"
              style="width: 100%;"
              data-task-type-id="{{ task_type.id }}"
              id="alert-day-{{ task_type.id }}"
              {% if freq == 'daily' %}disabled{% endif %}>
              {% if freq == 'weekly' or freq == 'biweekly' %}
                {% set days = [
                  ('monday', 'Lunes'),
                  ('tuesday', 'Martes'),
                  ('wednesday', 'Miércoles'),
                  ('thursday', 'Jueves'),
                  ('friday', 'Viernes'),
                  ('saturday', 'Sábado'),
                  ('sunday', 'Domingo')
                ] %}
                {% for value, label in days %}
                  <option value="{{ value }}" {% if current_day == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              {% else %}
                {% for i in range(1, 32) %}
                  <option value="{{ i }}" {% if current_day|string == i|string %}selected{% endif %}>Día {{ i }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div style="text-align: center;">
      <button type="submit" class="btn primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
        <i data-lucide="save" class="icon-sm"></i>
        Guardar Configuración de Alertas
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCIÓN 2: TIPO DE NOTIFICACIONES
     ============================================================ -->
<div class="card" style="margin-bottom: var(--space-xl);">
  <div class="card-header">
    <div>
      <h2 class="card-title" style="display: flex; align-items: center; gap: var(--space-sm);">
        <i data-lucide="bell" class="icon-lg icon-primary"></i>
        Tipo de Notificaciones
      </h2>
      <p class="card-subtitle">
        Elige cómo quieres recibir las notificaciones cuando haya alertas pendientes
      </p>
    </div>
  </div>

  <form id="form-notifications">
    <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-lg);">
      <!-- Notificación en App -->
      <div class="card card-sm card-interactive" style="cursor: default; flex: 1;">
        <label style="display: flex; align-items: flex-start; gap: var(--space-sm); cursor: pointer;">
          <input
            type="checkbox"
            name="enable_in_app"
            id="enable_in_app"
            {% if notification_prefs.enable_in_app %}checked{% endif %}
            style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
              <i data-lucide="smartphone" class="icon-sm icon-primary"></i>
              <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">
                Notificación en la aplicación
              </span>
            </div>
            <p style="color: var(--muted); font-size: var(--text-xs); margin: 0; line-height: var(--leading-relaxed);">
              Verás un contador de notificaciones en la barra superior
            </p>
          </div>
        </label>
      </div>

      <div style="width: 2px; background: var(--border); flex-shrink: 0;"></div>

      <!-- Notificación de Escritorio -->
      <div class="card card-sm card-interactive" style="cursor: default; flex: 1;">
        <label style="display: flex; align-items: flex-start; gap: var(--space-sm); cursor: pointer;">
          <input
            type="checkbox"
            name="enable_desktop"
            id="enable_desktop"
            {% if notification_prefs.enable_desktop %}checked{% endif %}
            style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
              <i data-lucide="monitor" class="icon-sm icon-primary"></i>
              <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">
                Notificación de escritorio
              </span>
            </div>
            <p style="color: var(--muted); font-size: var(--text-xs); margin: 0; line-height: var(--leading-relaxed);">
              Recibirás notificaciones del sistema operativo
            </p>
          </div>
        </label>
      </div>

      <div style="width: 2px; background: var(--border); flex-shrink: 0;"></div>

      <!-- Correo Electrónico -->
      <div class="card card-sm card-interactive" style="cursor: default; flex: 1;">
        <label style="display: flex; align-items: flex-start; gap: var(--space-sm); cursor: pointer;">
          <input
            type="checkbox"
            name="enable_email"
            id="enable_email"
            {% if notification_prefs.enable_email %}checked{% endif %}
            style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs);">
              <i data-lucide="mail" class="icon-sm icon-primary"></i>
              <span style="font-weight: var(--font-semibold); color: var(--text); font-size: var(--text-sm);">
                Correo electrónico
              </span>
            </div>
            <p style="color: var(--muted); font-size: var(--text-xs); margin: 0 0 var(--space-sm) 0; line-height: var(--leading-relaxed);">
              Recibirás emails con las alertas pendientes
            </p>
            <input
              type="email"
              name="email"
              id="email"
              class="input"
              placeholder="tu@email.com"
              value="{{ notification_prefs.email or '' }}"
              style="width: 100%; font-size: var(--text-sm);">
          </div>
        </label>
      </div>
    </div>

    <div style="text-align: center;">
      <button type="submit" class="btn primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
        <i data-lucide="save" class="icon-sm"></i>
        Guardar Preferencias de Notificación
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCIÓN 3: ALERTAS PERSONALIZADAS (RECURRENTES)
     ============================================================ -->
<div class="card">
  <div class="card-header">
    <div>
      <h2 class="card-title" style="display: flex; align-items: center; gap: var(--space-sm);">
        <i data-lucide="puzzle" class="icon-lg icon-primary"></i>
        Alertas Personalizadas
      </h2>
      <p class="card-subtitle">
        Define avisos recurrentes con su propia frecuencia
      </p>
    </div>
  </div>

  <!-- Formulario de creación -->
  <form id="form-custom-alert" style="margin-bottom: var(--space-xl);">
    <div style="display: grid; gap: var(--space-md); grid-template-columns: 2fr 1fr 1fr 2fr;">
      <div>
        <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
          Título *
        </label>
        <input type="text" name="title" id="custom-title" class="input" placeholder="Ej: Revisar campaña especial" required />
      </div>
      <div>
        <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
          Frecuencia *
        </label>
        <select name="alert_frequency" id="custom-frequency" class="select">
          <option value="daily">Diaria</option>
          <option value="weekly">Semanal</option>
          <option value="biweekly">Quincenal</option>
          <option value="monthly" selected>Mensual</option>
          <option value="quarterly">Trimestral</option>
          <option value="semiannual">Semestral</option>
          <option value="annual">Anual</option>
        </select>
      </div>
      <div>
        <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
          Día de aviso *
        </label>
        {% set default_day_options = [] %}
        <select name="alert_day" id="custom-day" class="select">
          {% for i in range(1, 32) %}
            <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>Día {{ i }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label style="font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: var(--space-xs);">
          Notas (opcional)
        </label>
        <textarea name="notes" id="custom-notes" class="textarea" rows="2" placeholder="Detalles de lo que hay que revisar" style="resize: vertical;"></textarea>
      </div>
      <div style="grid-column: 1 / -1; text-align: center; margin-top: var(--space-sm);">
        <button type="submit" class="btn primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
          <i data-lucide="plus" class="icon-sm"></i>
          Crear alerta personalizada
        </button>
      </div>
    </div>
  </form>

  <!-- Lista de alertas personalizadas existentes -->
  {% if custom_alert_rules %}
    <div style="border-top: 1px solid var(--border); padding-top: var(--space-lg);">
      <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin: 0 0 var(--space-md) 0; color: var(--text);">
        Alertas Activas
      </h3>
      <div style="display: flex; flex-direction: column; gap: var(--space-sm);" id="custom-alerts-table">
        {% for r in custom_alert_rules %}
          <div class="card card-sm card-status {% if r.enabled %}status-success{% else %}status-muted{% endif %}" data-custom-rule-id="{{ r.id }}" style="transition: var(--transition);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-md);">
              <div style="flex: 1; min-width: 0;">
                <h4 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin: 0 0 var(--space-xs) 0; color: var(--text);">
                  {{ r.title }}
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-xs);">
                  <span class="badge badge-primary badge-sm">
                    <i data-lucide="repeat" class="icon-xs"></i>
                    {{ r.alert_frequency }}
                  </span>
                  {% if r.alert_day %}
                  <span class="badge badge-muted badge-sm">
                    <i data-lucide="calendar-days" class="icon-xs"></i>
                    Día {{ r.alert_day }}
                  </span>
                  {% endif %}
                </div>
                {% if r.notes %}
                <p style="font-size: var(--text-sm); color: var(--muted); margin: 0; line-height: var(--leading-relaxed);">
                  {{ r.notes }}
                </p>
                {% endif %}
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-sm); flex-shrink: 0;">
                <label class="toggle-switch" title="Activar/Desactivar">
                  <input type="checkbox" class="js-toggle-custom-rule" data-rule-id="{{ r.id }}" {% if r.enabled %}checked{% endif %}>
                  <span class="toggle-slider"></span>
                </label>
                <button type="button" class="icon-btn js-delete-custom-rule" data-rule-id="{{ r.id }}" title="Eliminar" style="color: var(--danger);">
                  <i data-lucide="trash-2" class="icon-sm"></i>
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// ALERTAS DE TAREAS
// ============================================================

// Datos iniciales de alert_day desde el backend
const initialAlertDays = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_day or "1" }}',
  {% endfor %}
};

// Datos iniciales de alert_frequency desde el backend
const initialAlertFrequencies = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_frequency }}',
  {% endfor %}
};

// Función para actualizar opciones del selector de día según frecuencia
function updateDayOptions(taskTypeId, frequency) {
  const daySelect = document.getElementById('alert-day-' + taskTypeId);
  if (!daySelect) return;

  // habilitar por defecto; se deshabilita solo en diario
  daySelect.disabled = false;

  const currentValue = daySelect.value || initialAlertDays[taskTypeId] || '';

  // Limpiar opciones actuales
  daySelect.innerHTML = '';

  if (frequency === 'daily') {
    daySelect.disabled = true;
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Todos los días';
    daySelect.appendChild(option);
  } else if (frequency === 'weekly' || frequency === 'biweekly') {
    const daysOfWeek = [
      { value: 'monday', text: 'Lunes' },
      { value: 'tuesday', text: 'Martes' },
      { value: 'wednesday', text: 'Miércoles' },
      { value: 'thursday', text: 'Jueves' },
      { value: 'friday', text: 'Viernes' },
      { value: 'saturday', text: 'Sábado' },
      { value: 'sunday', text: 'Domingo' }
    ];

    daysOfWeek.forEach(day => {
      const option = document.createElement('option');
      option.value = day.value;
      option.textContent = day.text;
      daySelect.appendChild(option);
    });

    // Restaurar valor o elegir lunes por defecto
    if (['monday','tuesday','wednesday','thursday','friday','saturday','sunday'].includes(currentValue)) {
      daySelect.value = currentValue;
    } else {
      daySelect.value = 'monday';
    }
  } else {
    // Para mensual/trimestral/semestral/anual: días del mes (1-31)
    for (let i = 1; i <= 31; i++) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = 'Día ' + i;
      daySelect.appendChild(option);
    }

    // Restaurar valor o elegir día 1 por defecto
    if (!isNaN(parseInt(currentValue))) {
      daySelect.value = currentValue;
    } else {
      daySelect.value = '1';
    }
  }
}

// Inicializar selectores de día al cargar la página
function initializeDaySelectors() {
  {% for task_type in task_types %}
  updateDayOptions({{ task_type.id }}, '{{ task_type.alert.alert_frequency }}');
  {% endfor %}
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', initializeDaySelectors);
// Llamada inmediata por si el evento ya se disparó antes de ejecutar este script
initializeDaySelectors();

const formAlerts = document.getElementById('form-alerts');
if (formAlerts) {
  formAlerts.addEventListener('submit', function(e) {
    e.preventDefault();

    const alertsData = [];
    const rows = document.querySelectorAll('#form-alerts tbody tr');

  rows.forEach(row => {
    const taskTypeId = row.dataset.taskTypeId;
    const frequency = row.querySelector('.alert-frequency').value;
    const daySelect = document.getElementById('alert-day-' + taskTypeId);
    const day = daySelect.disabled ? null : daySelect.value;
    const enabled = row.querySelector('.alert-enabled').checked;

    alertsData.push({
      task_type_id: parseInt(taskTypeId),
      alert_frequency: frequency,
      alert_day: day,
      enabled: enabled
    });
  });

  fetch('{{ url_for("config.save_alert_settings") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(alertsData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ ' + data.message);
    } else {
      alert('❌ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ Error al guardar la configuración');
  });
  });
}

// ============================================================
// NOTIFICACIONES
// ============================================================
const formNotifications = document.getElementById('form-notifications');
if (formNotifications) {
  formNotifications.addEventListener('submit', function(e) {
    e.preventDefault();

  const formData = new FormData();
  formData.append('email', document.getElementById('email').value);
  formData.append('enable_email', document.getElementById('enable_email').checked);
  formData.append('enable_desktop', document.getElementById('enable_desktop').checked);
  formData.append('enable_in_app', document.getElementById('enable_in_app').checked);

  fetch('{{ url_for("config.save_notification_preferences") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ ' + data.message);

      // Si se habilitó notificaciones de escritorio, pedir permiso
      if (document.getElementById('enable_desktop').checked) {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }
    } else {
      alert('❌ Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ Error al guardar las preferencias');
  });
  });
}

// ============================================================
// ALERTAS PERSONALIZADAS (REGLAS)
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
  const customForm = document.getElementById('form-custom-alert');
  if (customForm) {
    customForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(customForm);

      fetch('{{ url_for("config.add_custom_alert_rule") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✅ ' + data.message);
          window.location.reload();
        } else {
          alert('❌ Error: ' + (data.error || 'No se pudo crear la alerta'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al crear la alerta');
      });
    });
  }
});

// Rellenar día para regla personalizada
function updateCustomDayOptions(frequency) {
  const daySelect = document.getElementById('custom-day');
  if (!daySelect) return;
  daySelect.disabled = false;
  const current = daySelect.value;
  daySelect.innerHTML = '';

  if (frequency === 'daily') {
    daySelect.disabled = true;
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Todos los días';
    daySelect.appendChild(opt);
  } else if (frequency === 'weekly' || frequency === 'biweekly') {
    const days = [
      ['monday', 'Lunes'],
      ['tuesday', 'Martes'],
      ['wednesday', 'Miércoles'],
      ['thursday', 'Jueves'],
      ['friday', 'Viernes'],
      ['saturday', 'Sábado'],
      ['sunday', 'Domingo'],
    ];
    days.forEach(([val, label]) => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = label;
      daySelect.appendChild(opt);
    });
    daySelect.value = current && days.some(d => d[0] === current) ? current : 'monday';
  } else {
    for (let i = 1; i <= 31; i++) {
      const opt = document.createElement('option');
      opt.value = i.toString();
      opt.textContent = 'Día ' + i;
      daySelect.appendChild(opt);
    }
    daySelect.value = current && !isNaN(parseInt(current)) ? current : '1';
  }
}
updateCustomDayOptions(document.getElementById('custom-frequency')?.value || 'monthly');
const customFrequencySelect = document.getElementById('custom-frequency');
if (customFrequencySelect) {
  customFrequencySelect.addEventListener('change', (event) => {
    updateCustomDayOptions(event.target.value);
  });
}

function deleteCustomRule(id) {
  showConfirmModal('¿Eliminar esta alerta personalizada y sus tareas asociadas?', () => {
    fetch(`/configuracion/alerta-personalizada/delete/${id}`, { method: 'POST' })
      .then(r => {
        if (!r.ok) throw new Error(`Error HTTP ${r.status}`);
        return r.json();
      })
      .then(data => {
        if (data.success) {
          const row = document.querySelector(`tr[data-custom-rule-id="${id}"]`);
          if (row) row.remove();
          // Recargar para limpiar contadores/listados si aplica
          window.location.reload();
        } else {
          alert('❌ Error: ' + (data.error || 'No se pudo eliminar'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('❌ Error al eliminar la regla');
      });
  });
}

function toggleCustomRule(id, checkbox) {
  fetch(`/configuracion/alerta-personalizada/toggle/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        alert('❌ Error: ' + (data.error || 'No se pudo actualizar'));
        checkbox.checked = !checkbox.checked;
      }
    })
    .catch(err => {
      console.error(err);
      alert('❌ Error de conexión');
      checkbox.checked = !checkbox.checked;
    });
}

// Bind botón papelera sin inline
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.js-delete-custom-rule').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.ruleId;
      if (id) deleteCustomRule(id);
    });
  });

  document.querySelectorAll('.js-toggle-custom-rule').forEach(cb => {
    cb.addEventListener('change', () => {
      toggleCustomRule(cb.dataset.ruleId, cb);
    });
  });
});

// Exponer funciones al scope global por compatibilidad
window.deleteCustomRule = deleteCustomRule;
window.toggleCustomRule = toggleCustomRule;
window.updateCustomDayOptions = updateCustomDayOptions;

// Modal de confirmación sencillo
function showConfirmModal(message, onConfirm) {
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.45)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';

  const modal = document.createElement('div');
  modal.style.background = 'var(--card)';
  modal.style.color = 'var(--text)';
  modal.style.padding = '18px';
  modal.style.borderRadius = '12px';
  modal.style.boxShadow = '0 12px 30px rgba(0,0,0,0.15)';
  modal.style.maxWidth = '360px';
  modal.style.width = '90%';

  modal.innerHTML = `
    <div style="font-weight:700; margin-bottom:8px;">Confirmar acción</div>
    <div style="margin-bottom:16px; color:var(--muted);">${message}</div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button type="button" class="btn ghost" id="cancel-confirm">Cancelar</button>
      <button type="button" class="btn primary" id="ok-confirm">Eliminar</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  modal.querySelector('#cancel-confirm').onclick = () => overlay.remove();
  modal.querySelector('#ok-confirm').onclick = () => {
    overlay.remove();
    if (onConfirm) onConfirm();
  };
}
</script>
{% endblock %}

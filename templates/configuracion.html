{% extends "base.html" %}

{% block title %}Alertas de Tareas - Agenda Renta4{% endblock %}

{% block content %}
<div class="h1">Alertas de Tareas</div>

<div class="panel" style="margin-bottom:16px; display:flex; gap:14px; align-items:center; background:linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); color:#fff; border-left:4px solid rgba(255,255,255,0.7);">
  <div style="font-size:34px; line-height:1">üß≠</div>
  <div style="flex:1;">
    <div style="font-weight:700; font-size:16px;">Gu√≠a r√°pida</div>
    <ul style="margin:6px 0 0 0; padding-left:18px; font-size:13px; line-height:1.5;">
      <li>Elige cada cu√°nto quieres que te avisemos por tipo de tarea.</li>
      <li>Si es semanal/quincenal, selecciona el d√≠a; si es mensual, el d√≠a del mes.</li>
      <li>Activa ‚ÄúCorreo electr√≥nico‚Äù y a√±ade tu email para recibir los avisos.</li>
      <li>Cuando hayas configurado, visita <strong>Alertas</strong> para marcar como hechas.</li>
    </ul>
  </div>
  <div style="display:flex; flex-direction:column; gap:6px; min-width:180px;">
    <a class="btn ghost" href="{{ url_for('alertas') }}" style="background:rgba(255,255,255,0.15); color:#fff;">üîî Ver alertas</a>
    <a class="btn ghost" href="{{ url_for('inicio') }}" style="background:rgba(255,255,255,0.15); color:#fff;">üìã Ir a tareas</a>
  </div>
</div>

<!-- ============================================================
     SECCI√ìN 1: ALERTAS DE TAREAS
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    ‚è∞ Alertas de Tareas
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Configura la frecuencia de las alertas para cada tipo de tarea. Las alertas te recordar√°n cu√°ndo debes revisar cada categor√≠a.
  </p>

  <div class="panel" style="margin-bottom: 16px; background: rgba(193, 83, 99, 0.1); border-left: 3px solid var(--primary); padding: 12px;">
    <strong style="color: var(--primary);">üí° Nota sobre d√≠as del mes:</strong>
    <p style="margin: 6px 0 0 0; font-size: 13px; color: var(--muted);">
      Si configuras una alerta para el d√≠a 29, 30 o 31 y el mes no tiene esos d√≠as, la alerta se generar√° el √∫ltimo d√≠a disponible del mes.
      Por ejemplo, si configuras d√≠a 31 en febrero, la alerta se generar√° el 28 (o 29 en a√±os bisiestos).
    </p>
  </div>

  <form id="form-alerts">
    <div class="table" style="margin-bottom: 16px;">
      <table>
        <thead>
          <tr>
            <th style="width: 30%">Tipo de Tarea</th>
            <th style="width: 25%">Frecuencia de Alerta</th>
            <th style="width: 25%">D√≠a de Aviso</th>
            <th style="width: 15%; text-align: center;">Activada</th>
          </tr>
        </thead>
        <tbody>
          {% for task_type in task_types %}
          <tr data-task-type-id="{{ task_type.id }}">
            <td>
              <strong>{{ task_type.display_name }}</strong>
              <div style="color: var(--muted); font-size: 0.85em; margin-top: 4px;">
                Periodicidad base: {{ task_type.periodicity }}
              </div>
            </td>
            <td>
              <select
                class="select alert-frequency"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                onchange="updateDayOptions({{ task_type.id }}, this.value)">
                <option value="daily" {% if task_type.alert.alert_frequency == 'daily' %}selected{% endif %}>Diario</option>
                <option value="weekly" {% if task_type.alert.alert_frequency == 'weekly' %}selected{% endif %}>Semanal</option>
                <option value="biweekly" {% if task_type.alert.alert_frequency == 'biweekly' %}selected{% endif %}>Quincenal</option>
                <option value="monthly" {% if task_type.alert.alert_frequency == 'monthly' %}selected{% endif %}>Mensual</option>
                <option value="quarterly" {% if task_type.alert.alert_frequency == 'quarterly' %}selected{% endif %}>Trimestral</option>
                <option value="semiannual" {% if task_type.alert.alert_frequency == 'semiannual' %}selected{% endif %}>Semestral</option>
                <option value="annual" {% if task_type.alert.alert_frequency == 'annual' %}selected{% endif %}>Anual</option>
              </select>
            </td>
            <td>
              {% set freq = task_type.alert.alert_frequency %}
              {% set current_day = task_type.alert.alert_day or '1' %}
              <select
                class="select alert-day"
                style="width: 100%; font-size: 14px;"
                data-task-type-id="{{ task_type.id }}"
                id="alert-day-{{ task_type.id }}"
                {% if freq == 'daily' %}disabled{% endif %}>
                {% if freq == 'weekly' or freq == 'biweekly' %}
                  {% set days = [
                    ('monday', 'Lunes'),
                    ('tuesday', 'Martes'),
                    ('wednesday', 'Mi√©rcoles'),
                    ('thursday', 'Jueves'),
                    ('friday', 'Viernes'),
                    ('saturday', 'S√°bado'),
                    ('sunday', 'Domingo')
                  ] %}
                  {% for value, label in days %}
                    <option value="{{ value }}" {% if current_day == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                {% else %}
                  {% for i in range(1, 32) %}
                    <option value="{{ i }}" {% if current_day|string == i|string %}selected{% endif %}>D√≠a {{ i }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </td>
            <td style="text-align: center;">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  class="alert-enabled"
                  data-task-type-id="{{ task_type.id }}"
                  {% if task_type.alert.enabled %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="text-align: right;">
      <button type="submit" class="btn primary">
        üíæ Guardar Configuraci√≥n de Alertas
      </button>
    </div>
  </form>
</div>

<!-- ============================================================
     SECCI√ìN 2: TIPO DE NOTIFICACIONES
     ============================================================ -->
<div class="panel" style="margin-bottom: 24px;">
  <h2 style="margin: 0 0 16px; font-size: 18px; color: var(--text); font-weight: 600;">
    üîî Tipo de Notificaciones
  </h2>
  <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
    Elige c√≥mo quieres recibir las notificaciones cuando haya alertas pendientes.
  </p>

  <form id="form-notifications">
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <!-- Notificaci√≥n en App -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_in_app"
            id="enable_in_app"
            {% if notification_prefs.enable_in_app %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üîî Notificaci√≥n en la aplicaci√≥n
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Ver√°s un contador de notificaciones en la barra superior de la aplicaci√≥n
            </div>
          </div>
        </label>
      </div>

      <!-- Notificaci√≥n de Escritorio -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_desktop"
            id="enable_desktop"
            {% if notification_prefs.enable_desktop %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div>
            <div style="font-weight: 600; color: var(--text);">
              üñ•Ô∏è Notificaci√≥n de escritorio
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">
              Recibir√°s notificaciones del sistema operativo (requiere permiso del navegador)
            </div>
          </div>
        </label>
      </div>

      <!-- Correo Electr√≥nico -->
      <div class="notification-option">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input
            type="checkbox"
            name="enable_email"
            id="enable_email"
            {% if notification_prefs.enable_email %}checked{% endif %}
            style="width: 18px; height: 18px; cursor: pointer;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
              ‚úâÔ∏è Correo electr√≥nico
            </div>
            <div style="color: var(--muted); font-size: 0.9em; margin-bottom: 8px;">
              Recibir√°s emails con las alertas pendientes
            </div>
            <input
              type="email"
              name="email"
              id="email"
              class="input"
              placeholder="tu@email.com"
              value="{{ notification_prefs.email or '' }}"
              style="width: 100%; max-width: 400px;">
          </div>
        </label>
      </div>
    </div>

    <div style="text-align: right; margin-top: 20px;">
      <button type="submit" class="btn primary">
        üíæ Guardar Preferencias de Notificaci√≥n
      </button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// ALERTAS DE TAREAS
// ============================================================

// Datos iniciales de alert_day desde el backend
const initialAlertDays = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_day or "1" }}',
  {% endfor %}
};

// Datos iniciales de alert_frequency desde el backend
const initialAlertFrequencies = {
  {% for task_type in task_types %}
  {{ task_type.id }}: '{{ task_type.alert.alert_frequency }}',
  {% endfor %}
};

// Funci√≥n para actualizar opciones del selector de d√≠a seg√∫n frecuencia
function updateDayOptions(taskTypeId, frequency) {
  const daySelect = document.getElementById('alert-day-' + taskTypeId);
  if (!daySelect) return;

  // habilitar por defecto; se deshabilita solo en diario
  daySelect.disabled = false;

  const currentValue = daySelect.value || initialAlertDays[taskTypeId] || '';

  // Limpiar opciones actuales
  daySelect.innerHTML = '';

  if (frequency === 'daily') {
    daySelect.disabled = true;
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Todos los d√≠as';
    daySelect.appendChild(option);
  } else if (frequency === 'weekly' || frequency === 'biweekly') {
    const daysOfWeek = [
      { value: 'monday', text: 'Lunes' },
      { value: 'tuesday', text: 'Martes' },
      { value: 'wednesday', text: 'Mi√©rcoles' },
      { value: 'thursday', text: 'Jueves' },
      { value: 'friday', text: 'Viernes' },
      { value: 'saturday', text: 'S√°bado' },
      { value: 'sunday', text: 'Domingo' }
    ];

    daysOfWeek.forEach(day => {
      const option = document.createElement('option');
      option.value = day.value;
      option.textContent = day.text;
      daySelect.appendChild(option);
    });

    // Restaurar valor o elegir lunes por defecto
    if (['monday','tuesday','wednesday','thursday','friday','saturday','sunday'].includes(currentValue)) {
      daySelect.value = currentValue;
    } else {
      daySelect.value = 'monday';
    }
  } else {
    // Para mensual/trimestral/semestral/anual: d√≠as del mes (1-31)
    for (let i = 1; i <= 31; i++) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = 'D√≠a ' + i;
      daySelect.appendChild(option);
    }

    // Restaurar valor o elegir d√≠a 1 por defecto
    if (!isNaN(parseInt(currentValue))) {
      daySelect.value = currentValue;
    } else {
      daySelect.value = '1';
    }
  }
}

// Inicializar selectores de d√≠a al cargar la p√°gina
function initializeDaySelectors() {
  {% for task_type in task_types %}
  updateDayOptions({{ task_type.id }}, '{{ task_type.alert.alert_frequency }}');
  {% endfor %}
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', initializeDaySelectors);
// Llamada inmediata por si el evento ya se dispar√≥ antes de ejecutar este script
initializeDaySelectors();

document.getElementById('form-alerts').addEventListener('submit', function(e) {
  e.preventDefault();

  const alertsData = [];
  const rows = document.querySelectorAll('#form-alerts tbody tr');

  rows.forEach(row => {
    const taskTypeId = row.dataset.taskTypeId;
    const frequency = row.querySelector('.alert-frequency').value;
    const daySelect = document.getElementById('alert-day-' + taskTypeId);
    const day = daySelect.disabled ? null : daySelect.value;
    const enabled = row.querySelector('.alert-enabled').checked;

    alertsData.push({
      task_type_id: parseInt(taskTypeId),
      alert_frequency: frequency,
      alert_day: day,
      enabled: enabled
    });
  });

  fetch('{{ url_for("config.save_alert_settings") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(alertsData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar la configuraci√≥n');
  });
});

// ============================================================
// NOTIFICACIONES
// ============================================================
document.getElementById('form-notifications').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append('email', document.getElementById('email').value);
  formData.append('enable_email', document.getElementById('enable_email').checked);
  formData.append('enable_desktop', document.getElementById('enable_desktop').checked);
  formData.append('enable_in_app', document.getElementById('enable_in_app').checked);

  fetch('{{ url_for("config.save_notification_preferences") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úÖ ' + data.message);

      // Si se habilit√≥ notificaciones de escritorio, pedir permiso
      if (document.getElementById('enable_desktop').checked) {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }
    } else {
      alert('‚ùå Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error al guardar las preferencias');
  });
});

{% endblock %}
